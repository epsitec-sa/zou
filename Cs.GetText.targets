<?xml version="1.0" encoding="utf-8"?>
<!-- Import this script at the end of the C# interop project -->
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003" DefaultTargets="GetTextBuild">

  <!-- Make sure that PoResource is available in VisualStudio's Build Action combo -->
  <ItemGroup>
    <AvailableItemName Include="PoResource" />
    <AvailableItemName Include="PoGlobalResource" />
  </ItemGroup>

  <Import Project="Cs.Boot.props"/>

  <PropertyGroup>
    <PoAnchorDir>$(BundleDir)</PoAnchorDir>
    <PoIntDir>$([System.IO.Path]::Combine($(ProjectDir),$(IntermediateOutputPath)))</PoIntDir>
    <PoTemplateSourcesPath>$(PoIntDir)potsources.txt</PoTemplateSourcesPath>
    <PoTemplatePath>$(PoIntDir)package.pot</PoTemplatePath>
    <PoLocaleDir>locale\</PoLocaleDir>
  </PropertyGroup>

  <!--=========================================================================-->
  <Target Name="SplitPoResourceByCulture">
    <!-- Extract Culture metadata -->
    <AssignCulture Files="@(PoResource);@(PoGlobalResource)">
      <Output TaskParameter="AssignedFilesWithCulture" ItemName="PoResourceWithCulture" />
      <Output TaskParameter="AssignedFilesWithNoCulture" ItemName="PoResourceWithNoCulture" />
    </AssignCulture>
    <!-- Add metadata helpers -->
    <ItemGroup>
      <PoResource Remove="@(PoResourceWithCulture)" />
      <PoResource Remove="@(PoResourceWithNoCulture)" />
      <PoResource Include="@(PoResourceWithNoCulture);@(PoResourceWithCulture)">
        <Type>PO</Type>
        <Domain>$([System.IO.Path]::GetFileNameWithoutExtension('%(PoResource.Filename)'))</Domain>
        <MoResourceDir>$(TargetDir)$(PoLocaleDir)%(PoResource.Culture)\LC_MESSAGES\</MoResourceDir>
        <MoResourceFullPath>%(PoResource.MoResourceDir)%(PoResource.Domain).mo</MoResourceFullPath>
      </PoResource>
    </ItemGroup>
  </Target>

  <!--=========================================================================-->
  <!-- Create list of .cs file for xgettext -->
  <Target Name="GetPoSources">
    <ItemGroup>
      <_Temporary Include="@(Compile)" Exclude="$(TMP)\*" />
      <PoSource  Include="$([MSBuild]::MakeRelative($(PoAnchorDir), %(_Temporary.FullPath)))" />
      <_Temporary Remove="@(_Temporary)" />
    </ItemGroup>
  </Target>
  <Target Name="GetPoReferenceSources" Condition="'@(PoGlobalResource)' != ''">
    <ItemGroup>
      <_Temporary Include="%(ProjectReference.RootDir)%(Directory)**\*.cs" Exclude="%(ProjectReference.RootDir)%(Directory)obj\**\*.cs" />
      <PoSource  Include="$([MSBuild]::MakeRelative($(PoAnchorDir), %(_Temporary.Identity)))" />
      <_Temporary Remove="@(_Temporary)" />
    </ItemGroup>
    <!--<LogItems Title="ProjectReference" Items="@(ProjectReference)" AllMetadata="true" />-->
  </Target>

  <!--=========================================================================-->
  <!-- Save the list of C# source files for xgettext -->
  <Target Name="SavePoSources"
          DependsOnTargets="GetPoSources;GetPoReferenceSources"
          Inputs="@(PoSource)"
          Outputs="$(PoTemplateSourcesPath)">
    <MakeDir Directories="$(PoIntDir)" />
    <WriteLinesToFile File="$(PoTemplateSourcesPath)" Lines="@(PoSource)" Overwrite="true" />
    <Message Importance="high" Text="%(PoSource.Identity)" />
    <!--<Exec Command='"$(PoTemplateSourcesPath)"' />-->  <!-- open in default editor -->
  </Target>
  <Target Name="SavePoSourcesClean">
    <Delete Files="$(PoTemplateSourcesPath)" />
  </Target>

  <!--=========================================================================-->
  <!-- Create or update new PO Template file -->
  <Target Name="CreatePoTemplate" DependsOnTargets="SavePoSources" Inputs="@(PoSource)" Outputs="$(PoTemplatePath)">
    <Exec Command='"$(ZouDir)gettext\xgettext" -k_ --from-code=utf-8 --no-wrap -f"$(PoTemplateSourcesPath)" -o"$(PoTemplatePath)" -D"$(PoAnchorDir)."' />
  </Target>


  <!--=========================================================================-->
  <!-- Merge new PO Template into PO Resource file -->
  <Target Name="MergePoTemplateIntoPoResource" DependsOnTargets="CreatePoTemplate" Inputs="$(PoTemplatePath)" Outputs="@(PoResource)">
    <Exec Command='"$(ZouDir)gettext\msgmerge" -U --no-wrap --lang=%(PoResource.Culture) "%(PoResource.FullPath)" "$(PoTemplatePath)"' />
  </Target>

  <!--=========================================================================-->
  <!-- Create MO Resource file from PO Resource file -->
  <!-- Use target batching -->
  <Target Name="CreateMoResource" DependsOnTargets="MergePoTemplateIntoPoResource"
          Inputs="%(PoResource.FullPath)"
          Outputs="%(PoResource.MoResourceFullPath)">
    <MakeDir Directories="%(PoResource.MoResourceDir)" />
    <Exec Command='"$(ZouDir)gettext\msgfmt" -c -v -o"%(PoResource.MoResourceFullPath)" "%(PoResource.FullPath)"' />
  </Target>

  <!--=========================================================================-->
  <!-- Import Project References MO Resources files -->
  <Target Name="GetReferencedMoResources">
    <ItemGroup>
      <LocaleReference Include="%(ProjectReference.RootDir)%(Directory)$(OutputPath)$(PoLocaleDir)**\*.mo" />
    </ItemGroup>
  </Target>

  <Target Name="ImportLocaleReference"
          DependsOnTargets="GetReferencedMoResources"
          Inputs="%(LocaleReference.Identity)"
          Outputs="$(TargetDir)$(PoLocaleDir)%(LocaleReference.RecursiveDir)%(FileName)%(Extension)">
    <Copy SourceFiles="%(LocaleReference.Identity)" DestinationFiles="$(TargetDir)$(PoLocaleDir)%(RecursiveDir)%(FileName)%(Extension)"  />
    <Message Importance="high" Text="  [+] %(LocaleReference.Identity) =&gt; $(TargetDir)$(PoLocaleDir)%(RecursiveDir)%(FileName)%(Extension)" />
  </Target>

  <!-- Set MO Resources files as content -->
  <Target Name="CreateLocaleContent"
          DependsOnTargets="GetReferencedMoResources"
          Inputs="@(LocaleReference)"
          Outputs="@(LocaleReference->'$(TargetDir)%(RecursiveDir)%(FileName)%(Extension)')">
    <Message Importance="high" Text="##### CREATELOCALECONTENT" />
    <LogItems Items="@(ProjectReference)" Title="ProjectReference" AllMetadata="true" />
    <LogItems Items="@(LocaleReference)" Title="LocaleReference" AllMetadata="true" />
    <ItemGroup>
      <Content Include="@(LocaleReference)">
        <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
        <Visible>false</Visible>
      </Content>
    </ItemGroup>
    <!--<LogItems Items="@(Content)" Title="Content" AllMetadata="true" />
    <Message Importance="high" Text="[mo] %(LocaleReference.Identity) -&gt; $(TargetDir)%(RecursiveDir)%(FileName)%(Extension)" />-->
    <Message Importance="high" Text="##### CREATELOCALECONTENT" />
  </Target>

  <Target Name="LocaleBuild" BeforeTargets="BeforeBuild" DependsOnTargets="ImportLocaleReference;CreateLocaleContent" />

  <!--=========================================================================-->

  <Target Name="GetTextBuild" BeforeTargets="Build" DependsOnTargets="SplitPoResourceByCulture;CreatePoTemplate;MergePoTemplateIntoPoResource;CreateMoResource">
    <!--<LogItems Items="@(PoResource)" AllMetadata="true" />-->
  </Target>
  <Target Name="GetTextClean" AfterTargets="Clean" />


  <!--<Target Name="CsGetTextTrace" BeforeTargets="BeforeBuild">
    <Message Importance="high" Text="##### CSGETTEXTTRACE" />
    <LogItems Items="@(ProjectReference)" Title="ProjectReference" AllMetadata="true" />
    <ItemGroup>
      <LocaleReference Include="%(ProjectReference.RootDir)%(Directory)$(OutputPath)$(PoLocaleDir)\**\*.mo" />
    </ItemGroup>
    <LogItems Items="@(LocaleReference)" Title="LocaleReference" AllMetadata="true" />
    <ItemGroup>
      <Content Include="@(LocaleReference)">
        <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
        <Visible>false</Visible>
      </Content>
    </ItemGroup>
    <LogItems Items="@(Content)" Title="Content" AllMetadata="true" />
    <Message Importance="high" Text="##### CSGETTEXTTRACE" />
  </Target>-->
</Project>