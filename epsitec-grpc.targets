<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  
  <!-- When used inside nuget package generated by `vcpkg` -->
  <Import Condition="Exists('../../scripts/buildsystems/msbuild/vcpkg.targets')" Project="../../scripts/buildsystems/msbuild/vcpkg.targets" />
  
  <!-- Could be moved to vcpkg.targets -->
  <ItemDefinitionGroup>
    <ClCompile Condition="'$(VcpkgTriplet)' != '' And $(VcpkgTriplet.EndsWith('-static'))">
      <RuntimeLibrary Condition="$(Configuration.StartsWith('Debug'))">MultiThreadedDebug</RuntimeLibrary>
      <RuntimeLibrary Condition="$(Configuration.StartsWith('Release'))">MultiThreaded</RuntimeLibrary>
    </ClCompile>
  </ItemDefinitionGroup>
  
  <!-- Define additional tools options for protobuf and grpc compilation and linking -->
  <ItemDefinitionGroup>
    <ClCompile>
      <!-- Needed by the C++ compiler to find the generated protobuf souce code -->
      <AdditionalIncludeDirectories>%(AdditionalIncludeDirectories);$(IntDir)</AdditionalIncludeDirectories>
    </ClCompile>
    <!-- Needed by the linker to resolve symbols used by the grpc libraries -->
    <Link>
      <AdditionalDependencies>%(AdditionalDependencies);ws2_32.lib</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>

  <!-- Define protoc command path and properties -->
  <PropertyGroup>
    <GrpcPluginPath>$(VcpkgRoot)tools\grpc\grpc_cpp_plugin.exe</GrpcPluginPath>
    <ProtocCommand>"$(VcpkgRoot)tools\protobuf\protoc.exe" -I "$(VcpkgRoot)include"</ProtocCommand>
    <ProtocOutDir>$(ProjectDir)$(IntDir)</ProtocOutDir>
    <ProtocOutDir_>$(ProtocOutDir.TrimEnd(\/))</ProtocOutDir_>
  </PropertyGroup>

  <!-- Initialize additional protobuf metadata -->
  <Target Name="ProtobufInit">
    <ItemGroup>
      <!-- Include protoc generated file pathes in protobuf metadata to be used as dependencies in other targets -->
      <Protobuf>
        <GrpcCppOutPath>$(ProtocOutDir)%(Filename).grpc.pb.cc</GrpcCppOutPath>
        <CppOutPath>$(ProtocOutDir)%(Filename).pb.cc</CppOutPath>
      </Protobuf>
    </ItemGroup>
  </Target>
  
  <!-- Generate C++ grpc and protobuf source files in the intermediate folder -->
  <Target Name="ProtobufCompile"
          DependsOnTargets="ProtobufInit"
          BeforeTargets="ClCompile"
          Inputs="%(Protobuf.Identity)"
          Outputs="%(Protobuf.GrpcCppOutPath);%(Protobuf.CppOutPath)">

    <!-- The protobuf source directory has to be included in the protoc path -->
    <PropertyGroup>
      <ProtocPathOption>%(Protobuf.RootDir)%(Directory)</ProtocPathOption>
      <ProtocPathOption>--proto_path="$(ProtocPathOption.TrimEnd(\/))"</ProtocPathOption>
    </PropertyGroup>
    <!-- Generate the grpc code -->
    <Exec Command='$(ProtocCommand) $(ProtocPathOption) --grpc_out="$(ProtocOutDir_)" --plugin=protoc-gen-grpc="$(GrpcPluginPath)" "%(Protobuf.FullPath)"' />
    <Message Importance="high" Text='%(Protobuf.FileName)%(Extension) -> %(Filename).grpc.pb.cc' />
    <!-- Generate the protobuf code -->
    <Exec Command='$(ProtocCommand) $(ProtocPathOption) --cpp_out="$(ProtocOutDir_)" "%(Protobuf.FullPath)"' />
    <Message Importance="high" Text='%(Protobuf.FileName)%(Extension) -> %(Filename).pb.cc' />

    <!-- Add generated source files to the C++ compiler sources -->
    <ItemGroup>
      <ClCompile Include="%(Protobuf.GrpcCppOutPath)" />
      <ClCompile Include="%(Protobuf.CppOutPath)" />
    </ItemGroup>
  </Target>
  
  <!-- Delete protoc generated files -->
  <Target Name="ProtobufClean" AfterTargets="Clean">
    <ItemGroup>
      <ProtocOutput Include="$(ProtocOutDir)%(Protobuf.Filename).*" />
    </ItemGroup>
    <Delete Files="@(ProtocOutput)" />
  </Target>

</Project>