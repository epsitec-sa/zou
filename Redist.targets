<!--
Import this script at the end of a C# redist agent
For information on redist properties, see Redist.props
-->
<Project InitialTargets="TraceRedistTargets;RedistCheckProps">

  <!-- Supported Windows platform  -->
  <PropertyGroup>
    <WinRuntimePrefix Condition="'$(WinRuntimePrefix)' == ''">win7</WinRuntimePrefix>
  </PropertyGroup>

  <!-- Defaults-->
  <PropertyGroup>
    <RedistByFramework  Condition="'$(RedistByFramework)'  == ''">false</RedistByFramework>
  </PropertyGroup>

  <!-- Limit cross-build -->
  <PropertyGroup>
    <!-- FullTargetFramework is not available on OSX and Linux -->
    <CrossBuild Condition="'$(RedistX64Framework)' == '$(FullTargetFramework)'">false</CrossBuild>
    <!-- Do not cross-build inside Visual Studio -->
    <CrossBuild Condition="'$(BuildingInsideVisualStudio)' != ''">false</CrossBuild>
    <CrossBuild Condition="'$(CrossBuild)' == ''">false</CrossBuild>

    <BuildWin>false</BuildWin>
    <BuildOsx>false</BuildOsx>
    <BuildLinux>false</BuildLinux>
    <BuildWin   Condition="$(CrossBuild) Or $(RuntimeIdentifier.StartsWith('win'))   Or ('$(RuntimeIdentifier)'=='' And $([MSBuild]::IsOsPlatform(Windows)))">true</BuildWin>
    <BuildOsx   Condition="$(CrossBuild) Or $(RuntimeIdentifier.StartsWith('osx'))   Or ('$(RuntimeIdentifier)'=='' And $([MSBuild]::IsOsPlatform(OSX))    )">true</BuildOsx>
    <BuildLinux Condition="$(CrossBuild) Or $(RuntimeIdentifier.StartsWith('linux')) Or ('$(RuntimeIdentifier)'=='' And $([MSBuild]::IsOsPlatform(Linux))  )">true</BuildLinux>
  </PropertyGroup>

  <!-- Append or not the runtime identifier to the output directory -->
  <PropertyGroup>
    <!--
      if CrossBuild                           # need to classify multiple outputs
        RedistByRuntime = true
      elsif OutDir.Contains(RuntimePlatform)  # no need to classify output
        RedistByRuntime = false
       else
        RedistByRuntime = true
       endif
     -->
    <RedistByRuntime Condition="'$(RedistByRuntime)' == '' And $(CrossBuild)">true</RedistByRuntime>
    <RedistByRuntime Condition="'$(RedistByRuntime)' == '' And '$(RuntimePlatform)' != '' And $(OutDir.Contains('$(RuntimePlatform)'))">false</RedistByRuntime>
    <RedistByRuntime Condition="'$(RedistByRuntime)' == '' And '$(RuntimePlatform)' == 'x86' And $(OutDir.Contains('Win32'))">false</RedistByRuntime>
    <RedistByRuntime Condition="'$(RedistByRuntime)' == ''">true</RedistByRuntime>
  </PropertyGroup>

  <!-- Define RedistProject metadata transfered to ItemProject -->
  <PropertyGroup>
    <RedistProjectMetadataToRemove>CrossBuild;Os;RedistFolder;RedistByFramework;RedistByRuntime;RedistX86Framework;RedistX64Framework</RedistProjectMetadataToRemove>
    <RedistProjectMetadataToKeep>Targets</RedistProjectMetadataToKeep>
    <RedistProjectMetadataToTransfer>$(RedistProjectMetadataToRemove);$(RedistProjectMetadataToKeep)</RedistProjectMetadataToTransfer>
  </PropertyGroup>

  <!-- Setup RedistProject defaults -->
  <!--<ItemDefinitionGroup>
    <RedistProject>
      <CrossBuild         Condition="'%(CrossBuild)'         == '' And '$(CrossBuild)'         != ''">$(CrossBuild)</CrossBuild>
      <RedistFolder       Condition="'%(RedistFolder)'       == '' And '$(RedistFolder)'       != ''">$(RedistFolder)</RedistFolder>
      <RedistByFramework  Condition="'%(RedistByFramework)'  == '' And '$(RedistByFramework)'  != ''">$(RedistByFramework)</RedistByFramework>
      <RedistByRuntime    Condition="'%(RedistByRuntime)'    == '' And '$(RedistByRuntime)'    != ''">$(RedistByRuntime)</RedistByRuntime>
      <RedistX86Framework Condition="'%(RedistX86Framework)' == '' And '$(RedistX86Framework)' != ''">$(RedistX86Framework)</RedistX86Framework>
      <RedistX64Framework Condition="'%(RedistX64Framework)' == '' And '$(RedistX64Framework)' != ''">$(RedistX64Framework)</RedistX64Framework>
    </RedistProject>
  </ItemDefinitionGroup>-->
  
  <!-- Create default RedistProject Item -->
  <ItemGroup>
    <RedistProject Include="$(RedistProjectPath)" Condition="'$(RedistProjectPath)' != ''">
      <CrossBuild         Condition="'$(CrossBuild)'         != ''">$(CrossBuild)</CrossBuild>
      <RedistFolder       Condition="'$(RedistFolder)'       != ''">$(RedistFolder)</RedistFolder>
      <RedistByFramework  Condition="'$(RedistByFramework)'  != ''">$(RedistByFramework)</RedistByFramework>
      <RedistByRuntime    Condition="'$(RedistByRuntime)'    != ''">$(RedistByRuntime)</RedistByRuntime>
      <RedistX86Framework Condition="'$(RedistX86Framework)' != ''">$(RedistX86Framework)</RedistX86Framework>
      <RedistX64Framework Condition="'$(RedistX64Framework)' != ''">$(RedistX64Framework)</RedistX64Framework>
    </RedistProject>
  </ItemGroup>
  
  <!-- Duplicate ItemProject for specified OSes-->
  <ItemGroup>
    <ImportProject Include="@(RedistProject)" Condition="$(BuildWin)" KeepMetadata="$(RedistProjectMetadataToTransfer)">
      <Os>win</Os>
    </ImportProject>
    <ImportProject Include="@(RedistProject)" Condition="$(BuildOsx) And '$(RuntimePlatform)' == 'x64'" KeepMetadata="$(RedistProjectMetadataToTransfer)">
      <Os>osx</Os>
    </ImportProject>
    <ImportProject Include="@(RedistProject)" Condition="$(BuildLinux) And '$(RuntimePlatform)' == 'x64'" KeepMetadata="$(RedistProjectMetadataToTransfer)">
      <Os>linux</Os>
    </ImportProject>
  </ItemGroup>

  <Target Name="RedistInitImports">
    <!--<LogItems Condition="$(RedistDebug)" Items="@(ImportProject)" Title="RedistInitImports.ImportProject" />
    <Message  Condition="$(RedistDebug)" Importance="high" Text=" " />-->

    <ItemGroup>
      <ImportProject Condition="'%(ImportProject.Os)' == 'win'">
        <!-- Use 'msbuild' for .sln and .vcxproj -->
        <RuntimeType Condition="'%(Extension)' == '.sln' Or '%(Extension)' == '.vcxproj'">Full</RuntimeType>
        <!-- Use 'dotnet build' for .csproj -->
        <RuntimeType Condition="'%(Extension)' == '.csproj'">Core</RuntimeType>
      </ImportProject>
      <ImportProject>
        <RuntimeFolder>%(ImportProject.Os)-$(RuntimePlatform)</RuntimeFolder>
      </ImportProject>
      <ImportProject>
        <OutDir    >$(OutDir)%(ImportProject.RuntimeFolder)</OutDir>
        <PublishDir>$(OutDir)%(ImportProject.RuntimeFolder)</PublishDir>
      </ImportProject>
    </ItemGroup>

    <!-- x86|AnyCPU -->
    <ItemGroup Condition="'$(RuntimePlatform)' == 'x86' Or '$(RuntimePlatform)' == 'AnyCPU'">
      <ImportProject Condition="'%(ImportProject.Os)' == 'win'">
        <RuntimeFolder>win-$(RuntimePlatform)</RuntimeFolder>
        <RuntimeIdentifier Condition="'$(RuntimePlatform)' == 'x86'">$(WinRuntimePrefix)-$(RuntimePlatform)</RuntimeIdentifier>
        <TargetFramework   Condition="'%(ImportProject.RedistX86Framework)' != ''">%(ImportProject.RedistX86Framework)</TargetFramework>
      </ImportProject>
    </ItemGroup>

    <!-- x64 -->
    <ItemGroup Condition="'$(RuntimePlatform)' == 'x64'">
      <!-- Windows -->
      <ImportProject Condition="'%(ImportProject.Os)' == 'win'">
        <RuntimeFolder>win-$(RuntimePlatform)</RuntimeFolder>
        <RuntimeIdentifier Condition="'%(ImportProject.RedistX64Framework)' == '$(CoreTargetFramework)'">$(WinRuntimePrefix)-$(RuntimePlatform)</RuntimeIdentifier>
        <TargetFramework   Condition="'%(ImportProject.RedistX64Framework)' != ''">%(ImportProject.RedistX64Framework)</TargetFramework>
      </ImportProject>
      
      <!-- OSX -->
      <ImportProject Condition="'%(ImportProject.Os)' == 'osx'">
        <!-- Use 'dotnet build' on OSX -->
        <RuntimeType>Core</RuntimeType>
        <RuntimeFolder>osx-$(RuntimePlatform)</RuntimeFolder>
        <TargetFramework>$(CoreTargetFramework)</TargetFramework>
        <RuntimeIdentifier>osx-$(RuntimePlatform)</RuntimeIdentifier>
      </ImportProject>
      
      <!-- Linux -->
      <ImportProject Condition="'%(ImportProject.Os)' == 'linux'">
        <!-- Use 'dotnet build' on Linux -->
        <RuntimeType>Core</RuntimeType>
        <RuntimeFolder>linux-$(RuntimePlatform)</RuntimeFolder>
        <TargetFramework>$(CoreTargetFramework)</TargetFramework>
        <RuntimeIdentifier>linux-$(RuntimePlatform)</RuntimeIdentifier>
      </ImportProject>

      <!-- Remove temporary metadata -->
      <ImportProject RemoveMetadata="$(RedistProjectMetadataToRemove)" />
    </ItemGroup>
  </Target>

  <!--
  Transform ImportProject.(Out|Publish)Dir metadata from redist to monolith layout

    - redist   layout format: $(OutDir)<project-folder>\$(RuntimeIdentifier)
    - monolith layout format: $(OutDir)$(RuntimeIdentifier)\$(RedistFolder)\<project-folder>\

    Inputs:
      PropertyGroup
        $(OutDir)       - ex: C:\devel\cresus-dev\cresus\bin\Release\
        $(RedistFolder) - ex: user\modules\cresus
      ItemGroup.ImportProject (redist layout)
        %(OutDir)       - ex: C:\devel\cresus-dev\cresus\bin\Release\xlsgen\win-x64
        %(PublishDir)   - ex: C:\devel\cresus-dev\cresus\bin\Release\xlsgen\win-x64
    Outputs:
      ItemGroup.ImportProject (monolith layout)
        %(OutDir)       - ex: C:\devel\cresus-dev\cresus\bin\Release\win-x64\user\modules\cresus\xlsgen\
        %(PublishDir)   - ex: C:\devel\cresus-dev\cresus\bin\Release\win-x64\user\modules\cresus\xlsgen\
        %(AsmDir)       - ex: C:\devel\cresus-dev\cresus\bin\Release\win-x64\user\modules\cresus\.cod\    (C++ project only)
  -->
  <Target Name="RedistTransformLayout" Condition="'$(RedistFolder)' != ''" DependsOnTargets="RedistInitImports">
    <ItemGroup>
      <!-- Process C# output directories -->
      <ImportProject>
        <_OutputFolder Condition="! $(RedistByRuntime)">$(RedistFolder)</_OutputFolder>
        <_OutputFolder Condition="  $(RedistByRuntime)">$([System.IO.Path]::Combine('%(ImportProject.RuntimeFolder)', '$(RedistFolder)'))</_OutputFolder>
      </ImportProject>
      <ImportProject>
        <_OutputFolder Condition="$(RedistByFramework)">$([System.IO.Path]::Combine('%(ImportProject.TargetFramework)', '%(ImportProject._OutputFolder)'))</_OutputFolder>
      </ImportProject>
      <ImportProject>
        <_OutputFolder>$([MSBuild]::EnsureTrailingSlash('%(ImportProject._OutputFolder)'))</_OutputFolder>
      </ImportProject>

      <ImportProject>
        <OutDir     Condition="'%(ImportProject.OutDir)'     != ''">$([System.IO.Path]::GetFullPath('$(OutDir)%(_OutputFolder)'))</OutDir>
        <PublishDir Condition="'%(ImportProject.PublishDir)' != ''">$([System.IO.Path]::GetFullPath('$(OutDir)%(_OutputFolder)'))</PublishDir>
      </ImportProject>
      <ImportProject>
        <AsmDir Condition="'%(ImportProject.OutDir)' != '' And !$([System.String]::new('%(ImportProject.Identity)').EndsWith('.csproj'))">%(OutDir).cod\</AsmDir>
      </ImportProject>

      <!-- Remove temporary metadata -->
      <ImportProject RemoveMetadata="_OutputFolder" />
    </ItemGroup>
  </Target>

  <Target Name="RedistUpdateTarget" BeforeTargets="AddBuildOptions" DependsOnTargets="RedistTransformLayout">
    <ItemGroup>
      <ImportProject>
        <!-- use Build target for Debug config or .NET Framework -->
        <_UseBuildTarget>false</_UseBuildTarget>
      </ImportProject>
      <ImportProject>
        <_UseBuildTarget Condition="$(Configuration.StartsWith('Debug', StringComparison.OrdinalIgnoreCase)) Or '%(ImportProject.TargetFramework)' == '' Or '%(ImportProject.TargetFramework)' == '$(FullTargetFramework)'">true</_UseBuildTarget>
      </ImportProject>
      <ImportProject>
        <Targets Condition="'%(ImportProject.Targets)' == ''">Publish</Targets>
        <Targets Condition="'%(ImportProject.Targets)' == '' And %(_UseBuildTarget)">Build</Targets>
      </ImportProject>
      <ImportProject>
        <OutDir     Condition="! %(_UseBuildTarget)" />
        <PublishDir Condition="  %(_UseBuildTarget)" />
      </ImportProject>
      <ImportProject>
        <!--
        Reset Platform metadata if RuntimeIdentifier is specified to avoid redondant platform in OutDir like bin\x64\Release\netstandard2.0\win-x64
        - set its value to *Undefined* so that the ItemDefinitionGroup.ImportProject default value is not restored
        - the AddBuildOptions custom task (ImportProject.targets) does not generate metadata which value equals to *Undefined*
        -->
        <!--<Platform Condition="'%(ImportProject.RuntimeIdentifier)' != '' And '%(ImportProject.RuntimeIdentifier)' != '*Undefined*'">*Undefined*</Platform>-->
      </ImportProject>

      <!-- Remove temporary metadata -->
      <ImportProject RemoveMetadata="_UseBuildTarget" />
    </ItemGroup>

    <LogItems Condition="$(RedistDebug)" Items="@(RedistProject)" Title="RedistUpdateTarget.RedistProject" />
    <Message  Condition="$(RedistDebug)" Importance="high" Text=" " />
    <LogItems Condition="$(RedistDebug)" Items="@(ImportProject)" Title="RedistUpdateTarget.ImportProject" />
    <Message  Condition="$(RedistDebug)" Importance="high" Text=" " />
  </Target>

  <Target Name="RedistCheckProps">
    <Warning Condition="@(ImportProject->Count()) == 0" Text="No project defined in '$(ZouRedistPath)' : specify one with the 'RedistProjectPath' property or the 'ImportProject' ItemGroup." />
  </Target>

  <Target Name="TraceRedistTargets" Condition="$(RedistDebug) Or '$(MSBuildProjectFile)' == '$(MSBuildThisFile)'">
    <Message Importance="high" Text="zou/Redist.targets [$(MSBuildProjectFile)]" />
    <Message Importance="high" Text="------------------" />
    <Message Importance="high" Text="CrossBuild         = $(CrossBuild)" />
    <Message Importance="high" Text="BuildWin           = $(BuildWin)" />
    <Message Importance="high" Text="BuildOsx           = $(BuildOsx)" />
    <Message Importance="high" Text="BuildLinux         = $(BuildLinux)" />
    <Message Importance="high" Text=" " />
    <Message Importance="high" Text="Configuration      = $(Configuration)" />
    <Message Importance="high" Text="RuntimePlatform    = $(RuntimePlatform)" />
    <Message Importance="high" Text="RuntimeIdentifier  = $(RuntimeIdentifier)" />
    <Message Importance="high" Text="OutDir             = $(OutDir)" />
    <Message Importance="high" Text="PublishDir         = $(PublishDir)" />
    <Message Importance="high" Text=" " />
    <Message Importance="high" Text="ZouRedistPath      = $(ZouRedistPath)" />
    <Message Importance="high" Text="RedistByFramework  = $(RedistByFramework)" />
    <Message Importance="high" Text="RedistByRuntime    = $(RedistByRuntime)" />
    <Message Importance="high" Text="RedistX86Framework = $(RedistX86Framework)" />
    <Message Importance="high" Text="RedistX64Framework = $(RedistX64Framework)" />
    <Message Importance="high" Text="RedistProjectPath  = $(RedistProjectPath)" />
    <Message Importance="high" Text=" " />
  </Target>

</Project>
