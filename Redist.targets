<!--
Import this script at the end of a C# redist agent

    RedistProjectPath  - [required] - the path of the project script                         - ex: Net\Swissdec.Transmitter.Host\Swissdec.Transmitter.Host.csproj
                                      relative to the 'zou.build.props' directory
    RedistFolder       - [optional] - append a component folder to the output directory      - ex: bin\Release\win-x64\<redist-folder>
    RedistByFramework  - [optional] - include the target framework   in the output directory - ex: bin\Release\net6[\win-x64]\<redist-folder>
    RedistByRuntime    - [optional] - include the runtime identifier in the output directory - ex: bin\Release\[net6\]win-x64\<redist-folder>
    RedistX86Framework - [optional] - the target framework used for x86 or AnyCPU platforms  - (CoreTargetFramework | FullTargetFramework)
    RedistX64Framework - [optional] - the target framework used for x64 platform             - (CoreTargetFramework | FullTargetFramework)
-->

<Project InitialTargets="TraceRedistTargets" TreatAsLocalProperty="RedistByRuntime">

  <Import Project="hook.zou.build.targets" Condition="'$(ZouBuildTargets)' == ''" />

  <!-- ========== ImportProject ========== -->

  <Target Name="RedistImportProjectInit" DependsOnTargets="ImportProjectInitCrossBuild" >
    <Message Condition="'$(ZouDebug)' == 'true'" Importance="high" Text="### [$(MSBuildProjectFile)] RedistImportProjectInit" />
    <ItemGroup>
      <!-- Setup defaults -->
      <ImportProject>
        <TargetFramework Condition="'%(Extension)' == '.csproj'">$(CoreTargetFramework)</TargetFramework>
        <RedistFolder    Condition="'%(ImportProject.RedistFolder)' == ''">$(RedistFolder)</RedistFolder>
        <RuntimeType  >Core</RuntimeType>
        <RuntimeFolder>%(RuntimeOS)-$(RuntimePlatform)</RuntimeFolder>
      </ImportProject>
        
      <ImportProject>
        <PublishDir Condition="'%(ImportProject.PublishDir)' == ''">%(ImportProject.OutDir)</PublishDir>
      </ImportProject>
      
      <!-- Adjust RuntimeType and TargetFramework for Windows -->
      <ImportProject Condition="'%(RuntimeOS)' == 'win'">
        <!-- Use 'msbuild' for .sln and .vcxproj -->
        <RuntimeType Condition="'%(Extension)' == '.sln' Or '%(Extension)' == '.vcxproj'">Full</RuntimeType>
        <!-- Use 'dotnet build' for .csproj -->
        <RuntimeType Condition="'%(Extension)' == '.csproj'">Core</RuntimeType>
      </ImportProject>
      
      <!-- x86|AnyCPU -->
      <ImportProject Condition="'$(RuntimePlatform)' == 'x86' Or '$(RuntimePlatform)' == 'AnyCPU'">
        <TargetFramework Condition="'%(ImportProject.RedistX86Framework)' != ''">%(ImportProject.RedistX86Framework)</TargetFramework>
      </ImportProject>
      <!-- x64 -->
      <ImportProject Condition="'$(RuntimePlatform)' == 'x64'">
        <TargetFramework Condition="'%(ImportProject.RedistX64Framework)' != ''">%(ImportProject.RedistX64Framework)</TargetFramework>
      </ImportProject>
    </ItemGroup>
  </Target>

  <!--
  Transform ImportProject.(Out|Publish)Dir metadata from standard to redist layout

  - standard: $(OutDir)<project-folder>\$(RuntimeIdentifier)
  - redist:   $(OutDir)$(RuntimeIdentifier)\$(RedistFolder)

  Inputs:
    PropertyGroup
      $(OutDir)       - ex: C:\devel\cresus-dev\cresus\bin\Release\
      $(RedistFolder) - ex: user\modules\cresus
    ItemGroup.ImportProject (redist layout)
      %(OutDir)       - ex: C:\devel\cresus-dev\cresus\bin\Release\xlsgen\win-x64
      %(PublishDir)   - ex: C:\devel\cresus-dev\cresus\bin\Release\xlsgen\win-x64
  Outputs:
    ItemGroup.ImportProject (monolith layout)
      %(OutDir)       - ex: C:\devel\cresus-dev\cresus\bin\Release\win-x64\user\modules\cresus\xlsgen\
      %(PublishDir)   - ex: C:\devel\cresus-dev\cresus\bin\Release\win-x64\user\modules\cresus\xlsgen\
      %(AsmDir)       - ex: C:\devel\cresus-dev\cresus\bin\Release\win-x64\user\modules\cresus\[<c++>\].cod\
  -->
  <Target Name="RedistImportProjectTransformLayout" DependsOnTargets="RedistImportProjectInit">
    <Message Condition="'$(ZouDebug)' == 'true'" Importance="high" Text="### [$(MSBuildProjectFile)] RedistImportProjectTransformLayout" />
    <ItemGroup>
      <!-- Process output directories -->
      <ImportProject>
        <_ProjectFolder Condition="$([System.String]::new('%(ImportProject.OutDir)').StartsWith('$(OutDir)'))">$([System.String]::new('%(ImportProject.OutDir)').Replace('$(OutDir)', ''))</_ProjectFolder>
      </ImportProject>
      <ImportProject>
        <_OutputFolder Condition="! $(RedistByRuntime)">%(ImportProject.RedistFolder)</_OutputFolder>
        <_OutputFolder Condition="  $(RedistByRuntime)">$([System.IO.Path]::Combine('%(ImportProject.RuntimeFolder)', '%(ImportProject.RedistFolder)'))</_OutputFolder>
      </ImportProject>
      <ImportProject>
        <_OutputFolder Condition="$(RedistByFramework)">$([System.IO.Path]::Combine('%(ImportProject.TargetFramework)', '%(ImportProject._OutputFolder)'))</_OutputFolder>
      </ImportProject>
      <ImportProject>
        <_OutputFolder>$([MSBuild]::EnsureTrailingSlash($([System.IO.Path]::Combine('%(ImportProject._OutputFolder)', '%(ImportProject._ProjectFolder)'))))</_OutputFolder>
      </ImportProject>

      <ImportProject>
        <OutDir     Condition="'%(ImportProject.OutDir)'     != ''">$([System.IO.Path]::GetFullPath('$(OutDir)%(_OutputFolder)'))</OutDir>
        <PublishDir Condition="'%(ImportProject.PublishDir)' != ''">$([System.IO.Path]::GetFullPath('$(OutDir)%(_OutputFolder)'))</PublishDir>
      </ImportProject>
      <ImportProject>
        <AsmDir Condition="'%(ImportProject.OutDir)' != '' And ('%(Extension)' == '.vcxproj' Or '%(Extension)' == '.sln')">%(OutDir).cod\</AsmDir>
      </ImportProject>

      <!-- Remove temporary metadata -->
      <ImportProject RemoveMetadata="_ProjectFolder;_OutputFolder" />
    </ItemGroup>
  </Target>

  <Target Name="RedistImportProjectUpdateTarget" DependsOnTargets="RedistImportProjectTransformLayout;RedistImportProjectInit" BeforeTargets="CreateMSBuildProjects">
    <Message Condition="'$(ZouDebug)' == 'true'" Importance="high" Text="### [$(MSBuildProjectFile)] RedistImportProjectUpdateTarget" />
    <ItemGroup>
      <ImportProject>
        <!-- use Build target for Debug config or .NET Framework -->
        <_UseBuildTarget>false</_UseBuildTarget>
      </ImportProject>
      <ImportProject>
        <_UseBuildTarget Condition="$(Configuration.StartsWith('Debug', StringComparison.OrdinalIgnoreCase)) Or '%(ImportProject.TargetFramework)' == '' Or '%(ImportProject.TargetFramework)' == '$(FullTargetFramework)'">true</_UseBuildTarget>
      </ImportProject>

      <ImportProject>
        <Targets Condition="'%(ImportProject.Targets)' == ''">Publish</Targets>
        <Targets Condition="'%(ImportProject.Targets)' == '' And %(_UseBuildTarget)">Build</Targets>
      </ImportProject>
      <ImportProject>
        <OutDir     Condition="! %(_UseBuildTarget)" />
        <PublishDir Condition="  %(_UseBuildTarget)" />
      </ImportProject>

      <!-- Remove temporary metadata -->
      <ImportProject RemoveMetadata="_UseBuildTarget" />
    </ItemGroup>

    <LogItems Condition="$(RedistDebug)" Items="@(ImportProject)" Title="RedistUpdateTarget.ImportProject" />
    <Message  Condition="$(RedistDebug)" Importance="high" Text=" " />
  </Target>


  <!-- ========== CopyFile ========== -->

  <Target Name="RedistCopyFileInit" DependsOnTargets="CopyFileInitCrossBuild" >
    <Message Condition="'$(ZouDebug)' == 'true'" Importance="high" Text="### [$(MSBuildProjectFile)] RedistCopyFileInit" />
    <ItemGroup>
      <CopyFile>
        <RedistFolder Condition="'%(CopyFile.RedistFolder)' == ''">$(RedistFolder)</RedistFolder>
        <RuntimeFolder>%(RuntimeOS)-$(RuntimePlatform)</RuntimeFolder>
      </CopyFile>
    </ItemGroup>
  </Target>

  <Target Name="RedistCopyFileTransformLayout" DependsOnTargets="RedistCopyFileInit" BeforeTargets="CopyFile">
    <Message Condition="'$(ZouDebug)' == 'true'" Importance="high" Text="### [$(MSBuildProjectFile)] RedistCopyFileTransformLayout" />
    <ItemGroup>
      <!-- Process output directories -->
      <CopyFile>
        <_ProjectFolder Condition="$([System.String]::new('%(CopyFile.TargetDir)').StartsWith('$(OutDir)'))">$([System.String]::new('%(CopyFile.TargetDir)').Replace('$(OutDir)', ''))</_ProjectFolder>
      </CopyFile>
      <CopyFile>
        <_OutputFolder Condition="! $(RedistByRuntime)">%(CopyFile.RedistFolder)</_OutputFolder>
        <_OutputFolder Condition="  $(RedistByRuntime)">$([System.IO.Path]::Combine('%(CopyFile.RuntimeFolder)', '%(CopyFile.RedistFolder)'))</_OutputFolder>
      </CopyFile>
      <CopyFile>
        <_OutputFolder Condition="$(RedistByFramework)">$([System.IO.Path]::Combine('%(CopyFile.TargetFramework)', '%(CopyFile._OutputFolder)'))</_OutputFolder>
      </CopyFile>
      <CopyFile>
        <_OutputFolder>$([MSBuild]::EnsureTrailingSlash($([System.IO.Path]::Combine('%(CopyFile._OutputFolder)', '%(CopyFile._ProjectFolder)'))))</_OutputFolder>
      </CopyFile>

      <CopyFile>
        <TargetDir Condition="'%(CopyFile.TargetDir)' != ''">$([System.IO.Path]::GetFullPath('$(OutDir)%(_OutputFolder)'))</TargetDir>
      </CopyFile>

      <!-- Remove temporary metadata -->
      <CopyFile RemoveMetadata="_ProjectFolder;_OutputFolder" />
    </ItemGroup>

    <!--<LogItems Condition="$(RedistDebug)" Items="@(CopyFile)" Title="RedistCopyFileTransformLayout.CopyFile" />
    <Message  Condition="$(RedistDebug)" Importance="high" Text=" " />-->
  </Target>


  <!-- ========== ImportFile ========== -->

  <Target Name="RedistImportFileInit" DependsOnTargets="ImportFileInitCrossBuild" >
    <Message Condition="'$(ZouDebug)' == 'true'" Importance="high" Text="### [$(MSBuildProjectFile)] RedistImportFileInit" />
    <ItemGroup>
      <ImportFile>
        <RedistFolder Condition="'%(ImportFile.RedistFolder)' == ''">$(RedistFolder)</RedistFolder>
        <RuntimeFolder>%(RuntimeOS)-$(RuntimePlatform)</RuntimeFolder>
      </ImportFile>
    </ItemGroup>
  </Target>

  <Target Name="RedistImportFileTransformLayout" DependsOnTargets="RedistImportFileInit" BeforeTargets="ImportFile">
    <Message Condition="'$(ZouDebug)' == 'true'" Importance="high" Text="### [$(MSBuildProjectFile)] RedistImportFileTransformLayout" />
    <ItemGroup>
      <!-- Process output directories -->
      <ImportFile>
        <_ProjectFolder Condition="$([System.String]::new('%(ImportFile.ImportDir)').StartsWith('$(OutDir)'))">$([System.String]::new('%(ImportFile.ImportDir)').Replace('$(OutDir)', ''))</_ProjectFolder>
      </ImportFile>
      <ImportFile>
        <_OutputFolder Condition="! $(RedistByRuntime)">%(ImportFile.RedistFolder)</_OutputFolder>
        <_OutputFolder Condition="  $(RedistByRuntime)">$([System.IO.Path]::Combine('%(ImportFile.RuntimeFolder)', '%(ImportFile.RedistFolder)'))</_OutputFolder>
      </ImportFile>
      <ImportFile>
        <_OutputFolder Condition="$(RedistByFramework)">$([System.IO.Path]::Combine('%(ImportFile.TargetFramework)', '%(ImportFile._OutputFolder)'))</_OutputFolder>
      </ImportFile>
      <ImportFile>
        <_OutputFolder>$([MSBuild]::EnsureTrailingSlash($([System.IO.Path]::Combine('%(ImportFile._OutputFolder)', '%(ImportFile._ProjectFolder)'))))</_OutputFolder>
      </ImportFile>

      <ImportFile>
        <ImportDir Condition="'%(ImportFile.ImportDir)' != ''">$([System.IO.Path]::GetFullPath('$(OutDir)%(_OutputFolder)'))</ImportDir>
      </ImportFile>

      <!-- Remove temporary metadata -->
      <!--<ImportFile RemoveMetadata="_ProjectFolder;_OutputFolder" />-->
    </ItemGroup>

    <!--<LogItems Condition="$(RedistDebug)" Items="@(ImportFile)" Title="RedistImportFileTransformLayout.ImportFile" />
    <Message  Condition="$(RedistDebug)" Importance="high" Text=" " />-->
  </Target>

  <Target Name="TraceRedistTargets" Condition="$(RedistDebug) Or '$(MSBuildProjectFile)' == '$(MSBuildThisFile)'"
          BeforeTargets="CreateMSBuildProjects" AfterTargets="RedistImportProjectUpdateTarget">
    <Message Importance="high" Text="zou/Redist.targets [$(MSBuildProjectFile)]" />
    <Message Importance="high" Text="------------------" />
    <Message Importance="high" Text="ZouBuildProps      = $(ZouBuildProps)" />
    <Message Importance="high" Text="ZouBuildTargets    = $(ZouBuildTargets)" />
    <Message Importance="high" Text="CrossBuild         = $(CrossBuild)" />
    <Message Importance="high" Text="BuildWin           = $(BuildWin)" />
    <Message Importance="high" Text="BuildOsx           = $(BuildOsx)" />
    <Message Importance="high" Text="BuildLinux         = $(BuildLinux)" />
    <Message Importance="high" Text=" " />
    <Message Importance="high" Text="Configuration      = $(Configuration)" />
    <Message Importance="high" Text="Platform           = $(Platform)" />
    <Message Importance="high" Text="RuntimeIdentifier  = $(RuntimeIdentifier)" />
    <Message Importance="high" Text="@RuntimeIdentifier = %(RuntimeIdentifier.Identity)" />
    <Message Importance="high" Text="RuntimeOs          = $(RuntimeOs)" />
    <Message Importance="high" Text="RuntimePlatform    = $(RuntimePlatform)" />
    <Message Importance="high" Text="RuntimeFolder      = $(RuntimeFolder)" />
    <Message Importance="high" Text="RedistFolder       = $(RedistFolder)" />
    <Message Importance="high" Text="OutDir             = $(OutDir)" />
    <Message Importance="high" Text="PublishDir         = $(PublishDir)" />
    <Message Importance="high" Text=" " />
    <Message Importance="high" Text="RedistByRuntime    = $(RedistByRuntime)" />
    <Message Importance="high" Text="RedistByFramework  = $(RedistByFramework)" />
    <Message Importance="high" Text=" " />
  </Target>

</Project>
