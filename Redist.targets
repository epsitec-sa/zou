<!--
Import this script at the end of a C# redist agent

  Inputs:
    RedistProjectPath     
    RedistFolder          
    RedistWinX86Framework - CoreTargetFramework | FullTargetFramework
    RedistWinX64Framework - CoreTargetFramework | FullTargetFramework

-->
<Project InitialTargets="TraceRedistTargets">

  <Import Project="Import.targets"/>

  <!-- Debug|x86 -->
  <ItemGroup Condition="'$(Configuration)|$(RuntimePlatform)'=='Debug|x86'">
    <ImportProject Condition="$([MSBuild]::IsOsPlatform(Windows))" Include="$(RedistProjectPath)">
      <TargetFramework>$(RedistWinX86Framework)</TargetFramework>
      <OutDir>$(OutDir)</OutDir>
      <PublishDir />
    </ImportProject>
  </ItemGroup>

  <!-- Debug|x64 or Debug|AnyCPU -->
  <ItemGroup Condition="'$(Configuration)|$(RuntimePlatform)'=='Debug|x64' Or '$(Configuration)|$(RuntimePlatform)'=='Debug|AnyCPU'">
    <ImportProject Condition="$([MSBuild]::IsOsPlatform(Windows))" Include="$(RedistProjectPath)">
      <TargetFramework>$(RedistWinX64Framework)</TargetFramework>
      <OutDir>$(OutDir)</OutDir>
      <PublishDir />
    </ImportProject>
  </ItemGroup>
  
  <!-- Release|x86 -->
  <ItemGroup Condition="'$(Configuration)|$(RuntimePlatform)'=='Release|x86'">
    <ImportProject Condition="$([MSBuild]::IsOsPlatform(Windows))" Include="$(RedistProjectPath)">
      <RuntimeIdentifier Condition="'%(RuntimeIdentifier)' == ''">win-x86</RuntimeIdentifier>
      <TargetFramework>$(RedistWinX86Framework)</TargetFramework>
      <OutDir />
      <PublishDir />
      <OutDir     Condition="'$(RedistWinX86Framework)' == '$(FullTargetFramework)'">$(OutDir)win-$(RuntimePlatform)</OutDir>
      <PublishDir Condition="'$(RedistWinX86Framework)' == '$(CoreTargetFramework)'">$(OutDir)win-$(RuntimePlatform)</PublishDir>
    </ImportProject>
  </ItemGroup>

  <!-- Release|x64 or Release|AnyCPU -->
  <ItemGroup Condition="'$(Configuration)|$(RuntimePlatform)'=='Release|x64' Or '$(Configuration)|$(RuntimePlatform)'=='Release|AnyCPU'">
    <ImportProject Condition="$(BuildWin)" Include="$(RedistProjectPath)">
      <RuntimeIdentifier>win-x64</RuntimeIdentifier>
      <TargetFramework>$(RedistWinX64Framework)</TargetFramework>
      <OutDir />
      <PublishDir>$(OutDir)win-$(RuntimePlatform)</PublishDir>
    </ImportProject>
    <ImportProject Condition="$(BuildOsx)" Include="$(RedistProjectPath)">
      <RuntimeIdentifier>osx-x64</RuntimeIdentifier>
      <TargetFramework>$(CoreTargetFramework)</TargetFramework>
      <OutDir />
      <PublishDir>$(OutDir)osx-$(RuntimePlatform)</PublishDir>
    </ImportProject>
    <ImportProject Condition="$(BuildLinux)" Include="$(RedistProjectPath)">
      <RuntimeIdentifier>linux-x64</RuntimeIdentifier>
      <TargetFramework>$(CoreTargetFramework)</TargetFramework>
      <OutDir />
      <PublishDir>$(OutDir)linux-$(RuntimePlatform)</PublishDir>
    </ImportProject>
  </ItemGroup>

  <!--
  Transform ImportProject.(Out|Publish)Dir metadata from redist to monolith layout

    - redist   layout format: $(OutDir)<project-folder>\$(RuntimeIdentifier)
    - monolith layout format: $(OutDir)$(RuntimeIdentifier)\$(RedistFolder)\<project-folder>\

    Inputs:
      PropertyGroup
        $(OutDir)       - ex: C:\devel\cresus-dev\cresus\bin\Release\
        $(RedistFolder) - ex: user\modules\cresus
      ItemGroup.ImportProject (redist layout)
        %(OutDir)       - ex: C:\devel\cresus-dev\cresus\bin\Release\xlsgen\win-x64
        %(PublishDir)   - ex: C:\devel\cresus-dev\cresus\bin\Release\xlsgen\win-x64
    Outputs:
      ItemGroup.ImportProject (monolith layout)
        %(OutDir)       - ex: C:\devel\cresus-dev\cresus\bin\Release\win-x64\user\modules\cresus\xlsgen\
        %(PublishDir)   - ex: C:\devel\cresus-dev\cresus\bin\Release\win-x64\user\modules\cresus\xlsgen\
        %(AsmDir)       - ex: C:\devel\cresus-dev\cresus\bin\Release\win-x64\user\modules\cresus\.cod\    (C++ project only)
  -->
  <Target Name="RedistTransformLayout" Condition="'$(RedistFolder)' != ''">
    <ItemGroup>
      <ImportProject>
        <_RuntimeFolder Condition="$([System.String]::new('%(ImportProject.OutDir)').EndsWith('$(RuntimePlatform)'))">$([System.IO.Path]::GetFileName('%(OutDir)'))</_RuntimeFolder>
        <_RuntimeFolder Condition="$([System.String]::new('%(ImportProject.PublishDir)').EndsWith('$(RuntimePlatform)'))">$([System.IO.Path]::GetFileName('%(ImportProject.PublishDir)'))</_RuntimeFolder>
      </ImportProject>

      <ImportProject>
        <_ProjectOutputFolder Condition="'%(ImportProject.OutDir)'     != ''">$([System.String]::new('%(OutDir)').Replace('$(OutDir)', ''))</_ProjectOutputFolder>
        <_ProjectOutputFolder Condition="'%(ImportProject.PublishDir)' != ''">$([System.String]::new('%(ImportProject.PublishDir)').Replace('$(OutDir)', ''))</_ProjectOutputFolder>
      </ImportProject>
      <ImportProject>
        <_ProjectOutputFolder Condition="$([System.String]::new('%(ImportProject._ProjectOutputFolder)').EndsWith('%(ImportProject._RuntimeFolder)'))">$([System.IO.Path]::GetDirectoryName('%(_ProjectOutputFolder)'))</_ProjectOutputFolder>
      </ImportProject>
      <ImportProject>
        <_ProjectOutputFolder>$([MSBuild]::EnsureTrailingSlash('%(ImportProject._ProjectOutputFolder)'))</_ProjectOutputFolder>
      </ImportProject>

      <ImportProject>
        <_OutputFolder>$([MSBuild]::EnsureTrailingSlash('$([System.IO.Path]::Combine('%(ImportProject._RuntimeFolder)', '$(RedistFolder)'))'))</_OutputFolder>
      </ImportProject>
      <!--<ImportProject>
        <_OutputFolder Condition="'$(RedistFolder)' != ''">$([MSBuild]::EnsureTrailingSlash('%(ImportProject._OutputFolder)$(RedistFolder)'))</_OutputFolder>
      </ImportProject>-->
      <ImportProject>
        <_OutputFolder>%(ImportProject._OutputFolder)%(_ProjectOutputFolder)</_OutputFolder>
      </ImportProject>

      <ImportProject>
        <OutDir     Condition="'%(ImportProject.OutDir)'     != ''">$([System.IO.Path]::GetFullPath('$(OutDir)%(_OutputFolder)'))</OutDir>
        <PublishDir Condition="'%(ImportProject.PublishDir)' != ''">$([System.IO.Path]::GetFullPath('$(OutDir)%(_OutputFolder)'))</PublishDir>
      </ImportProject>
      <ImportProject>
        <AsmDir Condition="'%(ImportProject.OutDir)' != '' And !$([System.String]::new('%(ImportProject.Identity)').EndsWith('.csproj'))">%(OutDir).cod\</AsmDir>
      </ImportProject>

      <!-- Remove temporary metadata -->
      <!--<ImportProject RemoveMetadata="_ProjectOutputFolder;_OutputFolder;_RuntimeFolder" />-->
    </ItemGroup>

    <LogItems Items="@(ImportProject)" Title="RedistTransformLayout.ImportProject" />
  </Target>
  
  <Target Name="RedistUpdateTarget" BeforeTargets="AddBuildOptions" DependsOnTargets="RedistTransformLayout">
    <ItemGroup>
      <ImportProject>
        <!-- use Build target for Debug config or .NET Framework -->
        <_UseBuildTarget>false</_UseBuildTarget>
      </ImportProject>
      <ImportProject>
        <_UseBuildTarget Condition="$(IsDebug) Or '%(TargetFramework)' == '$(FullTargetFramework)'">true</_UseBuildTarget>
      </ImportProject>
      <ImportProject>
        <Targets>Publish</Targets>
        <Targets Condition="%(_UseBuildTarget)">Build</Targets>
      </ImportProject>
      <ImportProject>
        <!-- force 'dotnet build' instead of 'msbuild' usage -->
        <RuntimeType>Core</RuntimeType>
      </ImportProject>

      <ImportProject RemoveMetadata="_UseBuildTarget" />
    </ItemGroup>

    <!--<LogItems Items="@(ImportProject)" Title="RedistUpdateTarget.ImportProject" />-->
  </Target>

  <Target Name="TraceRedistTargets">
    <Message Importance="high" Text="Redist.targets" />
    <Message Importance="high" Text="--------------" />
    <Message Importance="high" Text="ProjectPath           = $(ProjectPath)" />
    <Message Importance="high" Text="Configuration         = $(Configuration)" />
    <Message Importance="high" Text="OutDir                = $(OutDir)" />
    <Message Importance="high" Text="RuntimePlatform       = $(RuntimePlatform)" />
    <Message Importance="high" Text="RuntimeIdentifier     = $(RuntimeIdentifier)" />
    <Message Importance="high" Text=" " />
    <Message Importance="high" Text="RedistBuildPropsPath  = $(RedistBuildPropsPath)" />
    <Message Importance="high" Text="RedistFolder          = $(RedistFolder)" />
    <Message Importance="high" Text="RedistWinX86Framework = $(RedistWinX86Framework)" />
    <Message Importance="high" Text="RedistWinX64Framework = $(RedistWinX64Framework)" />
    <Message Importance="high" Text="RedistProjectPath     = $(RedistProjectPath)" />
    <Message Importance="high" Text=" " />

    <LogItems Items="@(ImportProject)" Title="TraceRedistTargets.ImportProject" />
    <Message Importance="high" Text=" " />
  </Target>

</Project>
