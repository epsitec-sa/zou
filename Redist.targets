<!--
Import this script at the end of a C# redist agent

This script imports a chain of 'zou.build.props' in which we can define
properties to control the 'Redist.targets' build settings.

    RedistProjectPath  - [required] - the path of the project script                         - ex: Net\Swissdec.Transmitter.Host\Swissdec.Transmitter.Host.csproj
                                      relative to the 'zou.build.props' directory
    RedistFolder       - [optional] - append a component folder to the output directory      - ex: bin\Release\win-x64\<redist-folder>
    RedistByFramework  - [optional] - include the target framework   in the output directory - ex: bin\Release\net6[\win-x64]\<redist-folder>
    RedistByRuntime    - [optional] - include the runtime identifier in the output directory - ex: bin\Release\[net6\]win-x64\<redist-folder>
    RedistX86Framework - [optional] - the target framework used for x86 or AnyCPU platforms  - (CoreTargetFramework | FullTargetFramework)
    RedistX64Framework - [optional] - the target framework used for x64 platform             - (CoreTargetFramework | FullTargetFramework)
-->
<Project InitialTargets="TraceRedistTargets" TreatAsLocalProperty="RedistByRuntime">

  <!-- Defaults-->
  <PropertyGroup>
    <RedistByFramework  Condition="'$(RedistByFramework)'  == ''">false</RedistByFramework>
  </PropertyGroup>

  <!-- Append or not the runtime identifier to the output directory -->
  <PropertyGroup>
    <!--
      if CrossBuild                           # need to classify multiple outputs
        RedistByRuntime = true
      elsif OutDir.Contains(RuntimePlatform)  # no need to classify output
        RedistByRuntime = false
       else
        RedistByRuntime = true
       endif
     -->
    <RedistByRuntime Condition="'$(RedistByRuntime)' == '' And $(CrossBuild)">true</RedistByRuntime>
    <RedistByRuntime Condition="'$(RedistByRuntime)' == '' And '$(RuntimePlatform)' != '' And $(OutDir.Contains('$(RuntimePlatform)'))">false</RedistByRuntime>
    <RedistByRuntime Condition="'$(RedistByRuntime)' == '' And '$(RuntimePlatform)' == 'x86' And $(OutDir.Contains('Win32'))">false</RedistByRuntime>
    <RedistByRuntime Condition="'$(RedistByRuntime)' == ''">true</RedistByRuntime>
  </PropertyGroup>

  <Import Project="hook.zou.build.targets" Condition="'$(ZouBuildTargets)' == ''" />

  <Target Name="RedistInit" DependsOnTargets="ImportProjectInitCrossBuild" >
    <Message Condition="'$(ZouDebug)' == 'true'" Importance="high" Text="### [$(MSBuildProjectFile)] RedistInit" />
    <ItemGroup>
      <!-- Setup defaults -->
      <ImportProject>
        <RedistFolder       Condition="'%(ImportProject.RedistFolder)'       == ''">$(RedistFolder)</RedistFolder>
        <!--<RedistX86Framework Condition="'%(ImportProject.RedistX86Framework)' == ''">$(CoreTargetFramework)</RedistX86Framework>
        <RedistX64Framework Condition="'%(ImportProject.RedistX64Framework)' == ''">$(CoreTargetFramework)</RedistX64Framework>-->
        <TargetFramework    Condition="'%(Extension)' == '.csproj'">$(CoreTargetFramework)</TargetFramework>
        
        <RuntimeType    >Core</RuntimeType>
        <RuntimeFolder  >%(RuntimeOS)-$(RuntimePlatform)</RuntimeFolder>
      </ImportProject>
        
      <ImportProject>
        <OutDir    >$(OutDir)%(RuntimeFolder)</OutDir>
        <PublishDir>$(OutDir)%(RuntimeFolder)</PublishDir>
      </ImportProject>
      
      <!-- Adjust RuntimeType and TargetFramework for Windows -->
      <ImportProject Condition="'%(RuntimeOS)' == 'win'">
        <!-- Use 'msbuild' for .sln and .vcxproj -->
        <RuntimeType Condition="'%(Extension)' == '.sln' Or '%(Extension)' == '.vcxproj'">Full</RuntimeType>
        <!-- Use 'dotnet build' for .csproj -->
        <RuntimeType Condition="'%(Extension)' == '.csproj'">Core</RuntimeType>
      </ImportProject>
      
      <!-- x86|AnyCPU -->
      <ImportProject Condition="'$(RuntimePlatform)' == 'x86' Or '$(RuntimePlatform)' == 'AnyCPU'">
        <TargetFramework Condition="'%(ImportProject.RedistX86Framework)' != ''">%(ImportProject.RedistX86Framework)</TargetFramework>
      </ImportProject>
      <!-- x64 -->
      <ImportProject Condition="'$(RuntimePlatform)' == 'x64'">
        <TargetFramework Condition="'%(ImportProject.RedistX64Framework)' != ''">%(ImportProject.RedistX64Framework)</TargetFramework>
      </ImportProject>

      <!-- Set defaults for non C# projects -->
      <!--<ImportProject Condition="'$(MSBuildProjectExtension)' != '.csproj'">
        <Targets Condition="'%(ImportProject.Targets)' == ''">Build</Targets>
        <TargetFramework />
      </ImportProject>-->
    </ItemGroup>
  </Target>

  <!--
  Transform ImportProject.(Out|Publish)Dir metadata from redist to monolith layout

    - standard: $(OutDir)<project-folder>\$(RuntimeIdentifier)
    - monolith: $(OutDir)$(RuntimeIdentifier)\$(RedistFolder)

    Inputs:
      PropertyGroup
        $(OutDir)       - ex: C:\devel\cresus-dev\cresus\bin\Release\
        $(RedistFolder) - ex: user\modules\cresus
      ItemGroup.ImportProject (redist layout)
        %(OutDir)       - ex: C:\devel\cresus-dev\cresus\bin\Release\xlsgen\win-x64
        %(PublishDir)   - ex: C:\devel\cresus-dev\cresus\bin\Release\xlsgen\win-x64
    Outputs:
      ItemGroup.ImportProject (monolith layout)
        %(OutDir)       - ex: C:\devel\cresus-dev\cresus\bin\Release\win-x64\user\modules\cresus\xlsgen\
        %(PublishDir)   - ex: C:\devel\cresus-dev\cresus\bin\Release\win-x64\user\modules\cresus\xlsgen\
        %(AsmDir)       - ex: C:\devel\cresus-dev\cresus\bin\Release\win-x64\user\modules\cresus\[<c++>\].cod\
  -->
  <Target Name="RedistTransformLayout" DependsOnTargets="RedistInit">
    <Message Condition="'$(ZouDebug)' == 'true'" Importance="high" Text="### [$(MSBuildProjectFile)] RedistTransformLayout" />
    <ItemGroup>
      <!-- Process C# output directories -->
      <ImportProject>
        <_OutputFolder Condition="! $(RedistByRuntime)">%(ImportProject.RedistFolder)</_OutputFolder>
        <_OutputFolder Condition="  $(RedistByRuntime)">$([System.IO.Path]::Combine('%(ImportProject.RuntimeFolder)', '%(ImportProject.RedistFolder)'))</_OutputFolder>
      </ImportProject>
      <ImportProject>
        <_OutputFolder Condition="$(RedistByFramework)">$([System.IO.Path]::Combine('%(ImportProject.TargetFramework)', '%(ImportProject._OutputFolder)'))</_OutputFolder>
      </ImportProject>
      <ImportProject>
        <_OutputFolder>$([MSBuild]::EnsureTrailingSlash('%(ImportProject._OutputFolder)'))</_OutputFolder>
      </ImportProject>

      <ImportProject>
        <OutDir     Condition="'%(ImportProject.OutDir)'     != ''">$([System.IO.Path]::GetFullPath('$(OutDir)%(_OutputFolder)'))</OutDir>
        <PublishDir Condition="'%(ImportProject.PublishDir)' != ''">$([System.IO.Path]::GetFullPath('$(OutDir)%(_OutputFolder)'))</PublishDir>
      </ImportProject>
      <ImportProject>
        <AsmDir Condition="'%(ImportProject.OutDir)' != '' And $([System.String]::new('%(ImportProject.Identity)').EndsWith('.vcxproj'))">%(OutDir).cod\</AsmDir>
      </ImportProject>

      <!-- Remove temporary metadata -->
      <ImportProject RemoveMetadata="_OutputFolder" />
    </ItemGroup>
  </Target>

  <Target Name="RedistUpdateTarget" DependsOnTargets="RedistTransformLayout;RedistInit" BeforeTargets="CreateMSBuildProjects">
    <Message Condition="'$(ZouDebug)' == 'true'" Importance="high" Text="### [$(MSBuildProjectFile)] RedistUpdateTarget" />
    <ItemGroup>
      <ImportProject>
        <!-- use Build target for Debug config or .NET Framework -->
        <_UseBuildTarget>false</_UseBuildTarget>
      </ImportProject>
      <ImportProject>
        <_UseBuildTarget Condition="$(Configuration.StartsWith('Debug', StringComparison.OrdinalIgnoreCase)) Or '%(ImportProject.TargetFramework)' == '' Or '%(ImportProject.TargetFramework)' == '$(FullTargetFramework)'">true</_UseBuildTarget>
      </ImportProject>
      <ImportProject>
        <Targets Condition="'%(ImportProject.Targets)' == ''">Publish</Targets>
        <Targets Condition="'%(ImportProject.Targets)' == '' And %(_UseBuildTarget)">Build</Targets>
      </ImportProject>
      <ImportProject>
        <OutDir     Condition="! %(_UseBuildTarget)" />
        <PublishDir Condition="  %(_UseBuildTarget)" />
      </ImportProject>

      <!-- Remove temporary metadata -->
      <ImportProject RemoveMetadata="_UseBuildTarget" />
    </ItemGroup>

    <LogItems Condition="$(RedistDebug)" Items="@(ImportProject)" Title="RedistUpdateTarget.ImportProject" />
    <Message  Condition="$(RedistDebug)" Importance="high" Text=" " />
  </Target>

  <Target Name="TraceRedistTargets" Condition="$(RedistDebug) Or '$(MSBuildProjectFile)' == '$(MSBuildThisFile)'"
          BeforeTargets="CreateMSBuildProjects" AfterTargets="RedistUpdateTarget">
    <Message Importance="high" Text="zou/Redist.targets [$(MSBuildProjectFile)]" />
    <Message Importance="high" Text="------------------" />
    <Message Importance="high" Text="ZouBuildProps      = $(ZouBuildProps)" />
    <Message Importance="high" Text="ZouBuildTargets    = $(ZouBuildTargets)" />
    <Message Importance="high" Text="CrossBuild         = $(CrossBuild)" />
    <Message Importance="high" Text="BuildWin           = $(BuildWin)" />
    <Message Importance="high" Text="BuildOsx           = $(BuildOsx)" />
    <Message Importance="high" Text="BuildLinux         = $(BuildLinux)" />
    <Message Importance="high" Text=" " />
    <Message Importance="high" Text="Configuration      = $(Configuration)" />
    <Message Importance="high" Text="Platform           = $(Platform)" />
    <Message Importance="high" Text="RuntimePlatform    = $(RuntimePlatform)" />
    <Message Importance="high" Text="$RuntimeIdentifier = $(RuntimeIdentifier)" Condition="'$(RuntimeIdentifier)' != ''" />
    <Message Importance="high" Text="@RuntimeIdentifier = %(RuntimeIdentifier.Identity)" />
    <Message Importance="high" Text="RedistFolder       = $(RedistFolder)" />
    <Message Importance="high" Text="OutDir             = $(OutDir)" />
    <Message Importance="high" Text="PublishDir         = $(PublishDir)" Condition="'$(PublishDir)' != ''" />
    <Message Importance="high" Text=" " />
    <Message Importance="high" Text="RedistByRuntime    = $(RedistByRuntime)" />
    <Message Importance="high" Text="RedistByFramework  = $(RedistByFramework)" />
    <Message Importance="high" Text=" " />

    <LogItems Condition="$(RedistDebug)" Items="@(ImportProject)" Title="RedistUpdateTarget.ImportProject" />
    <Message  Condition="$(RedistDebug)" Importance="high" Text=" " />
  </Target>

</Project>
