<?xml version="1.0" encoding="utf-8"?>
<!--
The ImportProjects.targets can be used to build and import the output of one or many projects or solutions.
Input parameters:
- @(ImportProjects)
  - %(BuildInParallel)
  - %(ImportDir)
  - %(ImportPlatform)
  - %(ImportConfiguration)
  - %(ImportNTVersion)
-->
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Condition="'$(Zou)' == ''" Project="zou.props" />

  <!-- Define imported projects default metadata -->
  <ItemDefinitionGroup>
    <ImportProjects>
      <BuildInParallel>true</BuildInParallel>
      <!-- TargetDir is the absolute version of OutDir -->
      <ImportDir>$(TargetDir)</ImportDir>
      <ImportPlatform>$(Platform)</ImportPlatform>
      <ImportPlatformToolset>$(PlatformToolset)</ImportPlatformToolset>
      <ImportConfiguration>$(Configuration)</ImportConfiguration>
      <ImportNTVersion>$(NTVersion)</ImportNTVersion>
    </ImportProjects>
  </ItemDefinitionGroup>

  <!-- ================ ImportProjectsClean ================ -->
  
  <Target Name="ImportProjectsClean" BeforeTargets="Clean" Condition="'@(ImportProjects)' != ''">
    <!-- The clean target does not care about project dependencies. This means that we can safely use the MSBuild task for solutions too. -->
    <MSBuild Projects="@(ImportProjects)" Targets="Clean" Properties="OutDir=%(ImportDir);Configuration=%(ImportConfiguration);Platform=%(ImportPlatform);PlatformToolset=%(ImportPlatformToolset);NTVersion=%(ImportNTVersion)" />
  </Target>

  <!-- ================ ImportProjects ================ -->

  <!-- Runs the _PrepareForClean target (which deletes the calling-project.lastbuildstate) so that Visual Studio always runs this target. -->
  <Target Name="ImportProjects"
          DependsOnTargets="_PrepareForClean"
          BeforeTargets="Build"
          Condition="'@(ImportProjects)' != ''">
    <Message Text="[%(ImportConfiguration)|%(ImportPlatform)|%(ImportPlatformToolset)|%(ImportNTVersion)] %(ImportProjects.Identity) =&gt; %(ImportDir)" />
    <Message Text="%0A" />
    <!-- Restore nuget packages for solutions... -->
    <Exec
      Command="&quot;$(ZouDir)nuget&quot; restore &quot;%(ImportProjects.Identity)&quot;"
      Condition="'%(Extension)' == '.sln'"/>
    <!-- ...and projects -->
    <!--<Message
      Text="&quot;$(ZouDir)nuget&quot; restore &quot;%(ImportProjects.RootDir)%(Directory)packages.config&quot; -PackagesDirectory &quot;$(SolutionDir)packages\.&quot;"
      Condition="'%(Extension)' != '.sln' And Exists('%(RootDir)%(Directory)packages.config')"/>-->
    <Exec
      Command="&quot;$(ZouDir)nuget&quot; restore &quot;%(ImportProjects.RootDir)%(Directory)packages.config&quot; -PackagesDirectory &quot;$(SolutionDir)packages\.&quot;"
      Condition="'%(Extension)' != '.sln' And Exists('%(RootDir)%(Directory)packages.config')"/>
    
    <!--
	  The MSBuild task does not determine the build order but MSBuild.exe and Visual Studio do:
    https://maximelabelle.wordpress.com/2011/11/29/building-multiple-projects-in-order-with-msbuild/
    We cannot use the following MSBuild task:
        <MSBuild Projects="%(ImportProjects.Identity)" Targets="Build" Properties="OutDir=%(ImportDir);Configuration=%(ImportConfiguration);Platform=%(ImportPlatform) " />
    Instead with use the Exec task which starts the MSBuild process.
	  -->
    
    <!-- Build solutions... -->
    <Exec
      Condition="'%(Extension)' == '.sln'"
      Command="&quot;$(MSBuildToolsPath)\msbuild&quot; /nologo /v:m /t:Build &quot;/p:OutDir=%(ImportDir);Configuration=%(ImportConfiguration);Platform=%(ImportPlatform);PlatformToolset=%(ImportPlatformToolset);NTVersion=%(ImportNTVersion);BuildInParallel=%(BuildInParallel)&quot; &quot;%(ImportProjects.Identity)&quot;" />
    <!-- ...and projects -->
    <MSBuild
      Condition="'%(Extension)' != '.sln'"
      Projects="%(ImportProjects.Identity)"
      Targets="Build"
      Properties="OutDir=%(ImportDir);Configuration=%(ImportConfiguration);Platform=%(ImportPlatform);PlatformToolset=%(ImportPlatformToolset);NTVersion=%(ImportNTVersion)"
      BuildInParallel="%(BuildInParallel)" />
  </Target>
</Project>