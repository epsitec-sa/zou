<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003"
         InitialTargets="TraceToolsCpp;InitVSInstallDir">

  <!--
  Compute Visual Studio installation directory based on MSBuild property VCTargetsPath
  Example:
    VCTargetsPath = C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\MSBuild\Microsoft\VC\v160\
    VSRootDir     = C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\
    VSToolsDir    = C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\Common7\Tools\
  -->
  <PropertyGroup>
    <!-- VSRootDir -->
    <_VCTargetsPathMSBuildIndex>$(VCTargetsPath.IndexOf('MSBuild'))</_VCTargetsPathMSBuildIndex>
    <VSRootDir>$(VCTargetsPath.Substring(0, $(_VCTargetsPathMSBuildIndex)))</VSRootDir>
    <_VCTargetsPathMSBuildIndex />
    
    <VSInstallDir Condition="'$(VSInstallDir)' == ''">*Undefined*</VSInstallDir>
    <VSToolsDir   Condition="'$(VSToolsDir)'   == ''">$(VSRootDir)Common7\Tools\</VSToolsDir>
    <MSVCRootDir  Condition="'$(MSVCRootDir)'  == ''">$(VSRootDir)VC\Tools\MSVC\</MSVCRootDir>
  </PropertyGroup>
 
  <!--
    This is the standard way to find VS installation path. Unfortunately we cannot use it during the 1st pass of msbuild
    because targets are executed during the 2nd pass and some scripts need VSInstallDir / VSRootDir during the 1st pass
  -->
  <Target Name="InitVSInstallDir">
    <PropertyGroup>
      <VsWherePath>$(MSBuildProgramFiles32)\Microsoft Visual Studio\Installer\vswhere.exe</VsWherePath>
    </PropertyGroup>
    <Exec Command='"$(VsWherePath)" -prerelease -latest -property InstallationPath'
          Condition="Exists('$(VsWherePath)')"
          EchoOFF="true"
          StandardOutputImportance="low"
          ConsoleToMSBuild="true">
      <Output TaskParameter="ConsoleOutput" PropertyName="_VSInstallDir" />
    </Exec>
    <PropertyGroup>
      <VSInstallDir Condition="'$(_VSInstallDir)' != '' And Exists('$(_VSInstallDir)')">$([MSBuild]::EnsureTrailingSlash('$(_VSInstallDir)'))</VSInstallDir>
      <_VSInstallDir />
    </PropertyGroup>
    
    <Error Condition="'$(VSRootDir)'  == ''" Text="VS not found" />
    <Error Condition="'$(VSToolsDir)' == ''" Text="VS Build Tools not found" />
    <Error Condition="'$(VSInstallDir)' != '*Undefined*' And '$(VSRootDir)' != '$(VSInstallDir)'" Text="Mismatch between VSInstallDir and VSRootDir" />
  </Target>
  
  <Target Name="TraceToolsCppRT" DependsOnTargets="InitVSInstallDir">
    <Message Importance="normal" Text="Runtime properties" />
    <Message Importance="normal" Text="==================" />
    <Message Importance="normal" Text="  + VSInstallDir = $(VSInstallDir)" />
  </Target>

  <Target Name="TraceToolsCpp" Condition="'$(ZouTrace)' == 'true' Or '$(MSBuildProjectFile)' == '$(MSBuildThisFile)'">
    <Message Importance="normal" Text="Boot properties" />
    <Message Importance="normal" Text="===============" />
    <Message Importance="normal" Text="  + VSRootDir     = $(VSRootDir)" />
    <Message Importance="normal" Text="  + VSToolsDir    = $(VSToolsDir)" />
    <Message Importance="normal" Text="  * VCTargetsPath = $(VCTargetsPath)" />
    <Message Importance="normal" Text="  + MSVCRootDir   = $(MSVCRootDir)" />

    <CallTarget Targets="TraceToolsCppRT" />
  </Target>
</Project>
