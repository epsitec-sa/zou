<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003"
         InitialTargets="TraceToolsMfc;InitMFCIncludeDir">

  <Import Project="Tools.Cpp.props"  Condition="'$(VSRootDir)'  == ''" />

  <PropertyGroup>
    <MFCIncludeDir Condition="'$(MFCIncludeDir)' == ''">*Undefined*</MFCIncludeDir>
  </PropertyGroup>
  
  <!-- MFCIncludeDir should be used in targets only -->
  <Target Name="InitMFCIncludeDir" Condition="'$(MFCIncludeDir)' == '*Undefined*'">
    <!-- List folders alphabetically -->
    <Exec Command='dir /B /AD /ON "$(MSVCRootDir)"'
          StandardOutputImportance="low"
          EchoOFF="true"
          ConsoleToMSBuild="true">
      <Output TaskParameter="ConsoleOutput" PropertyName="MSVCVersion" />
    </Exec>
    <!-- Keep only folders with a name that matches a version format -->
    <ItemGroup>
      <_MSVCVersion Include="$(MSVCVersion)" />
      <MSVCVersion Include="%(_MSVCVersion.Identity)" Condition="$([System.Text.RegularExpressions.Regex]::Match('%(Identity)', '^\d+\.\d+\.\d+$')) != ''"/>
      <_MSVCVersion Remove="@(_MSVCVersion)" />
    </ItemGroup>
    
    <PropertyGroup>
      <!-- Get the highest version (the highest version is the last item because folders are listed alphabetically - dir /ON) -->
      <MSVCVersion>%(MSVCVersion.Identity)</MSVCVersion>
      <!-- Initialize MFCIncludeDir if folder exists -->
      <_MFCIncludeDir>$(MSVCRootDir)$(MSVCVersion)\atlmfc\include\</_MFCIncludeDir>
      <MFCIncludeDir Condition="Exists('$(_MFCIncludeDir)')">$(_MFCIncludeDir)</MFCIncludeDir>
      <_MFCIncludeDir />
    </PropertyGroup>
    
    <!-- Clean -->
    <ItemGroup>
      <MSVCVersion Remove="@(MSVCVersion)" />
    </ItemGroup>

    <Error Condition="'$(MFCIncludeDir)' == '*Undefined*'" Text="MFC Include dir not found, please specify the 'MSVCVersion' property manually (ex: set MSVCVersion=14.29.30037)" />
  </Target>

  <Target Name="TraceToolsMfcRT" DependsOnTargets="InitMFCIncludeDir">
    <Message Importance="normal" Text="Runtime properties" />
    <Message Importance="normal" Text="==================" />
    <Message Importance="normal" Text="  MSVCVersion   = $(MSVCVersion)"/>
    <Message Importance="normal" Text="  MFCIncludeDir = $(MFCIncludeDir)"/>
  </Target>

  <Target Name="TraceToolsMfc" Condition="'$(ZouTrace)' == 'true' Or '$(MSBuildProjectFile)' == '$(MSBuildThisFile)'">
    <Message Importance="normal" Text="Boot properties" />
    <Message Importance="normal" Text="===============" />
    <Message Importance="normal" Text="  MFCIncludeDir = $(MFCIncludeDir)"/>
    
    <CallTarget Targets="TraceToolsMfcRT" />
  </Target>
</Project>
