<!--
By default '.xml' and '.manifest' files are excluded from bin.
To keep them add the following code in the project.pack.msbuildproj:

  <Target Name="PackFilter">
    <ItemGroup>
      <ProdBinExclude Remove="$(OutDir)**\*.xml" />
      <ProdBinExclude Remove="$(OutDir)**\*.manifest" />
    </ItemGroup>
  </Target>
-->
<Project DefaultTargets="PackBuild">

  <PropertyGroup>
    <ForwardOutDir Condition="'$(ForwardOutDir)' == ''">$(OutDir)</ForwardOutDir>
  </PropertyGroup>

  <Import Project="Import.targets" />

  <Target Name="PackCreateDefault">
    <!-- Default includes and excludes -->
    <ItemGroup>
      <ProdBinInclude Include="$(OutDir)**\*" />
      <ProdBinExclude Include="$(OutDir)**\*.pdb" />
      <ProdBinExclude Include="$(OutDir)**\*.map" Exclude="$(OutDir)**\node_modules\**\*.map"/>
      <ProdBinExclude Include="$(OutDir)**\*.lib" />
      <ProdBinExclude Include="$(OutDir)**\*.exp" />
      <ProdBinExclude Include="$(OutDir)**\*.bsc" />
      <ProdBinExclude Include="$(OutDir)**\*.ilk" />
      <ProdBinExclude Include="$(OutDir)**\*.cod" />
      <ProdBinExclude Include="$(OutDir)**\*.xml" />
      <ProdBinExclude Include="$(OutDir)**\*.manifest" />
      <!-- Exclude Visual Leak Detector in release mode -->
      <ProdBinExclude Include="$(OutDir)vld_x86.dll" Condition="'$(Configuration)'=='Release' And Exists('$(OutDir)vld_x86.dll')" />
      <ProdBinExclude Include="$(OutDir)vld.ini"     Condition="'$(Configuration)'=='Release' And Exists('$(OutDir)vld.ini')" />
    </ItemGroup>
  </Target>

  <Target Name="PackCreate" DependsOnTargets="PackCreateDefault;PackFilter">
    <!-- Dispatch package content to respective folders -->
    <ItemGroup>
      <PackCopyFile Include="@(ProdBinInclude)" Exclude="@(ProdBinExclude)" Condition="'$(OutDir)' != '$(PkgBinDir)'">
        <ImportDir>$(PkgBinDir)</ImportDir>
      </PackCopyFile>
      <PackCopyFile Include="@(ProdBinExclude)" Condition="'$(OutDir)' != '$(PkgDbgDir)'">
        <ImportDir>$(PkgDbgDir)</ImportDir>
      </PackCopyFile>
      <PackDeleteFile Include="@(ProdBinExclude)" Condition="'$(OutDir)' == '$(PkgBinDir)' And '$(OutDir)' != '$(PkgDbgDir)'" />
    </ItemGroup>
    
    <ItemGroup>
      <PackCopyFile>
        <BundleRelativeSrcDir>$([MSBuild]::MakeRelative('$(BundleDir)', '%(RootDir)%(Directory)'))</BundleRelativeSrcDir>
        <BundleRelativeDstDir>$([MSBuild]::MakeRelative('$(BundleDir)', '%(ImportDir)'))</BundleRelativeDstDir>
      </PackCopyFile>
    </ItemGroup>
    <!--<LogItems Items="@(ProdBinExclude)" Title="PackCreate.ProdBinExclude" />
    <Message Importance="high"  Text=" " />-->
  </Target>

  <Target Name="PackDeleteAll" DependsOnTargets="PackCreate">
    <Delete  Files="@(PackCopyFile->'%(ImportDir)%(RecursiveDir)%(FileName)%(Extension)')" />

    <!-- Display deleted files by extension  -->
    <ItemGroup>
      <_Message Include="@(PackCopyFile->'[-] %(ImportDir)%(RecursiveDir)*%(Extension)')" />
    </ItemGroup>
    <RemoveDuplicates Inputs="@(_Message)">
      <Output TaskParameter="Filtered" ItemName="_Message"/>
    </RemoveDuplicates>
    <Message Importance="high" Text="%(_Message.Identity)" />
    <ItemGroup>
      <_Message Remove="@(_Message')" />
    </ItemGroup>
  </Target>

  <Target Name="PackCopy" DependsOnTargets="PackCreate" Inputs="@(PackCopyFile)" Outputs="@(PackCopyFile->'%(ImportDir)%(RecursiveDir)%(FileName)%(Extension)')">
    <Message Condition="'$(ZouDebug)' == 'true'" Importance="high" Text="### [$(MSBuildProjectFile)] PackCopy" />
    <CallTarget Targets="_DeleteLastBuildState" Condition="'$(BuildingInsideVisualStudio)'=='true'" />
    <Copy SourceFiles="@(PackCopyFile)" DestinationFiles="@(PackCopyFile->'%(ImportDir)%(RecursiveDir)%(FileName)%(Extension)')" />

    <!-- Display file transfer by extension  -->
    <ItemGroup>
      <_Message Include="@(PackCopyFile->'[Pack] %(BundleRelativeSrcDir)*%(Extension) -> %(BundleRelativeDstDir)%(RecursiveDir)*%(Extension)')" />
    </ItemGroup>
    <RemoveDuplicates Inputs="@(_Message)">
      <Output TaskParameter="Filtered" ItemName="_Message"/>
    </RemoveDuplicates>
    <Message Importance="high" Text="%(_Message.Identity)" />
    <ItemGroup>
      <_Message Remove="@(_Message')" />
    </ItemGroup>
  </Target>

  <Target Name="PackBuild" AfterTargets="Build"  DependsOnTargets="ImportProject;PackCopy">
    <Message Condition="'$(ZouDebug)' == 'true'" Importance="high" Text="### [$(MSBuildProjectFile)] PackBuild" />
    <Delete Files="@(PackDeleteFile)" />
  </Target>

  <Target Name="PackClean" BeforeTargets="Clean" DependsOnTargets="PackDeleteAll;ImportProjectClean" />
</Project>
