<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003" DefaultTargets="PackBuild">

  <PropertyGroup>
    <ForwardOutDir Condition="'$(ForwardOutDir)' == ''">$(OutDir)</ForwardOutDir>
  </PropertyGroup>

  <Target Name="PackCreateDefault">
    <!-- Default includes and excludes -->
    <ItemGroup>
      <ProdBinInclude Include="$(OutDir)**\*" />
      <ProdBinExclude Include="$(OutDir)**\*.pdb" />
      <ProdBinExclude Include="$(OutDir)**\*.map" />
      <ProdBinExclude Include="$(OutDir)**\*.lib" />
      <ProdBinExclude Include="$(OutDir)**\*.exp" />
      <ProdBinExclude Include="$(OutDir)**\*.bsc" />
      <ProdBinExclude Include="$(OutDir)**\*.ilk" />
      <!-- Exclude Visual Leak Detector in release mode -->
      <ProdBinExclude Include="$(OutDir)vld_x86.dll" Condition="'$(Configuration)'=='Release'" />
      <ProdBinExclude Include="$(OutDir)vld.ini"     Condition="'$(Configuration)'=='Release'" />

      <ProdDbgInclude Include="$(OutDir)**\*.pdb" />
      <ProdDbgInclude Include="$(OutDir)**\*.map" />
      <ProdDbgInclude Include="$(DbgDir)**\*.cod" Condition="'$(DbgDir)' != ''" />

      <DevBinInclude Include="$(OutDir)**\*" />
      <DevCodInclude Include="$(DbgDir)**\*.cod" Condition="'$(DbgDir)' != ''" />
    </ItemGroup>
  </Target>

  <Target Name="PackCreate" DependsOnTargets="PackCreateDefault;PackFilter">
    <!-- Dispatch package content to respective folders -->
    <ItemGroup>
      <!-- Production package -->
      <PackFile Include="@(ProdBinInclude)" Exclude="@(ProdBinExclude)">
        <ImportDir>$(PkgProdBinDir)</ImportDir>
      </PackFile>
      <PackFile Include="@(ProdDbgInclude)">
        <ImportDir>$(PkgProdDbgDir)</ImportDir>
      </PackFile>

      <!-- Developer package -->
      <PackFile Include="@(DevBinInclude)">
        <ImportDir>$(PkgDevBinDir)</ImportDir>
      </PackFile>
      <PackFile Include="@(DevCodInclude)">
        <ImportDir>$(PkgDevDbgDir)</ImportDir>
      </PackFile>
    </ItemGroup>
  </Target>

  <Target Name="PackImportClean"
          DependsOnTargets="PackCreate">
    
    <Delete  Files="%(PackFile.ImportDir)%(RecursiveDir)%(FileName)%(Extension)" />
    <Message Importance="high" Text="[-] %(PackFile.ImportDir)%(RecursiveDir)%(FileName)%(Extension)" Condition="'%(FileName)%(Extension)' != ''"/>
  </Target>
  
  <Target Name="PackImport"
          DependsOnTargets="_DeleteLastBuildState;PackCreate"
          Inputs="@(PackFile)"
          Outputs="%(PackFile.ImportDir)%(RecursiveDir)%(FileName)%(Extension)">
    
    <Message Importance="high" Text="[+] %(PackFile.Identity) =&gt; %(ImportDir)%(RecursiveDir)%(FileName)%(Extension)" />
    <Copy SourceFiles="@(PackFile)" DestinationFiles="%(ImportDir)%(RecursiveDir)%(FileName)%(Extension)"  />
  </Target>

  <Target Name="PackBuild" AfterTargets="Build"  DependsOnTargets="ImportProject;PackImport" />
  <Target Name="PackClean" BeforeTargets="Clean" DependsOnTargets="PackImportClean;ImportProjectClean" />

  <Import Project="ImportProject.targets" />
</Project>