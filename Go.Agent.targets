<Project>

  <ItemGroup>
    <GoBuild Include="$(GoWorkspace)**\*.go"  />
    <GoBuild Include="$(GoWorkspace)**\*.h" />
    <GoBuild Include="$(GoWorkspace)**\*.c" />
    <GoResource Include="$(GoResourceDir)**\*" />
  </ItemGroup>

  <Target Name="GoBuildVersionInfo" DependsOnTargets="GoGetTools" BeforeTargets="Build">
    <PropertyGroup>
      <GoVersionInfoFlags Condition="$(Platform.EndsWith('x64'))">-64</GoVersionInfoFlags>
      <GoVersionInfoFlags Condition="Exists('$(TargetFileName).$(Configuration).manifest')">$(GoVersionInfoFlags) -manifest="$(TargetFileName).$(Configuration).manifest"</GoVersionInfoFlags>
    </PropertyGroup>
    <Exec EnvironmentVariables="@(GoBuildEnv)" Command="goversioninfo $(GoVersionInfoFlags)" />
  </Target>

  <Target Name="Build" Inputs="@(GoBuild);@(GoResource)" Outputs="$(TargetPath)">
    <PropertyGroup>
      <GoBuildLDFlags Condition="'$(Subsystem)' == 'Windows'">-H windowsgui</GoBuildLDFlags>
      <GoBuildFlags Condition="'$(GoBuildLDFlags)' != ''">-ldflags "$(GoBuildLDFlags)"</GoBuildFlags>
    </PropertyGroup>
    
    <ItemGroup>
      <GoBuildCommand Include="go generate" />
    </ItemGroup>

    <Delete Files="$(TargetPath)" />
    <Exec WorkingDirectory="$(ProjectDir)" EnvironmentVariables="@(GoBuildEnv);TARGETPATH=$(TargetPath)" Command="%(GoBuildCommand.Identity)" />
  </Target>

  <Target Name="Clean">
    <Exec WorkingDirectory="$(ProjectDir)" Command="go clean" />
    <Delete Files="$(TargetPath)" />
  </Target>

</Project>