<!--
The Zip.targets can be used to zip folders.
Input parameters: $(ZipFolder)
-->
<Project>

  <!-- Zip source -->
  <Target Name="ZipSource">
    <PropertyGroup>
      <ZipPath>$(ProjectDir)$(ProjectName).zip</ZipPath>
    </PropertyGroup>
    <ItemGroup>
      <ZipFile Include="$(ProjectPath)"/>
      <ZipFile Include="@(Compile)" Exclude="$(IntermediateOutputPath)*.cs"/>
    </ItemGroup>

    <Message Text="Compressing source files into $(ZipPath)..." Importance="high" />
    <Zip Files="@(ZipFile)" FileName="$(ZipPath)" />
  </Target>

  <!-- Zip folder -->
  <Target Name="_InitZipFolder">
    <ItemGroup>
      <ZipFolder Include="$(ZipFolder)" />
      <ZipFolder>
        <ZipDir>$([System.String]::new('%(FullPath)').TrimEnd('\/'))</ZipDir>
      </ZipFolder>
      <ZipFolder>
        <ZipPath>%(ZipDir).zip</ZipPath>
      </ZipFolder>
    </ItemGroup>

    <LogItems Items="@(ZipFolder)" AllMetadata="true" />
  </Target>

  <Target Name="ZipFolderBuild" DependsOnTargets="_InitZipFolder" BeforeTargets="ResolveReferences" Outputs="%(ZipFolder.ZipPath)">
    <Warning Condition="!Exists('%(ZipFolder.ZipDir)')" Text="Folder %(ZipFolder.ZipDir) does not exists" />
    <MSBuild Condition="Exists('%(ZipFolder.ZipDir)')" Projects="$(MSBuildThisFileFullPath)" Targets="_ZipOneFolder" Properties="_ZipFolder=%(ZipFolder.ZipDir);_ZipPath=%(ZipFolder.ZipPath)" />
  </Target>

  <Target Name="ZipFolderClean" DependsOnTargets="_InitZipFolder" AfterTargets="Clean">
    <Message Condition="Exists('%(ZipFolder.ZipPath)')" Text="[-] %(ZipFolder.ZipPath)" Importance="high" />
    <Delete Files="@(ZipFolder->'%(ZipPath)')" ContinueOnError="true" />
  </Target>


  <!-- MSBuild subtask for one folder -->
  <Target Name="_InitZipOneFolder">
    <ItemGroup>
      <_ZipFile Include="$(_ZipFolder)/**/*.*" />
    </ItemGroup>
  </Target>

  <Target Name="_ZipOneFolder" DependsOnTargets="_InitZipOneFolder" Inputs="@(_ZipFile)" Outputs="$(_ZipPath)">
    <Message Text="[+] Compressing $(_ZipFolder) into $(_ZipPath)..." Importance="high" />
    <Zip Files="@(_ZipFile)" FileName="$(_ZipPath)" />
  </Target>

</Project>
