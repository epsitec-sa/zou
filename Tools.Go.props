<Project InitialTargets="ToolsGoTrace">

  <PropertyGroup>
    <GoWorkspace Condition="'$(GoWorkspace)' == ''">$(ModuleDir)src\</GoWorkspace>
    <GoWorkspace Condition="!Exists('$(GoWorkspace)')">$(ModuleDir)</GoWorkspace>
    <GoResourceDir Condition="'$(GoResourceDir)' == ''">$(ProjectDir)resources\</GoResourceDir>
    
    <GoBinDir>$([System.IO.Path]::Combine($(GOPATH),'bin'))</GoBinDir>
    
    <GoOS Condition="$([MSBuild]::IsOSPlatform(OSX))">darwin</GoOS>
    <GoOS Condition="$([MSBuild]::IsOSPlatform(Linux))">linux</GoOS>
    <GoOS Condition="'$(GoOS)' == ''">windows</GoOS>
    <GoArch Condition="'$(Platform)' == 'Win32' Or '$(Platform)' == 'x86'">386</GoArch>
    <GoArch Condition="'$(GoArch)' == ''">amd64</GoArch>
    <GoExecPath>$(GoBinDir);$(MSysPath);$(PATH)</GoExecPath>
    <GoExecPath>$(GoExecPath.Replace(';', '%3B'))</GoExecPath>
    
    <CGoEnabled Condition="'$(CGoEnabled)' == ''">1</CGoEnabled>
  </PropertyGroup>

  <ItemGroup>
    <GoBuildEnv Include="GOOS=$(GoOS)" />
    <GoBuildEnv Include="GOARCH=$(GoArch)" />
    <GoBuildEnv Include="CGO_ENABLED=$(CGoEnabled)" />
    <GoBuildEnv Include="CC=$(MSysGcc)" />
    <GoBuildEnv Include="PATH=$(GoExecPath)" />
  </ItemGroup>

  <Target Name="CheckGoEnv" BeforeTargets="Build">
    <Error Text="Go programming language not installed" Condition="'$(GOROOT)' == '' Or !$([System.IO.File]::Exists($(GOROOT)\bin\go.exe))" />
    <Error Text="GOPATH environment variable not set" Condition="'$(GOPATH)' == ''" />
  </Target>
  
  <!-- get some go tools -->
  <Target Name="GoGetRice" Condition="!Exists('$(GoBinDir)\rice.exe')" BeforeTargets="Build">
    <Exec Command="go get -u github.com/GeertJohan/go.rice/rice" />
  </Target>

  <Target Name="GoGetVersionInfo" Condition="!Exists('$(GoBinDir)\goversioninfo.exe')" BeforeTargets="Build">
    <Exec Command="go get -u github.com/josephspurrier/goversioninfo/cmd/goversioninfo" />
  </Target>

  <Target Name="GoGetSwag" Condition="!Exists('$(GoBinDir)\swag.exe')" BeforeTargets="Build">
    <Exec Command="go get -u github.com/swaggo/swag/cmd/swag" />
  </Target>

  <Target Name="GoGetTools" DependsOnTargets="GoGetRice;GoGetVersionInfo" />

  <Target Name="ToolsGoTrace" Condition="'$(ZouTraceProps)' == 'true'">
    <Message Importance="normal" Text="GoWorkspace   = $(GoWorkspace)" />
    <Message Importance="normal" Text="GoResourceDir = $(GoResourceDir)" />
    <Message Importance="normal" Text="GoBinDir      = $(GoBinDir)" />
    <Message Importance="normal" Text="GOROOT        = $(GOROOT)" />
    <Message Importance="normal" Text="GOPATH        = $(GOPATH)" />
    <Message Importance="normal" Text="GoOS          = $(GoOS)" />
    <Message Importance="normal" Text="GoArch        = $(GoArch)" />
    <Message Importance="normal" Text="CGoEnabled    = $(CGoEnabled)" />
    <Message Importance="normal" Text="GoBuildEnv    = %(GoBuildEnv.Identity)" />
  </Target>
</Project>