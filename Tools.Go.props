<Project InitialTargets="CheckGoEnv;ToolsGoTrace">

  <Import Project="zou.props" Condition="'$(V)' == ''" />

  <Choose>
    <When Condition="$([MSBuild]::IsOSPlatform(Windows))">
      <PropertyGroup>
        <GOPATH Condition="'$(GOPATH)' == ''">$(USERPROFILE)$(V)go</GOPATH>
        <GoOS   Condition="'$(GoOS)'   == ''">windows</GoOS>
      </PropertyGroup>
    </When>
    <When Condition="$([MSBuild]::IsOSPlatform(OSX))">
      <PropertyGroup>
        <GOPATH Condition="'$(GOPATH)' == ''">$(HOME)$(V)go</GOPATH>
        <GoOS   Condition="'$(GoOS)'   == ''">darwin</GoOS>
      </PropertyGroup>
    </When>
    <When Condition="$([MSBuild]::IsOSPlatform(Linux))">
      <PropertyGroup>
        <GOPATH Condition="'$(GOPATH)' == ''">$(HOME)$(V)go</GOPATH>
        <GoOS   Condition="'$(GoOS)'   == ''">linux</GoOS>
      </PropertyGroup>
    </When>
  </Choose>

  <PropertyGroup>
    <ForceGoGet Condition="'$(ForceGoGet)' == ''">false</ForceGoGet>

    <GoBinDir>$([System.IO.Path]::Combine($(GOPATH),'bin'))</GoBinDir>

    <GoWorkspace Condition="'$(GoWorkspace)' == ''">$(ModuleDir)src$(V)</GoWorkspace>
    <GoWorkspace Condition="!Exists('$(GoWorkspace)')">$(ModuleDir)</GoWorkspace>
    <GoResourceDir Condition="'$(GoResourceDir)' == ''">$(ProjectDir)resources$(V)</GoResourceDir>
    
    
    <GoArch Condition="'$(Platform)' == 'Win32' Or '$(Platform)' == 'x86'">386</GoArch>
    <GoArch Condition="'$(GoArch)' == ''">amd64</GoArch>
    <GoEnvPath>$(GoBinDir);$(PATH)</GoEnvPath>
    <GoEnvPath>$(GoEnvPath.Replace(';', '%3B'))</GoEnvPath>
  </PropertyGroup>
  
  <Choose>
    <When Condition="$([MSBuild]::IsOSPlatform(Windows))">
      <PropertyGroup>
        <GoRicePath>$([System.IO.Path]::GetFullPath('$(GoBinDir)\rice.exe'))</GoRicePath>
        <GoVerInfoPath>$([System.IO.Path]::GetFullPath('$(GoBinDir)\goversioninfo.exe'))</GoVerInfoPath>
        <GoSwagPath>$([System.IO.Path]::GetFullPath('$(GoBinDir)\swag.exe'))</GoSwagPath>
      </PropertyGroup>
    </When>
    <Otherwise>
      <PropertyGroup>
        <GoRicePath>$([System.IO.Path]::GetFullPath('$(GoBinDir)\rice'))</GoRicePath>
        <GoVerInfoPath>$([System.IO.Path]::GetFullPath('$(GoBinDir)\goversioninfo'))</GoVerInfoPath>
        <GoSwagPath>$([System.IO.Path]::GetFullPath('$(GoBinDir)\swag'))</GoSwagPath>
      </PropertyGroup>
    </Otherwise>
  </Choose>

  <ItemGroup>
    <GoBuildEnv Include="GOOS=$(GoOS)" />
    <GoBuildEnv Include="GOARCH=$(GoArch)" />
    <GoBuildEnv Include="PATH=$(GoEnvPath)" />
  </ItemGroup>

  <Target Name='CheckGoEnv'>
    <PropertyGroup>
      <WhereCommand Condition="$([MSBuild]::IsOSPlatform(Windows))">where</WhereCommand>
      <WhereCommand Condition="'$(WhereCommand)' == ''">which</WhereCommand>
    </PropertyGroup>
    <Exec Command="$(WhereCommand) go"
          EchoOFF="true"
          ConsoleToMSBuild="true"
          StandardOutputImportance='low'
          StandardErrorImportance='low'
          IgnoreExitCode='true'>
      <Output TaskParameter="ExitCode" PropertyName="WhereGoExitCode" />
      <Output TaskParameter="ConsoleOutput" PropertyName="GoExePath" />
    </Exec>
    <PropertyGroup>
      <GOROOT Condition="'$(GOROOT)' == ''">$([System.IO.Path]::GetFullPath('$(GoExePath)..\..\..'))</GOROOT>
    </PropertyGroup>
    <!--<Message Importance="high" Text="WhereGoExitCode = $(WhereGoExitCode)" />
    <Message Importance="high" Text="GOROOT          = $(GOROOT)" />-->
    <Error Condition="'$(WhereGoExitCode)' != '0'" Text="The 'go' command was not found. Please install or add it to the path."  />
  </Target>

  <!-- get some go tools -->
  <Target Name="GoGetRice" Condition="$(ForceGoGet) Or !Exists('$(GoRicePath)')">
    <Exec Command="go get -u github.com/GeertJohan/go.rice/rice" />
  </Target>

  <Target Name="GoGetVersionInfo" Condition="$(ForceGoGet) Or !Exists('$(GoVerInfoPath)')">
    <Exec Command="go get -u github.com/josephspurrier/goversioninfo/cmd/goversioninfo" />
  </Target>

  <Target Name="GoGetSwag" Condition="$(ForceGoGet) Or !Exists('$(GoSwagPath)')">
    <Exec Command="go get -u github.com/swaggo/swag/cmd/swag" />
  </Target>

  <Target Name="GoGetTools" DependsOnTargets="GoGetRice;GoGetVersionInfo;GoGetSwag" BeforeTargets="Build" />

  <Target Name="ToolsGoTrace" Condition="'$(ZouTraceProps)' == 'true'">
    <Message Importance="high" Text="GoWorkspace   = $(GoWorkspace)" />
    <Message Importance="high" Text="GoResourceDir = $(GoResourceDir)" />
    <Message Importance="high" Text="GoBinDir      = $(GoBinDir)" />
    <Message Importance="high" Text="GOPATH        = $(GOPATH)" />
    <Message Importance="high" Text="GOROOT        = $(GOROOT)" />
    <Message Importance="high" Text="GoExePath     = $(GoExePath)" />
    <Message Importance="high" Text="GoRicePath    = $(GoRicePath)" />
    <Message Importance="high" Text="GoSwagPath    = $(GoSwagPath)" />
    <Message Importance="high" Text="GoVerInfoPath = $(GoVerInfoPath)" />
    <Message Importance="high" Text="GoOS          = $(GoOS)" />
    <Message Importance="high" Text="GoArch        = $(GoArch)" />
    <Message Importance="high" Text="GoBuildEnv    = %(GoBuildEnv.Identity)" />
  </Target>
</Project>
