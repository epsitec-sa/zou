<?xml version="1.0" encoding="utf-8"?>
<!--
This script can be imported anywhere before first MS import (Microsoft.Cpp.Default.props).
-->
<Project ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003"
         InitialTargets="ZouTraceMSBuild;ZouTrace"
         TreatAsLocalProperty="ZouTrace">

  <PropertyGroup>
    <!-- Configuration sub-directory -->
    <_ZouCfgSubdir>zou.cfg\</_ZouCfgSubdir>
    <!-- Enable ZouTrace and ZouTraceMSBuild if the command 'msbuild zou.props' is executed -->
    <ZouTrace Condition="'$(ZouTrace)' == '' And '$(MSBuildProjectFile)' == '$(MSBuildThisFile)'">true</ZouTrace>
    <ZouTraceMSBuild Condition="'$(ZouTraceMSBuild)' == '' And '$(MSBuildProjectFile)' == '$(MSBuildThisFile)'">true</ZouTraceMSBuild>
  </PropertyGroup>

  <!-- Bundle -->
  <PropertyGroup>
    <BundleDir>$([MSBuild]::GetDirectoryNameOfFileAbove($(MSBuildThisFileDirectory), '.git/HEAD'))</BundleDir>
    <BundleName>$([System.IO.Path]::GetFileName('$(BundleDir)'))</BundleName>
    <BundleDir>$(BundleDir)/</BundleDir>
    <!-- bundle/zou.cfg/ -->
    <ZouBundleDir Condition="'$(ZouBundleDir)' == ''">$(BundleDir)$(_ZouCfgSubdir)</ZouBundleDir>
  </PropertyGroup>

  <!-- zou submodule -->
  <PropertyGroup>
    <ZouDir>$([MSBuild]::GetDirectoryNameOfFileAbove($(MSBuildThisFileDirectory), '.git'))</ZouDir>
    <ZouDir Condition="'$(ZouDir)' == ''">$(BundleDir)</ZouDir>
    <ZouDir Condition="HasTrailingSlash('$(ZouDir)')">$(ZouDir.Substring(0, $(ZouDir.LastIndexOfAny('\/'))))</ZouDir>
    <ZouName>$([System.IO.Path]::GetFileName('$(ZouDir)'))</ZouName>
    <ZouDir>$(ZouDir)\</ZouDir>
    <ZouBinDir>$(ZouDir)bin\</ZouBinDir>
    <ZouPrivateDir>$(ZouDir)private\</ZouPrivateDir>
  </PropertyGroup>
  
  <PropertyGroup Condition="'$(BundleDir' == '' Or '$(ZouDir)' == ''">
    <ZouError>true</ZouError>
    <ZouTrace>true</ZouTrace>
  </PropertyGroup>

  <!-- Module -->
  <PropertyGroup>
    <ModuleId>$([MSBuild]::GetDirectoryNameOfFileAbove($(MSBuildProjectDirectory), '.git'))</ModuleId>
  </PropertyGroup>
  <PropertyGroup Condition="'$(ModuleId)' != ''">
    <ModuleIsShared>true</ModuleIsShared>
    <ModuleId>$([MSBuild]::MakeRelative(file://$(BundleDir), file://$(ModuleId)))</ModuleId>
    <ModuleId Condition="HasTrailingSlash('$(ModuleId)')">$(ModuleId.Substring(0, $(ModuleId.LastIndexOfAny('\/'))))</ModuleId>
    <ModuleName>$(ModuleId)</ModuleName>
    <ModuleDir>$(BundleDir)$(ModuleId)\</ModuleDir>
  </PropertyGroup>
  <PropertyGroup Condition="'$(ModuleId)' == ''">
    <ModuleId>$(MSBuildProjectDirectory)\</ModuleId>
    <ModuleId>$([MSBuild]::MakeRelative($(BundleDir), $(ModuleId)))</ModuleId>
  </PropertyGroup>
  <PropertyGroup  Condition="'$(ModuleId)' != ''">
    <ModuleId Condition="HasTrailingSlash('$(ModuleId)')">$(ModuleId.Substring(0, $(ModuleId.IndexOfAny('\/'))))</ModuleId>
    <ModuleName>$([System.IO.Path]::GetFileName('$(ModuleId)'))</ModuleName>
    <ModuleDir>$(BundleDir)$(ModuleId)\</ModuleDir>
  </PropertyGroup>

  <!-- Project -->
  <PropertyGroup>
    <!-- project/zou.cfg/ -->
    <ZouProjectDir Condition="'$(ZouProjectDir)' == ''">$(MSBuildProjectDirectory)\$(_ZouCfgSubdir)</ZouProjectDir>
    <BundleRelativeProjectDir>$([MSBuild]::MakeRelative(file://$(BundleDir), file://$(MSBuildProjectDirectory)\))</BundleRelativeProjectDir>
    <BundleRelativeProjectName>$([MSBuild]::MakeRelative(file://$(BundleDir), file://$(MSBuildProjectDirectory)\$(MSBuildProjectName)))</BundleRelativeProjectName>
    <BundleRelativeProjectPath>$([MSBuild]::MakeRelative(file://$(BundleDir), file://$(MSBuildProjectDirectory)\$(MSBuildProjectFile)))</BundleRelativeProjectPath>
    <ProjectId>$(BundleRelativeProjectName)</ProjectId>
  </PropertyGroup>

  <!-- Solution -->
  <Choose>
    <When Condition="'$(SolutionPath)' != '' And '$(SolutionPath)' != '*Undefined*'">
      <PropertyGroup >
        <!-- solution/zou.cfg/ -->
        <ZouSolutionDir  Condition="'$(ZouSolutionDir)' == ''">$(SolutionDir)$(_ZouCfgSubdir)</ZouSolutionDir>
        <BundleRelativeSolutionDir>$([MSBuild]::MakeRelative($(BundleDir), $(SolutionDir)))</BundleRelativeSolutionDir>
        <BundleRelativeSolutionName>$([MSBuild]::MakeRelative($(BundleDir), $(SolutionDir)$(SolutionName)))</BundleRelativeSolutionName>
        <BundleRelativeSolutionPath>$([MSBuild]::MakeRelative($(BundleDir), $(SolutionPath)))</BundleRelativeSolutionPath>
        
        <!-- Use the following property instead of SolutionDir when building a project without a solution (example: msbuild project.vcxproj) -->
        <SolutionOrProjectDir>$(SolutionDir)</SolutionOrProjectDir>
      </PropertyGroup>
    </When>
    <Otherwise>
      <PropertyGroup>
        <ZouSolutionDir>$(ZouProjectDir)</ZouSolutionDir>
        <BundleRelativeSolutionDir>$(BundleRelativeProjectDir)</BundleRelativeSolutionDir>

        <!-- Use the following property instead of SolutionDir when building a project without a solution (example: msbuild project.vcxproj) -->
        <SolutionOrProjectDir>$(MSBuildProjectDirectory)\</SolutionOrProjectDir>
      </PropertyGroup>
    </Otherwise>
  </Choose>
  
  <!-- Dummy target used by zou, provided by Microsoft.Cpp.Targets but not by Microsoft.CSharp.targets -->
  <Target Name="_PrepareForClean" Condition="'$(MSBuildProjectExtension)' != '.vcxproj'" />
  <Target Name="_DeleteLastBuildState" DependsOnTargets="_PrepareForClean" />

  <!-- Flag properties that are defined on the command line. -->
  <PropertyGroup>
    <WorkDirSpecified         Condition=" '$(WorkDir)'         != '' And '$(WorkDirSpecified)'         == '' ">true</WorkDirSpecified>
    <PkgDirSpecified          Condition=" '$(PkgDir)'          != '' And '$(PkgDirSpecified)'          == '' ">true</PkgDirSpecified>
    <PkgProdBinDirSpecified   Condition=" '$(PkgProdBinDir)'   != '' And '$(PkgProdBinDirSpecified)'   == '' ">true</PkgProdBinDirSpecified>
    <DbgDirSpecified          Condition=" '$(DbgDir)'          != '' And '$(DbgDirSpecified)'          == '' ">true</DbgDirSpecified>
    <OutDirSpecified          Condition=" '$(OutDir)'          != '' And '$(OutDirSpecified)'          == '' ">true</OutDirSpecified>
    <PlatformSpecified        Condition=" '$(Platform)'        != '' And '$(PlatformSpecified)'        == '' ">true</PlatformSpecified>
    <PlatformToolsetSpecified Condition=" '$(PlatformToolset)' != '' And '$(PlatformToolsetSpecified)' == '' ">true</PlatformToolsetSpecified>
  </PropertyGroup>

  <!-- zou custom tasks -->
  <Import Project="zou.Tasks.props"/>
  <Import Project="Tools.Nuget.props"/>
  
  <!-- Detect a rebuild -->
  <Target Name="ZouBeforeRebuild" BeforeTargets="BeforeRebuild">
    <PropertyGroup>
      <ZouInsideRebuild>true</ZouInsideRebuild>
    </PropertyGroup>
  </Target>
  <Target Name="ZouAfterRebuild" AfterTargets="AfterRebuild">
    <PropertyGroup>
      <ZouInsideRebuild></ZouInsideRebuild>
    </PropertyGroup>
  </Target>

  <Target Name="ZouTraceMSBuild" Condition="'$(ZouTraceMSBuild)' == 'true'">
    <Message Importance="normal" Text="MSBuild properties" />
    <Message Importance="normal" Text="==================" />
    <Message Importance="normal" Text="  MSBuildAssemblyVersion         = $(MSBuildAssemblyVersion)" />
    <Message Importance="normal" Text="  MSBuildBinPath                 = $(MSBuildBinPath)" />
    <Message Importance="normal" Text="  MSBuildToolsPath               = $(MSBuildToolsPath)" />
    <Message Importance="normal" Text="  MSBuildUserExtensionsPath      = $(MSBuildUserExtensionsPath)" />
    <Message Importance="normal" Text="  MSBuildExtensionsPath          = $(MSBuildExtensionsPath)" />
    <Message Importance="normal" Text="  MSBuildExtensionsPath32        = $(MSBuildExtensionsPath32)" />
    <Message Importance="normal" Text="  MSBuildExtensionsPath64        = $(MSBuildExtensionsPath64)" />
    <Message Importance="normal" Text="  MSBuildToolsVersion            = $(MSBuildToolsVersion)" />
    <Message Importance="normal" Text="  MSBuildFrameworkToolsPath      = $(MSBuildFrameworkToolsPath)" />
    <Message Importance="normal" Text="  MSBuildLastTaskResult          = $(MSBuildLastTaskResult)" />
    <Message Importance="normal" Text="  MSBuildProjectDirectory        = $(MSBuildProjectDirectory)" />
    <Message Importance="normal" Text="  MSBuildProjectFile             = $(MSBuildProjectFile)" />
    <Message Importance="normal" Text="  MSBuildProjectExtension        = $(MSBuildProjectExtension)" />
    <Message Importance="normal" Text="  MSBuildThisFile                = $(MSBuildThisFile)" />
    <Message Importance="normal" Text="  MSBuildThisFileDirectory       = $(MSBuildThisFileDirectory)" />
    <Message Importance="normal" Text="  MSBuildThisFileExtension       = $(MSBuildThisFileExtension)" />
    <Message Importance="normal" Text="  MSBuildThisFileFullPath        = $(MSBuildThisFileFullPath)" />
    <Message Importance="normal" Text="  MSBuildThisFileName            = $(MSBuildThisFileName)" />
    <Message Importance="normal" Text="  MSBuildThisFileDirectoryNoRoot = $(MSBuildThisFileDirectoryNoRoot)" />
    <Message Importance="normal" Text="  MSBuildStartupDirectory        = $(MSBuildStartupDirectory)" />
    <Message Importance="normal" Text="  BuildingInsideVisualStudio     = $(BuildingInsideVisualStudio)" />
    <Message Importance="normal" Text="  VCTargetsPath                  = $(VCTargetsPath)" />
    <Message Importance="normal" Text="  DevEnvDir                      = $(DevEnvDir)" />
  </Target>
  
  <Target Name="ZouTrace" Condition="'$(ZouTrace)' == 'true'">
    <Message Importance="normal" Text="Zou boot properties" />
    <Message Importance="normal" Text="===================" />
    <Message Importance="normal" Text="  BuildingInsideVisualStudio = $(BuildingInsideVisualStudio)" />
    <Message Importance="normal" Text="  SolutionName               = $(SolutionName)" />
    <Message Importance="normal" Text="  SolutionDir                = $(SolutionDir)"  />
    <Message Importance="normal" Text="  SolutionPath               = $(SolutionPath)" />
    <Message Importance="normal" Text="  MSBuildProjectName         = $(MSBuildProjectName)" />
    <Message Importance="normal" Text="  MSBuildProjectDirectory    = $(MSBuildProjectDirectory)" />
    <Message Importance="normal" Text="  MSBuildProjectFile         = $(MSBuildProjectFile)" />
    <Message Importance="normal" Text="  MSBuildProjectExtension    = $(MSBuildProjectExtension)" />
    <Message Importance="normal" Text="  TargetFramework            = $(TargetFramework)" />
    <Message Importance="normal" Text="  RuntimeIdentifier          = $(RuntimeIdentifier)" />
    <Message Importance="normal" Text="  TargetFrameworks           = $(TargetFrameworks)" />
    <Message Importance="normal" Text="  RuntimeIdentifiers         = $(RuntimeIdentifiers)" />
    <Message Importance="normal" Text="+ BundleName                 = $(BundleName)" />
    <Message Importance="normal" Text="+ BundleDir                  = $(BundleDir)" />
    <Message Importance="normal" Text="+ ModuleId                   = $(ModuleId)" />
    <Message Importance="normal" Text="+ ModuleName                 = $(ModuleName)" />
    <Message Importance="normal" Text="+ ModuleDir                  = $(ModuleDir)" />
    <Message Importance="normal" Text="+ ModuleIsShared             = $(ModuleIsShared)" />
    <Message Importance="normal" Text="+ ZouName                    = $(ZouName)" />
    <Message Importance="normal" Text="+ ZouDir                     = $(ZouDir)" />
    <Message Importance="normal" Text="+ ZouBinDir                  = $(ZouBinDir)" />
    <Message Importance="normal" Text="+ ZouPrivateDir              = $(ZouPrivateDir)" />
    <Message Importance="normal" Text="+ ZouBundleDir               = $(ZouBundleDir)" />
    <Message Importance="normal" Text="+ ZouSolutionDir             = $(ZouSolutionDir)" />
    <Message Importance="normal" Text="+ ZouProjectDir              = $(ZouProjectDir)" />
    <Message Importance="normal" Text="+ BundleRelativeSolutionDir  = $(BundleRelativeSolutionDir)" />
    <Message Importance="normal" Text="+ BundleRelativeSolutionName = $(BundleRelativeSolutionName)" />
    <Message Importance="normal" Text="+ BundleRelativeSolutionPath = $(BundleRelativeSolutionPath)" />
    <Message Importance="normal" Text="+ BundleRelativeProjectDir   = $(BundleRelativeProjectDir)" />
    <Message Importance="normal" Text="+ BundleRelativeProjectName  = $(BundleRelativeProjectName)" />
    <Message Importance="normal" Text="+ BundleRelativeProjectPath  = $(BundleRelativeProjectPath)" />
    <Message Importance="normal" Text="Execution time" />
    <Message Importance="normal" Text="==============" />
    <Message Importance="normal" Text="  Configuration              = $(Configuration)" />
    <Message Importance="normal" Text="  Platform                   = $(Platform)" />
    <Message Importance="normal" Text="  PlatformToolset            = $(PlatformToolset)" />
    <Message Importance="normal" Text="  SolutionName               = $(SolutionName)" />
    <Message Importance="normal" Text="  SolutionDir                = $(SolutionDir)" />
    <Message Importance="normal" Text="  SolutionPath               = $(SolutionPath)" />
    <Message Importance="normal" Text="  ProjectName                = $(ProjectName)" />
    <Message Importance="normal" Text="  ProjectDir                 = $(ProjectDir)" />
    <Message Importance="normal" Text="  ProjectPath                = $(ProjectPath)" />
    <Message Importance="normal" Text="  IntDir                     = $(IntDir)" />
    <Message Importance="normal" Text="  OutDir                     = $(OutDir)" />
    <Message Importance="normal" Text="  TargetDir                  = $(TargetDir)" />
    <Message Importance="normal" Text="  OutputPath                 = $(OutputPath)" />
    <Message Importance="normal" Text="  IntermediateOutputPath     = $(IntermediateOutputPath)" />
    <Message Importance="normal" Text="+ SolutionOrProjectDir       = $(SolutionOrProjectDir)" />
    <Message Importance="normal" Text="+ WorkDir                    = $(WorkDir)" />
    <Message Importance="normal" Text="+ DbgDir                     = $(DbgDir)" />
    <Message Importance="normal" Text="+ DbgProjDir                 = $(DbgProjDir)" />
    <Message Importance="normal" Text="+ PkgDir                     = $(PkgDir)" />
    <Message Importance="normal" Text="+ PkgProdBinDir              = $(PkgProdBinDir)" />
    <Message Importance="normal" Text="+ PkgProdDbgDir              = $(PkgProdDbgDir)" />
    <Message Importance="normal" Text="+ PkgDevBinDir               = $(PkgDevBinDir)" />
    <Message Importance="normal" Text="+ PkgDevDbgDir               = $(PkgDevDbgDir)" />
    <Message Importance="normal" Text="+ WorkDirSpecified           = $(WorkDirSpecified)" />
    <Message Importance="normal" Text="+ PkgDirSpecified            = $(PkgDirSpecified)" />
    <Message Importance="normal" Text="+ PkgProdBinDirSpecified     = $(PkgProdBinDirSpecified)" />
    <Message Importance="normal" Text="+ DbgDirSpecified            = $(DbgDirSpecified)" />
    <Message Importance="normal" Text="+ OutDirSpecified            = $(OutDirSpecified)" />
    <Message Importance="normal" Text="+ PlatformSpecified          = $(PlatformSpecified)" />
    <Message Importance="normal" Text="+ PlatformToolsetSpecified   = $(PlatformToolsetSpecified)" />
    <Message Importance="normal" Text="+ ForwardWorkDir             = $(ForwardWorkDir)" />
    <Message Importance="normal" Text="+ ForwardPkgDir              = $(ForwardPkgDir)" />
    <Message Importance="normal" Text="+ ForwardDbgDir              = $(ForwardDbgDir)" />
    <Message Importance="normal" Text="+ ForwardOutDir              = $(ForwardOutDir)" />
    <Message Importance="normal" Text="+ ForwardPlatform            = $(ForwardPlatform)" />
    <Message Importance="normal" Text="+ ForwardPlatformToolset     = $(ForwardPlatformToolset)" />

    <Error Condition="'$(ZouError)' == 'true'" Text="Base properties error" />
  </Target>
</Project>