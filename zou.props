<?xml version="1.0" encoding="utf-8"?>
<!--
This script can be imported anywhere before first MS import (Microsoft.Cpp.Default.props).
-->
<Project ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003"
         InitialTargets="ZouTraceMSBuild;ZouTrace"
         TreatAsLocalProperty="ZouTrace">

  <PropertyGroup>
    <ZouVersion>4.0</ZouVersion>
    <!-- V represent directory separator which can be \ or / i.e \/ then V -->
    <V Condition="'$(V)' == '' And $([MSBuild]::IsOsPlatform('Windows'))">\</V>
    <V Condition="'$(V)' == ''">/</V>
    <!-- Nul device -->
    <Nul Condition="$([MSBuild]::IsOsPlatform('Windows'))">nul</Nul>
    <Nul Condition="'$(Nul)' == ''">/dev/null</Nul>

    <NETSdkVersion>$([System.Text.RegularExpressions.Regex]::Match($(MSBuildToolsPath), '(?&lt;=dotnet[\\/]sdk[\\/])\d+\.\d+\.\d+'))</NETSdkVersion>
    <!-- Configuration sub-directory -->
    <ZouCfg>zou.cfg$(V)</ZouCfg>
    <!-- Enable ZouTrace and ZouTraceMSBuild if the command 'msbuild zou.props' is executed -->
    <ZouTrace Condition="'$(ZouTrace)' == '' And '$(MSBuildProjectFile)' == '$(MSBuildThisFile)'">true</ZouTrace>
    <ZouTraceMSBuild Condition="'$(ZouTraceMSBuild)' == '' And '$(MSBuildProjectFile)' == '$(MSBuildThisFile)'">true</ZouTraceMSBuild>
    <IsDebug Condition="$(Configuration.StartsWith('Debug', StringComparison.OrdinalIgnoreCase))">true</IsDebug>
    <IsRelease Condition="$(Configuration.StartsWith('Release', StringComparison.OrdinalIgnoreCase))">true</IsRelease>
    <ZouOs Condition="$([MSBuild]::IsOsPlatform(Windows))">win</ZouOs>
    <ZouOs Condition="$([MSBuild]::IsOsPlatform(OSX))">osx</ZouOs>
    <ZouOs Condition="$([MSBuild]::IsOsPlatform(Linux))">linux</ZouOs>
  </PropertyGroup>

  <!-- Bundle -->
  <PropertyGroup>
    <BundleDir>$([System.IO.Directory]::GetParent('$(MSBuildThisFileDirectory.TrimEnd('\/'))'))</BundleDir>
    <BundleName>$([System.IO.Path]::GetFileName('$(BundleDir)'))</BundleName>
    <BundleDir>$(BundleDir)$(V)</BundleDir>
    <BundleId Condition="'$(BundleId)' == ''">$(BundleName)</BundleId>
    <BundleIsGit>false</BundleIsGit>
    <BundleIsGit Condition="Exists('$(BundleDir).git\.')">true</BundleIsGit>
    <!-- bundle/zou.cfg/ -->
    <ZouBundleDir Condition="'$(ZouBundleDir)' == ''">$(BundleDir)$(ZouCfg)</ZouBundleDir>
  </PropertyGroup>

  <!-- Bundle ID -->
  <Import Project="$(BundleDir)BundleId.props" Condition="Exists('$(BundleDir)BundleId.props')" />
  <PropertyGroup>
    <BundleId Condition="'$(BundleId)' == ''">$(BundleName)</BundleId>
  </PropertyGroup>

  <!-- zou submodule -->
  <PropertyGroup>
    <ZouDir>$(MSBuildThisFileDirectory)</ZouDir>
    <ZouDir Condition="'$(ZouDir)' == ''">$(BundleDir)</ZouDir>
    <ZouDir>$(ZouDir.TrimEnd('\/'))</ZouDir>
    <ZouName>$([System.IO.Path]::GetFileName('$(ZouDir)'))</ZouName>
    <ZouDir>$(ZouDir)$(V)</ZouDir>
    <ZouPrivateDir>$(ZouDir)private$(V)</ZouPrivateDir>
    <ZouBinDir>$(ZouDir)bin$(V)</ZouBinDir>
    <ZouBinzDir>$(ZouDir)binz$(V)</ZouBinzDir>
    <ZouBinzOsDir>$(ZouBinzDir)$(ZouOs)$(V)</ZouBinzOsDir>
  </PropertyGroup>
  
  <PropertyGroup Condition="'$(BundleDir' == '' Or '$(ZouDir)' == ''">
    <ZouError>true</ZouError>
    <ZouTrace>true</ZouTrace>
  </PropertyGroup>

  <!-- Module -->
  <PropertyGroup>
    <ModuleId>$([MSBuild]::GetDirectoryNameOfFileAbove($(MSBuildProjectDirectory), '.git'))</ModuleId>
  </PropertyGroup>
  <PropertyGroup Condition="'$(ModuleId)' != ''">
    <ModuleIsShared>true</ModuleIsShared>
    <ModuleId>$([MSBuild]::MakeRelative($(BundleDir), $(ModuleId)))</ModuleId>
    <ModuleId>$(ModuleId.TrimEnd('\/'))</ModuleId>
    <ModuleName>$(ModuleId)</ModuleName>
    <ModuleDir>$(BundleDir)$(ModuleId)$(V)</ModuleDir>
  </PropertyGroup>
  <PropertyGroup Condition="'$(ModuleId)' == ''">
    <ModuleId>$(MSBuildProjectDirectory)$(V)</ModuleId>
    <ModuleId>$([MSBuild]::MakeRelative($(BundleDir), $(ModuleId)))</ModuleId>
  </PropertyGroup>
  <PropertyGroup  Condition="'$(ModuleId)' != ''">
    <ModuleId>$(ModuleId.TrimEnd('\/'))</ModuleId>
    <ModuleName>$([System.IO.Path]::GetFileName('$(ModuleId)'))</ModuleName>
    <ModuleDir>$(BundleDir)$(ModuleId)$(V)</ModuleDir>
  </PropertyGroup>

  <!-- Project -->
  <PropertyGroup>
    <!-- project/zou.cfg/ -->
    <ZouProjectDir Condition="'$(ZouProjectDir)' == ''">$(MSBuildProjectDirectory)$(V)$(ZouCfg)</ZouProjectDir>
    <BundleRelativeProjectDir>$([MSBuild]::MakeRelative($(BundleDir), $(MSBuildProjectDirectory)/))</BundleRelativeProjectDir>
    <BundleRelativeProjectName>$([MSBuild]::MakeRelative($(BundleDir), $(MSBuildProjectDirectory)/$(MSBuildProjectName)))</BundleRelativeProjectName>
    <BundleRelativeProjectPath>$([MSBuild]::MakeRelative($(BundleDir), $(MSBuildProjectDirectory)/$(MSBuildProjectFile)))</BundleRelativeProjectPath>
    <ModuleRelativeProjectDir>$([MSBuild]::MakeRelative($(ModuleDir), $(MSBuildProjectDirectory)/))</ModuleRelativeProjectDir>
    <ModuleRelativeProjectName>$([MSBuild]::MakeRelative($(ModuleDir), $(MSBuildProjectDirectory)/$(MSBuildProjectName)))</ModuleRelativeProjectName>
    <ModuleRelativeProjectPath>$([MSBuild]::MakeRelative($(ModuleDir), $(MSBuildProjectDirectory)/$(MSBuildProjectFile)))</ModuleRelativeProjectPath>
    <ProjectId>$(BundleRelativeProjectName)</ProjectId>
  </PropertyGroup>

  <!-- Solution -->
  <Choose>
    <When Condition="'$(SolutionPath)' != '' And '$(SolutionPath)' != '*Undefined*'">
      <PropertyGroup >
        <!-- solution/zou.cfg/ -->
        <ZouSolutionDir  Condition="'$(ZouSolutionDir)' == ''">$(SolutionDir)$(ZouCfg)</ZouSolutionDir>
        <BundleRelativeSolutionDir>$([MSBuild]::MakeRelative($(BundleDir), $(SolutionDir)))</BundleRelativeSolutionDir>
        <BundleRelativeSolutionName>$([MSBuild]::MakeRelative($(BundleDir), $(SolutionDir)$(SolutionName)))</BundleRelativeSolutionName>
        <BundleRelativeSolutionPath>$([MSBuild]::MakeRelative($(BundleDir), $(SolutionPath)))</BundleRelativeSolutionPath>
        
        <!-- Use the following property instead of SolutionDir when building a project without a solution (example: msbuild project.vcxproj) -->
        <SolutionOrProjectDir>$(SolutionDir)</SolutionOrProjectDir>
      </PropertyGroup>
    </When>
    <Otherwise>
      <PropertyGroup>
        <ZouSolutionDir>$(ZouProjectDir)</ZouSolutionDir>
        <BundleRelativeSolutionDir>$(BundleRelativeProjectDir)</BundleRelativeSolutionDir>

        <!-- Use the following property instead of SolutionDir when building a project without a solution (example: msbuild project.vcxproj) -->
        <SolutionOrProjectDir>$(MSBuildProjectDirectory)$(V)</SolutionOrProjectDir>
      </PropertyGroup>
    </Otherwise>
  </Choose>
  
  <!-- Dummy target used by zou, provided by Microsoft.Cpp.Targets but not by Microsoft.CSharp.targets -->
  <Target Name="_PrepareForClean" Condition="'$(MSBuildProjectExtension)' != '.vcxproj'" />
  <Target Name="_DeleteLastBuildState" DependsOnTargets="_PrepareForClean" />

  <!-- Flag properties that are defined on the command line. -->
  <PropertyGroup>
    <WorkDirSpecified         Condition=" '$(WorkDir)'         != '' And '$(WorkDirSpecified)'         == '' ">true</WorkDirSpecified>
    <PkgDirSpecified          Condition=" '$(PkgDir)'          != '' And '$(PkgDirSpecified)'          == '' ">true</PkgDirSpecified>
    <PkgBinDirSpecified       Condition=" '$(PkgBinDir)'       != '' And '$(PkgBinDirSpecified)'       == '' ">true</PkgBinDirSpecified>
    <AsmDirSpecified          Condition=" '$(AsmDir)'          != '' And '$(AsmDirSpecified)'          == '' ">true</AsmDirSpecified>
    <OutDirSpecified          Condition=" '$(OutDir)'          != '' And '$(OutDirSpecified)'          == '' ">true</OutDirSpecified>
    <PlatformSpecified        Condition=" '$(Platform)'        != '' And '$(PlatformSpecified)'        == '' ">true</PlatformSpecified>
    <PlatformToolsetSpecified Condition=" '$(PlatformToolset)' != '' And '$(PlatformToolsetSpecified)' == '' ">true</PlatformToolsetSpecified>
  </PropertyGroup>

  <!-- zou custom tasks -->
  <Import Project="zou.Tasks.props"/>
  <Import Project="Tools.Nuget.props"/>

  <!-- Detect a rebuild -->
  <Target Name="ZouBeforeRebuild" BeforeTargets="BeforeRebuild">
    <PropertyGroup>
      <ZouInsideRebuild>true</ZouInsideRebuild>
    </PropertyGroup>
  </Target>
  <Target Name="ZouAfterRebuild" AfterTargets="AfterRebuild">
    <PropertyGroup>
      <ZouInsideRebuild />
    </PropertyGroup>
  </Target>

  <Target Name="ZouTraceMSBuild" Condition="'$(ZouTraceMSBuild)' == 'true'">
    <Message Importance="normal" Text="MSBuild properties" />
    <Message Importance="normal" Text="==================" />
    <Message Importance="normal" Text="  OS                             = $(OS)" />
    <Message Importance="normal" Text="  MSBuildProgramFiles32          = $(MSBuildProgramFiles32)" />
    <Message Importance="normal" Text="  MSBuildRuntimeType             = $(MSBuildRuntimeType)" />
    <Message Importance="normal" Text="  MSBuildAssemblyVersion         = $(MSBuildAssemblyVersion)" />
    <Message Importance="normal" Text="  MSBuildBinPath                 = $(MSBuildBinPath)" />
    <Message Importance="normal" Text="  MSBuildToolsPath               = $(MSBuildToolsPath)" />
    <Message Importance="normal" Text="  MSBuildSDKsPath                = $(MSBuildSDKsPath)" />
    <Message Importance="normal" Text="  MSBuildUserExtensionsPath      = $(MSBuildUserExtensionsPath)" />
    <Message Importance="normal" Text="  MSBuildExtensionsPath          = $(MSBuildExtensionsPath)" />
    <Message Importance="normal" Text="  MSBuildExtensionsPath32        = $(MSBuildExtensionsPath32)" />
    <Message Importance="normal" Text="  MSBuildExtensionsPath64        = $(MSBuildExtensionsPath64)" />
    <Message Importance="normal" Text="  MSBuildToolsVersion            = $(MSBuildToolsVersion)" />
    <Message Importance="normal" Text="  MSBuildFrameworkToolsPath      = $(MSBuildFrameworkToolsPath)" />
    <Message Importance="normal" Text="  MSBuildLastTaskResult          = $(MSBuildLastTaskResult)" />
    <Message Importance="normal" Text="  MSBuildProjectDirectory        = $(MSBuildProjectDirectory)" />
    <Message Importance="normal" Text="  MSBuildProjectFile             = $(MSBuildProjectFile)" />
    <Message Importance="normal" Text="  MSBuildProjectExtension        = $(MSBuildProjectExtension)" />
    <Message Importance="normal" Text="  MSBuildProjectExtensionsPath   = $(MSBuildProjectExtensionsPath)" />
    <Message Importance="normal" Text="  MSBuildThisFile                = $(MSBuildThisFile)" />
    <Message Importance="normal" Text="  MSBuildThisFileDirectory       = $(MSBuildThisFileDirectory)" />
    <Message Importance="normal" Text="  MSBuildThisFileExtension       = $(MSBuildThisFileExtension)" />
    <Message Importance="normal" Text="  MSBuildThisFileFullPath        = $(MSBuildThisFileFullPath)" />
    <Message Importance="normal" Text="  MSBuildThisFileName            = $(MSBuildThisFileName)" />
    <Message Importance="normal" Text="  MSBuildThisFileDirectoryNoRoot = $(MSBuildThisFileDirectoryNoRoot)" />
    <Message Importance="normal" Text="  MSBuildStartupDirectory        = $(MSBuildStartupDirectory)" />
    <Message Importance="normal" Text="  ToolsVersion                   = $(ToolsVersion)" />
    <Message Importance="normal" Text="  SDK35ToolsPath                 = $(SDK35ToolsPath)" />
    <Message Importance="normal" Text="  SDK40ToolsPath                 = $(SDK40ToolsPath)" />
    <Message Importance="normal" Text="  BuildingInsideVisualStudio     = $(BuildingInsideVisualStudio)" />
    <Message Importance="normal" Text="  VSToolsPath                    = $(VSToolsPath)" />
    <Message Importance="normal" Text="  VCTargetsPath                  = $(VCTargetsPath)" />
    <Message Importance="normal" Text="  DevEnvDir                      = $(DevEnvDir)" />
  </Target>
  
  <Target Name="ZouTrace" Condition="'$(ZouTrace)' == 'true'">
    <Message Importance="normal" Text="Zou boot properties" />
    <Message Importance="normal" Text="===================" />
    <Message Importance="normal" Text="  BuildingInsideVisualStudio = $(BuildingInsideVisualStudio)" />
    <Message Importance="normal" Text="  SolutionName               = $(SolutionName)" />
    <Message Importance="normal" Text="  SolutionDir                = $(SolutionDir)"  />
    <Message Importance="normal" Text="  SolutionPath               = $(SolutionPath)" />
    <Message Importance="normal" Text="  MSBuildProjectName         = $(MSBuildProjectName)" />
    <Message Importance="normal" Text="  MSBuildProjectDirectory    = $(MSBuildProjectDirectory)" />
    <Message Importance="normal" Text="  MSBuildProjectFile         = $(MSBuildProjectFile)" />
    <Message Importance="normal" Text="  MSBuildProjectExtension    = $(MSBuildProjectExtension)" />
    <Message Importance="normal" Text="  TargetFramework            = $(TargetFramework)" />
    <Message Importance="normal" Text="  RuntimeIdentifier          = $(RuntimeIdentifier)" />
    <Message Importance="normal" Text="  TargetFrameworks           = $(TargetFrameworks)" />
    <Message Importance="normal" Text="  RuntimeIdentifiers         = $(RuntimeIdentifiers)" />
    <Message Importance="normal" Text="+ NETSdkVersion              = $(NETSdkVersion)" />
    <Message Importance="normal" Text="+ BundleId                   = $(BundleId)" />
    <Message Importance="normal" Text="+ BundleName                 = $(BundleName)" />
    <Message Importance="normal" Text="+ BundleDir                  = $(BundleDir)" />
    <Message Importance="normal" Text="+ BundleIsGit                = $(BundleIsGit)" />
    <Message Importance="normal" Text="+ ModuleId                   = $(ModuleId)" />
    <Message Importance="normal" Text="+ ModuleName                 = $(ModuleName)" />
    <Message Importance="normal" Text="+ ModuleDir                  = $(ModuleDir)" />
    <Message Importance="normal" Text="+ ModuleIsShared             = $(ModuleIsShared)" />
    <Message Importance="normal" Text="+ Nul                        = $(Nul)" />
    <Message Importance="normal" Text="+ ZouOs                      = $(ZouOs)" />
    <Message Importance="normal" Text="+ ZouName                    = $(ZouName)" />
    <Message Importance="normal" Text="+ ZouDir                     = $(ZouDir)" />
    <Message Importance="normal" Text="+ ZouBinDir                  = $(ZouBinDir)" />
    <Message Importance="normal" Text="+ ZouBinzDir                 = $(ZouBinzDir)" />
    <Message Importance="normal" Text="+ ZouBinzOsDir               = $(ZouBinzOsDir)" />
    <Message Importance="normal" Text="+ ZouPrivateDir              = $(ZouPrivateDir)" />
    <Message Importance="normal" Text="+ ZouBundleDir               = $(ZouBundleDir)" />
    <Message Importance="normal" Text="+ ZouSolutionDir             = $(ZouSolutionDir)" />
    <Message Importance="normal" Text="+ ZouProjectDir              = $(ZouProjectDir)" />
    <Message Importance="normal" Text="+ BundleRelativeSolutionDir  = $(BundleRelativeSolutionDir)" />
    <Message Importance="normal" Text="+ BundleRelativeSolutionName = $(BundleRelativeSolutionName)" />
    <Message Importance="normal" Text="+ BundleRelativeSolutionPath = $(BundleRelativeSolutionPath)" />
    <Message Importance="normal" Text="+ BundleRelativeProjectDir   = $(BundleRelativeProjectDir)" />
    <Message Importance="normal" Text="+ BundleRelativeProjectName  = $(BundleRelativeProjectName)" />
    <Message Importance="normal" Text="+ BundleRelativeProjectPath  = $(BundleRelativeProjectPath)" />
    <Message Importance="normal" Text="+ ModuleRelativeProjectDir   = $(ModuleRelativeProjectDir)" />
    <Message Importance="normal" Text="+ ModuleRelativeProjectName  = $(ModuleRelativeProjectName)" />
    <Message Importance="normal" Text="+ ModuleRelativeProjectPath  = $(ModuleRelativeProjectPath)" />
    <Message Importance="normal" Text="Execution time" />
    <Message Importance="normal" Text="==============" />
    <Message Importance="normal" Text="  Configuration              = $(Configuration)" />
    <Message Importance="normal" Text="  Platform                   = $(Platform)" />
    <Message Importance="normal" Text="  PlatformToolset            = $(PlatformToolset)" />
    <Message Importance="normal" Text="  SolutionName               = $(SolutionName)" />
    <Message Importance="normal" Text="  SolutionDir                = $(SolutionDir)" />
    <Message Importance="normal" Text="  SolutionPath               = $(SolutionPath)" />
    <Message Importance="normal" Text="  ProjectName                = $(ProjectName)" />
    <Message Importance="normal" Text="  ProjectDir                 = $(ProjectDir)" />
    <Message Importance="normal" Text="  ProjectPath                = $(ProjectPath)" />
    <Message Importance="normal" Text="  IntDir                     = $(IntDir)" />
    <Message Importance="normal" Text="  OutDir                     = $(OutDir)" />
    <Message Importance="normal" Text="  TargetExt                  = $(TargetExt)" />
    <Message Importance="normal" Text="  TargetName                 = $(TargetName)" />
    <Message Importance="normal" Text="  TargetFileName             = $(TargetFileName)" />
    <Message Importance="normal" Text="  TargetDir                  = $(TargetDir)" />
    <Message Importance="normal" Text="  TargetPath                 = $(TargetPath)" />
    <Message Importance="normal" Text="  OutputPath                 = $(OutputPath)" />
    <Message Importance="normal" Text="  IntermediateOutputPath     = $(IntermediateOutputPath)" />
    <Message Importance="normal" Text="+ IsDebug                    = $(IsDebug)" />
    <Message Importance="normal" Text="+ IsRelease                  = $(IsRelease)" />
    <Message Importance="normal" Text="+ SolutionOrProjectDir       = $(SolutionOrProjectDir)" />
    <Message Importance="normal" Text="+ AsmDir                     = $(AsmDir)" />
    <Message Importance="normal" Text="+ AsmProjDir                 = $(AsmProjDir)" />
    <Message Importance="normal" Text="+ PkgDir                     = $(PkgDir)" />
    <Message Importance="normal" Text="+ PkgBinDir                  = $(PkgBinDir)" />
    <Message Importance="normal" Text="+ PkgDbgDir                  = $(PkgDbgDir)" />
    <Message Importance="normal" Text="+ WorkDir                    = $(WorkDir)" />
    <Message Importance="normal" Text="+ AsmDirSpecified            = $(AsmDirSpecified)" />
    <Message Importance="normal" Text="+ OutDirSpecified            = $(OutDirSpecified)" />
    <Message Importance="normal" Text="+ PkgBinDirSpecified         = $(PkgBinDirSpecified)" />
    <Message Importance="normal" Text="+ PkgDirSpecified            = $(PkgDirSpecified)" />
    <Message Importance="normal" Text="+ PlatformSpecified          = $(PlatformSpecified)" />
    <Message Importance="normal" Text="+ PlatformToolsetSpecified   = $(PlatformToolsetSpecified)" />
    <Message Importance="normal" Text="+ WorkDirSpecified           = $(WorkDirSpecified)" />
    <Message Importance="normal" Text="+ ForwardAsmDir              = $(ForwardAsmDir)" />
    <Message Importance="normal" Text="+ ForwardOutDir              = $(ForwardOutDir)" />
    <Message Importance="normal" Text="+ ForwardPkgDir              = $(ForwardPkgDir)" />
    <Message Importance="normal" Text="+ ForwardPlatform            = $(ForwardPlatform)" />
    <Message Importance="normal" Text="+ ForwardPlatformToolset     = $(ForwardPlatformToolset)" />
    <Message Importance="normal" Text="+ ForwardWorkDir             = $(ForwardWorkDir)" />

    <Error Condition="'$(ZouError)' == 'true'" Text="Base properties error" />
  </Target>
</Project>
