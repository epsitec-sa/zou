<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="15.0" DefaultTargets="AddFileInfo" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!--<Import Project="..\Zou.props" />-->

  <!-- Experiment ItemGroup to property transform -->
  <ImportGroup>
    <Import Project="$(ZouPrivateDir)**\Cpp.NTVersion*.props" />
  </ImportGroup>

  <Target Name="WildcardImport">
    <Message Text="NTVersion=$(NTVersion)" />
  </Target>

  <ItemGroup>
    <CppIncludeDirs Include="s:\devel\sal\" />
    <CppIncludeDirs Include="s:\devel\fact\" />
  </ItemGroup>
  <PropertyGroup>
    <CppIncludeDirs>@(CppIncludeDirs)</CppIncludeDirs>
  </PropertyGroup>
  
  <Target Name="ItemsToProperty">
    <Message Text="CppIncludeDirs=$(CppIncludeDirs)" />
  </Target>

  <!-- Experiment ItemGroup & ItemDefinitionGroup scopes -->
  <ItemGroup>
    <A Include="A1">
      <P1>A1.P1</P1>
      <P2>%(P1).2</P2>
      <P3>A1.P3</P3>
    </A>
    <A Include="A2">
      <P1>A2.P1</P1>
      <P2>%(P1).2</P2>
      <P3>A2.P3</P3>
    </A>
  </ItemGroup>
  <ItemDefinitionGroup>
    <A>
      <P1>XX.P1</P1>
    </A>
  </ItemDefinitionGroup>

  <Target Name="Spike1" Condition="'@(A)' != ''">
    <Message Text="P1  = @(A -> '%(P1)')" />
    <Message Text="P2  = @(A -> '%(P2)')" />
    <Message Text="P3  = @(A -> '%(P3)')" />
    <Message Text="Ps  = $(Ps)" />
  </Target>
  
  <Target Name="Spike2" Condition="'@(A)' != ''">
    <ItemGroup>
      <B Include="%(A.P1)" Condition="'%(A.P1)' != ''" />
      <B Include="%(A.P2)" Condition="'%(A.P2)' != ''" />
      <B Include="%(A.P3)" Condition="'%(A.P3)' != ''" />
    </ItemGroup>
    <Message Text="B = @(B)" />
  </Target>
  <Target Name="Spike3" Condition="'@(A)' != ''">
    <ItemGroup>
      <B Include="%(A.Identity)">
        <P1 Condition="'%(A.P1)' != ''">P1=%(A.P1)</P1>
      </B>
    </ItemGroup>
    <Message Text="B = @(B -> '%(P1)')" />
  </Target>

  <!-- Experiment batching metadata -->
  <ItemGroup>
    <ImportProject Include="..\**\*.vcxproj">
      <Properties>OutDir=%(FileName)\;Platform=Win32</Properties>
    </ImportProject>
    <ImportProject Include="y.sln">
      <Properties>OutDir=y\;Platform=x64</Properties>
    </ImportProject>
  </ItemGroup>

  <Target Name="Spike4">
    <Message Text="[%(ImportProject.Identity)] /p:%(Properties)" />
  </Target>
  
  <!-- Experiment GetMetadata custom task -->
  <UsingTask TaskName="GetMetadata" TaskFactory="CodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.v4.0.dll" >
    <ParameterGroup>
      <Source ParameterType="Microsoft.Build.Framework.ITaskItem[]" Required="true" />
      <Metadata Output="true" />
    </ParameterGroup>
    <Task>
      <Using Namespace="System"/>
      <Code Type="Fragment" Language="cs">
        <![CDATA[
          StringBuilder command = new StringBuilder();
          foreach (ITaskItem item in Source)
          {
              command.AppendFormat("ItemName={0}\r\n", item);
              foreach (string parameter in item.MetadataNames)
              {
                  command.AppendFormat("  {0}={1}\r\n", parameter, item.GetMetadata(parameter));
              }
              command.AppendFormat("\r\n");
          }
          Metadata = command.ToString();
      ]]>
      </Code>
    </Task>
  </UsingTask>

  <Target Name="Spike5">
    <GetMetadata Source="@(ImportProject)">
      <Output PropertyName="ImportProjectMetadata" TaskParameter="Metadata" />
    </GetMetadata>
    <Message Text="$(ImportProjectMetadata)" />
  </Target>

  <Target Name="AddFileInfo">
    <ItemGroup>
      <InputFile Include="*.targets" />
    </ItemGroup>
    <AddFileInfo Files="@(InputFile)">
      <Output TaskParameter="OutputFiles" ItemName="OutputFile" />
    </AddFileInfo>
    <LogItems Items="@(OutputFile)" AllMetadata="true" />
  </Target>
</Project>