<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" DefaultTargets="Main" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Import Project="..\..\zou.props"/>
  
  <PropertyGroup>
    <TestPath>$(MSBuildThisFileDirectory)\Test.zou</TestPath>
  </PropertyGroup>
  
  <Target Name="Main">
    
    <ItemGroup>
      <SavedItem1 Include="..\..\Cpp.Agent.targets" />
      <SavedItem1 Include="..\..\Cpp.Pack.targets" />
      <SavedItem1>
        <BundleRelativePath>$([MSBuild]::MakeRelative($(BundleDir), %(FullPath)))</BundleRelativePath>
        <Culture>en-US</Culture>
        <ModuleName>$(ModuleName)</ModuleName>
        <ModuleId>$(ModuleId)</ModuleId>
      </SavedItem1>
    </ItemGroup>
    <LogItems Items="@(SavedItem1)" Title="Saved.1" AllMetadata="true" />
    
    <SaveItems File="$(TestPath)"
               Items="@(SavedItem1)"
               RelativeTo="$(BundleDir)"
               Metadata="Culture;ModuleName;ModuleId"
               Overwrite="true"/>
    
    <ItemGroup>
      <SavedItem2 Include="..\..\Cpp.Pack.targets" />
      <SavedItem2 Include="..\..\Cpp.Boot.props" />
      <SavedItem2>
        <BundleRelativePath>$([MSBuild]::MakeRelative($(BundleDir), %(FullPath)))</BundleRelativePath>
        <Culture>en-US</Culture>
        <ModuleName>$(ModuleName)</ModuleName>
        <ModuleId>$(ModuleId)</ModuleId>
        <DomainName>$(MSBuildThisFileName)</DomainName>
      </SavedItem2>
    </ItemGroup>

    <LogItems Items="@(SavedItem2)" Title="Saved.2" AllMetadata="true" />

    <SaveItems File="$(TestPath)"
               Items="@(SavedItem2)"
               RelativeTo="$(BundleDir)"
               Metadata="Culture;ModuleName;ModuleId;DomainName"/>

    <LoadItems File="$(TestPath)" RelativeTo="$(BundleDir)">
      <Output TaskParameter="Items" ItemName="LoadedItem" />
    </LoadItems>
    
    <LogItems Items="@(LoadedItem)" Title="Loaded" AllMetadata="true"/>
  </Target>
  
</Project>