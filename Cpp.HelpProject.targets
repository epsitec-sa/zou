<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!-- Help Project Property Page -->
  <ItemGroup>
    <PropertyPageSchema Include="$(MSBuildThisFileDirectory)Cpp.HelpProject.xml" />
    <AvailableItemName Include="HelpProject">
      <Targets>_HcBuild</Targets>
    </AvailableItemName>
  </ItemGroup>

  <!--=========================================================================-->
  <!-- Constants -->
  <!--=========================================================================-->

  <PropertyGroup>
    <MakeHm>$(VsToolsDir)makehm.exe</MakeHm>
    <Hhc>$(ZouBinDir)hhc.exe</Hhc>
  </PropertyGroup>

  <!--=========================================================================-->
  <!-- Initialization -->
  <!--=========================================================================-->

  <ItemDefinitionGroup>
    <HelpProject>
      <!--
        // see afxpriv.h
        // Help ID bases
        #define HID_BASE_COMMAND    0x00010000UL        // ID and IDM
        #define HID_BASE_RESOURCE   0x00020000UL        // IDR and IDD
        #define HID_BASE_PROMPT     0x00030000UL        // IDP
        #define HID_BASE_NCAREAS    0x00040000UL
        #define HID_BASE_CONTROL    0x00050000UL        // IDC
        #define HID_BASE_DISPATCH   0x00060000UL        // IDispatch help codes
      -->
      <HelpIdMappingRules>ID_,HID_,0x10000;IDM_,HIDM_,0x10000;IDR_,HIDR_,0x20000;IDD_,HIDD_,0x20000;IDP_,HIDP_,0x30000;IDC_,HIDC_,0x50000;IDW_,HIDW_,0x50000</HelpIdMappingRules>
      
      <CppResIdsFile>resource.h</CppResIdsFile>
      <HelpResIdsFile>$(IntDir)resource.hm</HelpResIdsFile>

      <HelpSynonymTopicsFile>%(RootDir)%(Directory)..\synonymtopics.txt</HelpSynonymTopicsFile>
      <HelpIgnoreTopicsFile>%(RootDir)%(Directory)..\ignoretopics.txt</HelpIgnoreTopicsFile>
      <CppHelpIndexMapFile>%(RootDir)%(Directory)..\helpindex.h</CppHelpIndexMapFile>
      <CppHelpContextMapFile>%(RootDir)%(Directory)..\helpcontext.h</CppHelpContextMapFile>
      
      <HhpTmpFile>%(RootDir)%(Directory)_zou.%(FileName)%(Extension)</HhpTmpFile>
      <HhcStdLogFile>%(RootDir)%(Directory)_errorlog.txt</HhcStdLogFile>
      <HhcLogFile>$(IntDir)%(FileName).hhc.log</HhcLogFile>
      <ExcludedFromBuild>false</ExcludedFromBuild>
    </HelpProject>
  </ItemDefinitionGroup>
  
  <Target Name="_InitHelpProject" Returns="%(HelpProject.Identity)">
    <ReadLinesFromFile File="%(HelpProject.FullPath)">
      <Output TaskParameter="Lines" ItemName="_SourceFile" />
    </ReadLinesFromFile>

    <PropertyGroup>
      <_SourceFile>@(_SourceFile)</_SourceFile>
      <_OptionsSection>$([System.Text.RegularExpressions.Regex]::Match($(_SourceFile), '(?&lt;=\[OPTIONS\])[^\[]*'))</_OptionsSection>
      <_FilesSection>$([System.Text.RegularExpressions.Regex]::Match($(_SourceFile), '(?&lt;=\[FILES\])[^\[]*'))</_FilesSection>
      <_CompiledFile>$([System.Text.RegularExpressions.Regex]::Match($(_OptionsSection.ToLower()), '(?&lt;=compiled file=)[^;]*'))</_CompiledFile>
      <_HelpIndexTopic>$([System.Text.RegularExpressions.Regex]::Match($(_OptionsSection.ToLower()), '(?&lt;=default topic=)[^;]*'))</_HelpIndexTopic>
    </PropertyGroup>

    <ItemGroup>
      <_CompiledFile Include="%(HelpProject.RootDir)%(Directory)$(_CompiledFile)" />
    </ItemGroup>
    
    <PropertyGroup>
      <_CompiledFile>%(_CompiledFile.FullPath)</_CompiledFile>
      <_HelpFile>$(OutDir)%(_CompiledFile.Filename)%(_CompiledFile.Extension)</_HelpFile>
    </PropertyGroup>

    <!-- Be sure index topic is in files section -->
    <ItemGroup>
      <_Temporary Include="$(_FilesSection)" />
      <_Temporary Remove="$(_HelpIndexTopic)" />
      <_Temporary Include="$(_HelpIndexTopic)" />
    </ItemGroup>
    
    <PropertyGroup>
      <_FilesSection>@(_Temporary)</_FilesSection>
    </PropertyGroup>

    <ItemGroup>
      <_Temporary Remove="$(_Temporary)" />
      
      <HelpProject>
        <HelpIndexTopic>$(_HelpIndexTopic)</HelpIndexTopic>
        <HelpContextTopics>$(_FilesSection)</HelpContextTopics>
        <CompiledFile>$(_CompiledFile)</CompiledFile>
        <HelpFile>$(_HelpFile)</HelpFile>
      </HelpProject>
      <_SourceFile Remove="@(_SourceFile) " />
      <_SourceFile Include="%(HelpProject.RootDir)%(Directory)**\*" Exclude="%(HelpProject.HhpTmpFile)" />
      <_SourceFile Include="%(HelpProject.FullPath)" KeepDuplicates="false" />
      <HelpProject>
        <SourceFiles>@(_SourceFile)</SourceFiles>
      </HelpProject>
      <_SourceFile Remove="@(_SourceFile)" />
    </ItemGroup>
    
    <!-- Clean locals -->
    <PropertyGroup>
      <_SourceFile></_SourceFile>
      <_OptionsSection></_OptionsSection>
      <_FilesSection></_FilesSection>
      <_CompiledFile></_CompiledFile>
      <_HelpFile></_HelpFile>
      <_HelpIndexTopic></_HelpIndexTopic>
    </PropertyGroup>

    <LogItems Items="@(HelpProject)" AllMetaData="true"/>
  </Target>

  <!--=========================================================================-->
  <!-- C/C++ Help Map -->
  <!--=========================================================================-->

  <Target Name="_ConcatWithMfcHmFile">
    <ItemGroup>
      <HelpResIdsFile Include="%(HelpProject.HelpResIdsFile)" />
      <HelpResIdsFile Include="$(MFCIncludeDir)afxhelp.hm" />
    </ItemGroup>
    <ReadLinesFromFile File="%(HelpResIdsFile.FullPath)" >
      <Output TaskParameter="Lines" ItemName="_SourceFile"/>
    </ReadLinesFromFile>
    <WriteLinesToFile File="%(HelpProject.HelpResIdsFile)" Lines="@(_SourceFile)" Overwrite="true"/>
    <ItemGroup>
      <_SourceFile Remove="@(_SourceFile)" />
    </ItemGroup>
  </Target>

  <Target Name="_CreateHmFile" Inputs="%(HelpProject.CppResIdsFile)" Outputs="%(HelpResIdsFile)">
    <Delete Files="%(HelpProject.HelpResIdsFile)" />
    <PropertyGroup>
      <HelpIdMappingRules>%(HelpProject.HelpIdMappingRules)</HelpIdMappingRules>
      <HelpIdMappingRules>$(HelpIdMappingRules.Replace(';', ' '))</HelpIdMappingRules>
    </PropertyGroup>
    <Exec Command='"$(MakeHm)" $(HelpIdMappingRules) "%(HelpProject.CppResIdsFile)" &gt;&gt;"%(HelpResIdsFile)"' />
    <CallTarget Targets="_ConcatWithMfcHmFile" Condition="'$(UseOfMfc)' != 'false' And '$(UseOfMfc)' != ''" />
  </Target>

  <Target Name="_CreateCppHelpMap" DependsOnTargets="_InitHelpProject;_CreateHmFile" Inputs="%(HelpProject.HelpResIdsFile);%(HelpIgnoreTopicsFile);%(HelpSynonymTopicsFile)" Outputs="%(CppHelpContextMapFile)">
    <ReadLinesFromFile File="%(HelpProject.HelpResIdsFile)">
      <Output TaskParameter="Lines" ItemName="_HelpContextId" />
    </ReadLinesFromFile>
    
    <ReadLinesFromFile File="%(HelpProject.HelpIgnoreTopicsFile)">
      <Output TaskParameter="Lines" ItemName="_HelpIgnoreTopic" />
    </ReadLinesFromFile>
    
    <ReadLinesFromFile File="%(HelpProject.HelpSynonymTopicsFile)">
      <Output TaskParameter="Lines" ItemName="_HelpSynonymTopic" />
    </ReadLinesFromFile>

    <CreateHelpMap HelpContextIds="@(_HelpContextId)"
                   HelpIndexTopic="%(HelpProject.HelpIndexTopic)"
                   HelpContextTopics="%(HelpProject.HelpContextTopics)"
                   HelpIgnoreTopics="@(_HelpIgnoreTopic)"
                   HelpSynonymTopics="@(_HelpSynonymTopic)">
      <Output TaskParameter="HelpIndexMappings"   ItemName="_HelpIndexMapping" />
      <Output TaskParameter="HelpContextMappings" ItemName="_HelpContextMapping" />
    </CreateHelpMap>
    
    <WriteLinesToFile File="%(HelpProject.CppHelpIndexMapFile)" Lines="@(_HelpIndexMapping)" Overwrite="true" />
    <WriteLinesToFile File="%(HelpProject.CppHelpContextMapFile)" Lines="@(_HelpContextMapping)" Overwrite="true" />

    <ItemGroup>
      <_HelpContextId Remove="@(_HelpContextId)" />
      <_HelpIgnoreTopic Remove="@(_HelpIgnoreTopic)" />
      <_HelpSynonymTopic Remove="@(_HelpSynonymTopic)" />
      <_HelpIndexMapping Remove="@(_HelpIndexMapping)" />
      <_HelpContextMapping Remove="@(_HelpContextMapping)" />
    </ItemGroup>
  </Target>
  
  <Target Name="_DeleteHmFiles">
    <Delete Files="%(HelpProject.HelpResIdsFile)" />
    <Delete Files="%(HelpProject.CppHelpIndexMapFile)" />
    <Delete Files="%(HelpProject.CppHelpContextMapFile)" />
  </Target>

  <Target Name="_HmClean"   DependsOnTargets="_DeleteHmFiles" AfterTargets="Clean"/>
  <Target Name="_HmBuild"   DependsOnTargets="_CreateCppHelpMap" BeforeTargets="ClCompile" Condition="'@(HelpProject)' != ''"/>
  <Target Name="_HmRebuild" DependsOnTargets="_HmClean;_HmBuild"/>

  <!--=========================================================================-->
  <!-- Help compilation -->
  <!--=========================================================================-->

  <Target Name="_HcInit">
    <ItemGroup>
      <_ExcludedFromBuild Include="%(HelpProject.Identity)" Condition="'%(ExcludedFromBuild)' == 'true'" />
      <HelpProject Remove="@(_ExcludedFromBuild)" />
      <_ExcludedFromBuild Remove="@(_ExcludedFromBuild)" />
    </ItemGroup>
  </Target>

  <Target Name="_HcCore" DependsOnTargets="_InitHelpProject" Inputs="%(HelpProject.SourceFiles)" Outputs="%(HelpProject.HelpFile)">
    <!-- Execute the MS crazy help compiler (HHC) and redirect its output to custom log file -->
    <Exec Command='"$(Hhc)" "%(HelpProject.FullPath)" &gt;"%(HelpProject.HhcLogFile)"' IgnoreExitCode='true' />
    <Delete Files="%(HelpProject.HhcStdLogFile);%(HelpFile)" />
    <Move SourceFiles="%(HelpProject.CompiledFile)" DestinationFiles="%(HelpFile)" />
  </Target>

  <Target Name="_HcErrorsAndWarnings" DependsOnTargets="_HcCore" Outputs="%(HelpProject.Identity)" Condition="'@(HelpProject)' != ''">
    <!-- Parse log file for errors and convert them to MSBuild format -->
    <ReadLinesFromFile File="%(HelpProject.HhcLogFile)">
      <Output TaskParameter="Lines" ItemName="_SourceFile"/>
    </ReadLinesFromFile>
    <PropertyGroup>
      <_SourceFile>@(_SourceFile)</_SourceFile>
      <_HhpPath>%(HelpProject.FullPath)</_HhpPath>
    </PropertyGroup>
    <ItemGroup>
      <_SourceFile Remove="@(_SourceFile)" />
      <_HhcError Include="$([System.Text.RegularExpressions.Regex]::Matches($(_SourceFile), 'HHC\w+:\s*Error:[^;]*'))" />
      <_HhcWarning Include="$([System.Text.RegularExpressions.Regex]::Matches($(_SourceFile), 'HHC\w+:\s*Warning:[^;]*'))" />
    </ItemGroup>
    <!-- Fix for Visual Studio -->
    <CallTarget Targets="_DeleteLastBuildState" Condition="'%(_HhcError.Identity)' != ''" />
    <!-- Log MSBuild errors and warnings -->
    <Error File="$(_HhpPath)"
           Condition="'%(_HhcError.Identity)' != ''"
           Code="$([System.Text.RegularExpressions.Regex]::Match(%(Identity), 'HHC[^:]+'))"
           Text="$([System.Text.RegularExpressions.Regex]::Match(%(Identity), '(?&lt;=HHC\w+:\s*Error:\s*).*'))"
           ContinueOnError="ErrorAndContinue" />
    <Warning File="$(_HhpPath)"
           Condition="'%(_HhcWarning.Identity)' != ''"
           Code="$([System.Text.RegularExpressions.Regex]::Match(%(Identity), 'HHC[^:]+'))"
           Text="$([System.Text.RegularExpressions.Regex]::Match(%(Identity), '(?&lt;=HHC\w+:\s*Warning:\s*).*'))" />

    <PropertyGroup>
      <_SourceFile></_SourceFile>
      <_HhpPath></_HhpPath>
    </PropertyGroup>
    <ItemGroup>
      <_HhcError Remove="@(_HhcError)" />
      <_HhcWarning Remove="@(_HhcWarning)" />
    </ItemGroup>
  </Target>

  <Target Name="_DeleteHhcFiles" DependsOnTargets="_InitHelpProject">
    <Delete Files="%(HelpProject.HhpTmpFile);%(HelpFile);%(HhcStdLogFile);%(HhcLogFile)" />
  </Target>

  <Target Name="_HcClean"   DependsOnTargets="_DeleteHhcFiles" AfterTargets="Clean" />
  <Target Name="_HcBuild"   DependsOnTargets="_HcInit;_HcCore;_HcErrorsAndWarnings" AfterTargets="Build" Condition="'@(HelpProject)' != ''"/>
  <Target Name="_HcRebuild" DependsOnTargets="_HcClean;_HcBuild" />
</Project>