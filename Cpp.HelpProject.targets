<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!-- Help Project Property Page -->
  <ItemGroup>
    <PropertyPageSchema Include="$(MSBuildThisFileDirectory)Cpp.HelpProject.xml" />
    <AvailableItemName Include="HelpProject">
      <Targets>_HcBuild</Targets>
    </AvailableItemName>
  </ItemGroup>

  <!--=========================================================================-->
  <!-- Constants -->
  <!--=========================================================================-->

  <PropertyGroup>
    <MakeHm>$(VsToolsDir)makehm.exe</MakeHm>
    <Hhc>$(ZouBinDir)hhc.exe</Hhc>
  </PropertyGroup>

  <ItemGroup>
      <!--
        // see afxpriv.h
        // Help ID bases
        #define HID_BASE_COMMAND    0x00010000UL        // ID and IDM
        #define HID_BASE_RESOURCE   0x00020000UL        // IDR and IDD
        #define HID_BASE_PROMPT     0x00030000UL        // IDP
        #define HID_BASE_NCAREAS    0x00040000UL
        #define HID_BASE_CONTROL    0x00050000UL        // IDC
        #define HID_BASE_DISPATCH   0x00060000UL        // IDispatch help codes
      -->
    <_HelpIdMappingRule Include="ID_,HID_,0x10000" />
    <_HelpIdMappingRule Include="IDM_,HIDM_,0x10000" />
    <_HelpIdMappingRule Include="IDR_,HIDR_,0x20000" />
    <_HelpIdMappingRule Include="IDD_,HIDD_,0x20000" />
    <_HelpIdMappingRule Include="IDP_,HIDP_,0x30000" />
    <_HelpIdMappingRule Include="IDC_,HIDC_,0x50000" />
    <_HelpIdMappingRule Include="IDW_,HIDW_,0x50000" />
  </ItemGroup>
  <PropertyGroup>
      <_HelpIdMappingRules>@(_HelpIdMappingRule)</_HelpIdMappingRules>
  </PropertyGroup>

  <!--=========================================================================-->
  <!-- Initialization -->
  <!--=========================================================================-->

  <ItemDefinitionGroup>
    <HelpProject>
      <CommandLineTemplate>
        "$(MakeHm)" [HelpIdMappingRules] "[CppResIdsFile]" "[HelpResIdsFile]"
      </CommandLineTemplate>
      <HelpIdMappingRules>$(_HelpIdMappingRules)</HelpIdMappingRules>
      <CppResIdsFile>resource.h</CppResIdsFile>
      <HelpResIdsFile>$(IntDir)resource.hm</HelpResIdsFile>

      <HelpSynonymTopicsFile>%(RootDir)%(Directory)..\synonymtopics.txt</HelpSynonymTopicsFile>
      <HelpIgnoreTopicsFile>%(RootDir)%(Directory)..\ignoretopics.txt</HelpIgnoreTopicsFile>
      <CppHelpIndexMapFile>%(RootDir)%(Directory)..\helpindex.h</CppHelpIndexMapFile>
      <CppHelpContextMapFile>%(RootDir)%(Directory)..\helpcontext.h</CppHelpContextMapFile>
      <HelpFile>$(OutDir)%(FileName).chm</HelpFile>
      
      <HhpTmpFile>%(RootDir)%(Directory)_zou.%(FileName)%(Extension)</HhpTmpFile>
      <LogFile>%(RootDir)%(Directory)_errorlog.txt</LogFile>
      <ExcludedFromBuild>false</ExcludedFromBuild>
    </HelpProject>
  </ItemDefinitionGroup>

  <!--=========================================================================-->
  <!-- C/C++ Help Map -->
  <!--=========================================================================-->

  <Target Name="_ConcatWithMfcHmFile">
    <ItemGroup>
      <HelpResIdsFile Include="%(HelpProject.HelpResIdsFile)" />
      <HelpResIdsFile Include="$(MFCIncludeDir)afxhelp.hm" />
    </ItemGroup>
    <ReadLinesFromFile File="%(HelpResIdsFile.FullPath)" >
      <Output TaskParameter="Lines" ItemName="_SourceFile"/>
    </ReadLinesFromFile>
    <WriteLinesToFile File="%(HelpProject.HelpResIdsFile)" Lines="@(_SourceFile)" Overwrite="true"/>
    <ItemGroup>
      <_SourceFile Remove="@(_SourceFile)" />
    </ItemGroup>
  </Target>

  <Target Name="_CreateHmFile" Inputs="%(HelpProject.CppResIdsFile)" Outputs="%(HelpResIdsFile)">
    <Delete Files="%(HelpProject.HelpResIdsFile)" />
    <PropertyGroup>
      <HelpIdMappingRules>%(HelpProject.HelpIdMappingRules)</HelpIdMappingRules>
      <HelpIdMappingRules>$(HelpIdMappingRules.Replace(';', ' '))</HelpIdMappingRules>
    </PropertyGroup>
    <Exec Command='"$(MakeHm)" $(HelpIdMappingRules) "%(HelpProject.CppResIdsFile)" &gt;&gt;"%(HelpResIdsFile)"' />
    <CallTarget Targets="_ConcatWithMfcHmFile" Condition="'$(UseOfMfc)' != 'false' And '$(UseOfMfc)' != ''" />
  </Target>

  <Target Name="_GetHelpTopics" DependsOnTargets="_CreateHmFile">
    <ReadLinesFromFile File="%(HelpProject.FullPath)">
      <Output TaskParameter="Lines" ItemName="_SourceFile" />
    </ReadLinesFromFile>
    
    <PropertyGroup>
      <_SourceFile>@(_SourceFile)</_SourceFile>
      <_OptionsSection>$([System.Text.RegularExpressions.Regex]::Match($(_SourceFile), '(?&lt;=\[OPTIONS\])[^\[]*'))</_OptionsSection>
      <_FilesSection>$([System.Text.RegularExpressions.Regex]::Match($(_SourceFile), '(?&lt;=\[FILES\])[^\[]*'))</_FilesSection>
      <_SourceFile></_SourceFile>
    </PropertyGroup>
    <PropertyGroup>
      <_HelpIndexTopic>$([System.Text.RegularExpressions.Regex]::Match($(_OptionsSection), '(?&lt;=Default Topic=)[^;]*'))</_HelpIndexTopic>
    </PropertyGroup>
    <ItemGroup>
      <_HelpContextTopic Include="$(_FilesSection)" />
      <_SourceFile Remove="@(_SourceFile) " />
    </ItemGroup>

    <!--<Message Importance="high" Text="_HelpContextTopic=%(_HelpContextTopic.Identity)" />-->
  </Target>

  <Target Name="_CreateCppHelpMap" DependsOnTargets="_GetHelpTopics" Inputs="%(HelpProject.HelpResIdsFile);%(HelpIgnoreTopicsFile);%(HelpSynonymTopicsFile)" Outputs="%(CppHelpIndexMapFile);%(CppHelpContextMapFile)">
    <ReadLinesFromFile File="%(HelpProject.HelpResIdsFile)">
      <Output TaskParameter="Lines" ItemName="_HelpContextId" />
    </ReadLinesFromFile>
    <!--<Message Importance="high" Text="_HelpContextId = %(_HelpContextId.Identity)" />-->
    
    <ReadLinesFromFile File="%(HelpProject.HelpIgnoreTopicsFile)">
      <Output TaskParameter="Lines" ItemName="_HelpIgnoreTopic" />
    </ReadLinesFromFile>
    <!--<Message Importance="high" Text="_HelpIgnoreTopic = %(_HelpIgnoreTopic.Identity)" />-->
    
    <ReadLinesFromFile File="%(HelpProject.HelpSynonymTopicsFile)">
      <Output TaskParameter="Lines" ItemName="_HelpSynonymTopic" />
    </ReadLinesFromFile>
    <!--<Message Importance="high" Text="_HelpSynonymTopic = %(_HelpSynonymTopic.Identity)" />-->

    <CreateHelpMap HelpContextIds="@(_HelpContextId)"
                   HelpIndexTopic="$(_HelpIndexTopic)"
                   HelpContextTopics="@(_HelpContextTopic)"
                   HelpIgnoreTopics="@(_HelpIgnoreTopic)"
                   HelpSynonymTopics="@(_HelpSynonymTopic)">
      <Output TaskParameter="HelpIndexMappings"   ItemName="_HelpIndexMapping" />
      <Output TaskParameter="HelpContextMappings" ItemName="_HelpContextMapping" />
    </CreateHelpMap>
    
    <WriteLinesToFile File="%(HelpProject.CppHelpIndexMapFile)" Lines="@(_HelpIndexMapping)" Overwrite="true" />
    <!--<Message Importance="high" Text="%(_HelpIndexMapping.Identity)" />-->

    <WriteLinesToFile File="%(HelpProject.CppHelpContextMapFile)" Lines="@(_HelpContextMapping)" Overwrite="true" />
    <!--<Message Importance="high" Text="%(_HelpContextMapping.Identity)" />-->

    <ItemGroup>
      <_HelpContextId Remove="@(_HelpContextId)" />
      <_HelpIndexTopic Remove="@(_HelpIndexTopic)" />
      <_HelpContextTopic Remove="@(_HelpContextTopic)" />
      <_HelpIgnoreTopic Remove="@(_HelpIgnoreTopic)" />
      <_HelpSynonymTopic Remove="@(_HelpSynonymTopic)" />
      <_HelpIndexMapping Remove="@(_HelpIndexMapping)" />
      <_HelpContextMapping Remove="@(_HelpContextMapping)" />
    </ItemGroup>
  </Target>
  
  <Target Name="_DeleteHmFiles">
    <Delete Files="%(HelpProject.HelpResIdsFile)" />
    <Delete Files="%(HelpProject.CppHelpMapFile)" />
  </Target>

  <Target Name="_HmClean"   DependsOnTargets="_DeleteHmFiles" AfterTargets="Clean"/>
  <Target Name="_HmBuild"   DependsOnTargets="_CreateCppHelpMap" BeforeTargets="ClCompile" />
  <Target Name="_HmRebuild" DependsOnTargets="_HmClean;_HmBuild"/>

  <!--=========================================================================-->
  <!-- Help compilation -->
  <!--=========================================================================-->

  <Target Name="_HcInit">
    <ItemGroup>
      <_ExcludedFromBuild Include="%(HelpProject.Identity)" Condition="'%(ExcludedFromBuild)' == 'true'" />
      <HelpProject Remove="@(_ExcludedFromBuild)" />
      <_ExcludedFromBuild Remove="@(_ExcludedFromBuild)" />
    </ItemGroup>
  </Target>

  <Target Name="_AssignHelpSourceFiles" Returns="%(HelpProject.Identity)">
    <ItemGroup>
      <_SourceFile Include="%(HelpProject.RootDir)%(Directory)**\*" />
      <_SourceFile Include="%(HelpProject.FullPath)" KeepDuplicates="false" />
      <HelpProject>
        <SourceFiles>@(_SourceFile)</SourceFiles>
      </HelpProject>
      <_SourceFile Remove="@(_SourceFile)" />
    </ItemGroup>
  </Target>

  <Target Name="_HcCore" DependsOnTargets="_AssignHelpSourceFiles" Inputs="%(HelpProject.SourceFiles)" Outputs="%(HelpProject.HelpFile)">
    <!-- Replace the path of the output file (.chm) inside the help project file -->
    <Copy SourceFiles="%(HelpProject.FullPath)" DestinationFiles="%(HhpTmpFile)" />
    <FileUpdate Files="%(HelpProject.HhpTmpFile)" Encoding="windows-1252"
                Regex='^(\s*Compiled File\s*=\s*).*[^\r\n]'
                ReplacementText="$1%(HelpProject.HelpFile)"
                Multiline="true"
                IgnoreCase="true"/>

    <!-- Execute the help compiler (HHC) and redirect its output to NUL -->
    <Exec Command='"$(Hhc)" "%(HelpProject.HhpTmpFile)" &gt;NUL' IgnoreExitCode='true' />
    <Delete Files="%(HelpProject.HhpTmpFile)" />
  </Target>

  <Target Name="_CheckForHcError" DependsOnTargets="_HcCore" Condition="'@(HelpProject)' != ''">
    <!-- Parse log file for errors and convert them to MSBuild format -->
    <ReadLinesFromFile File="%(HelpProject.LogFile)">
      <Output TaskParameter="Lines" ItemName="_SourceFile"/>
    </ReadLinesFromFile>
    <PropertyGroup>
      <_SourceFile>@(_SourceFile)</_SourceFile>
      <_HhpPath>%(HelpProject.FullPath)</_HhpPath>
    </PropertyGroup>
    <ItemGroup>
      <_SourceFile Remove="@(_SourceFile)" />
      <_HhcError Include="$([System.Text.RegularExpressions.Regex]::Matches($(_SourceFile), 'HHC\w+:\s*Error:[^;]*'))" />
    </ItemGroup>
    <!-- Fix for Visual Studio -->
    <CallTarget Targets="_DeleteLastBuildState" Condition="'%(_HhcError.Identity)' != ''" />
    <!-- -->
    <Error File="$(_HhpPath)"
           Condition="'%(_HhcError.Identity)' != ''"
           Code="$([System.Text.RegularExpressions.Regex]::Match(%(Identity), 'HHC[^:]+'))"
           Text="$([System.Text.RegularExpressions.Regex]::Match(%(Identity), '(?&lt;=HHC\w+:\s*Error:\s*).*'))" />

    <Delete Files="%(HelpProject.LogFile)" />
    <PropertyGroup>
      <_SourceFile></_SourceFile>
      <_HhpPath></_HhpPath>
    </PropertyGroup>
  </Target>

  <Target Name="_DeleteHhcFiles">
    <Delete Files="%(HelpProject.HhpTmpFile);%(HelpFile)" />
  </Target>

  <Target Name="_HcClean"   DependsOnTargets="_DeleteHhcFiles" AfterTargets="Clean" />
  <Target Name="_HcBuild"   DependsOnTargets="_HcInit;_HcCore;_CheckForHcError" AfterTargets="Build" />
  <Target Name="_HcRebuild" DependsOnTargets="_HcClean;_HcBuild" />
</Project>