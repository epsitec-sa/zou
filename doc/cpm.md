# [<](vcxproj-zouification.md)

# Gestion centralisée des paquets nuget ([CPM](https://learn.microsoft.com/en-us/nuget/consume-packages/central-package-management))

La gestion centralisée des paquets `nuget` ainsi que la mise à jour des versions est supportée par `zou` de manière centralisée et semi-automatique.

Pour l'activer dans un *bundle*, il suffit d'ajouter:
- le sous-module `zou`
- le script `<bundle>/Directory.Packages.props` suivant:
```
<Project>
  <Import Project="zou\Directory.Packages.Default.props" />
</Project>
```

# Infrastructure
La mise en oeuvre du CPM de `zou` nécessite l'utilisation de la commande `zou nupkg` ainsi que l'infrastructure *MSBuild* suivante:
```
[<bundle>]
  |- Directory.Packages.props               # redirect to zou/Directory.Packages.Default.props
  |-[zou]
     |- Directory.Packages.Default.props    # CPM database selector (floating|freezed[netX])
     |- Directory.Packages.Floating.props   # floating versions
     |- Directory.Packages.net6.props       # freezed versions for net6 [1]
     |- Directory.Packages.net8.props       # freezed versions for net8 [1]
     |- Directory.Packages.net9.props       # freezed versions for net9 [1]
     '-[Nupkg]
        |- Nupkg.csproj   # nuget packages management project
        '- Nupkg.sln      # nuget packages management solution

[1] generated by 'zou nupkg'
```

## [`Directory.Packages.Default.props`](../Directory.Packages.Default.props) - le sélecteur de la base des versions
Ce script permet d'activer le CPM de *MSBuild* et de sélectionner une des bases de versions suivante:
- la base flottante → [`Directory.Packages.Floating.props`](../Directory.Packages.Default.props);
- une des bases gelées → `Directory.Packages.netX.props`;

Le chemin vers cette base dépend de la propriété `CpmId`.
Il est calculé comme suit:
```
CpmPath = Directory.Packages.$(CpmId).props
if (!Exists(CpmPath)) CpmPath = Directory.Packages.Floating.props
```

La valeur par défaut de la propriété `CpmId` dépend de la version majeure du framework .NET Core utilisé.
```
CpmId ::=  (net6|net8|net9...)
```
On peut forcer l'utilisation de la base flottante avec l'option `/p:CpmId=Floating`.

## [`Directory.Packages.Floating.props`](../Directory.Packages.Floating.props) - la base des versions flottantes
La restauration des paquets `nuget` (`dotnet restore`) supporte les [versions flottantes](https://learn.microsoft.com/en-us/nuget/concepts/dependency-resolution#floating-versions) (ex: `6.0.*`).

### Remarques:
- la base supporte plusieurs *framework*s
- uniquement les patchs de version sont flottants;
- les versions mineures ou majeures doivent être mises à jour manuellement;
- le *build* n'utilise pas cette base directement car les versions sont non déterministes;
- le *build* utilise une des bases gelées (voir ci-dessous).

### Format
La base est organisée en différentes sections contrôlées ou non par des conditions de compatibilité de *framework*.
Les dernières sections sont des sections de contrainte (paquets payants, licences, ...)

Prenons par exemple le paquet `GdPicture.API`.
Il apparaît plusieurs fois dans la base:
- une première fois dans la section `CpmTFM >= net6`;
```
  ...
  <!-- netstandard or CpmTFM >= net6 -->
  <ItemGroup>
    ...
    <PackageVersion Include="GdPicture.API" Version="14.2.*" /> <!-- net6 -->
    ...
  <ItemGroup>
```
- une deuxième fois dans la section `CpmTFM >= net8`;
```
  ...
  <!-- CpmTFM >= net8 -->
  <ItemGroup Condition="$([MSBuild]::IsTargetFrameworkCompatible('$(CpmTFM)', 'net8'))">
    ...
    <PackageVersion Update="GdPicture.API" Version="14.3.*" /> <!-- net8 -->
    ...
  <ItemGroup>
```
- une 3ème fois dans la section `Licensed packages (netstandard or CpmTFM >= net6)`;
```
  <!-- Licensed packages (netstandard or CpmTFM >= net6) -->
  <ItemGroup>
    <PackageVersion Update="GdPicture.API"  Version="14.2.*" /> <!-- net6 -->
    ...
  </ItemGroup>
```
- une 4ème fois dans la section `Licensed packages (CpmTFM >= net8)`;
```
  <!-- Licensed packages (CpmTFM >= net8) -->
  <ItemGroup Condition="$([MSBuild]::IsTargetFrameworkCompatible('$(CpmTFM)', 'net8'))">
    <PackageVersion Update="GdPicture.API" Version="14.3.*" /> <!-- net8 -->
    ...
  </ItemGroup>
```

### Notes:
- le commentaire de fin de ligne indiquant les frameworks supportés par les versions du paquet;
- le mot clé **`Include`** lors de la 1ère apparition;
- le mot clé **`Update`** lors des apparitions suivantes.
- dans l'`ItemGroup` parent:
  - aucune `Condition` pour le *framework* le plus *ancien*;
  - une `Condition` de compatibilité pour les autres;
    - `$([MSBuild]::IsTargetFrameworkCompatible('$(CpmTFM)', 'net8'))`
- les différentes sections se suivent par ordre croissant de *framework*:
  - la 1ère est compatible avec tous les frameworks;
  - la 2ème avec `net8`;
  - etc...
- les versions des paquets sous licence, payants ou problématiques apparaissent dans les dernières sections avec des commentaires indiquant la raison du déclassement.

**IMPORTANT**: ce format doit être respecté lors de l'ajout d'un paquet.

## Directory.Packages.netX.props - les bases des versions gelées (une par *framework*)
Ces bases sont générées par la commande `zou nupkg`.

### Le problème
Le [processus de *lock* des dépendances](https://learn.microsoft.com/en-us/nuget/consume-packages/package-references-in-project-files#locking-dependencies) proposé par Microsoft est difficile à mettre en oeuvre.
Il nécessite différentes étapes qui s'intègrent difficilement dans les processus de *build* et de contrôle des sources (fichiers de *lock* à commiter dans tous les sous-modules, propriété `RestorePackagesWithLockFile`, ligne de commande `dotnet restore --locked-mode`, etc...).

### La solution
Pour remédier à cela, `zou` propose une solution centralisée et élégante qui ne nécessite aucun fichier de *lock*. Après avoir mis à jour manuellement la base flottante, la commande `zou nupkg` permet de générer et de *commiter* dans le dépôt les bases *gelées*, une pour chaque version majeure du *framework*. La mise à jour des versions ne nécessite donc que des modifications dans le sous-module `zou`.

## [`NuPkg/NuPkg.csproj`](../NuPkg/NuPkg.csproj) - le projet de maintenance
Le projet `NuPkg.csproj` permet de construire une librairie qui dépend de tous les paquets `nuget` dont la version est définie dans la base des versions active (soit flottante soit gelée en fonction du paramètre `CpmId`).

La commande `zou nupkg` utilise ce projet pour générer les bases gelées.

## Mise à jour des patchs de version
Pour mettre à jour les patchs de version, il suffit de lancer la commande `zou nupkg` dans un dossier quelconque d'un' *bundle* contenant le sous-module `zou`.
```
cd <bundle-dir>
zou nupkg
```
Pour chaque *framework* spécifié, la commande `zou nupkg` regénère une base de versions gelées en restaurant le projet `NuPkg.csproj` via la base de versions flottantes.
Le pseudo-code de la commande ressemble à ceci:
```
ZouNuPkg(int[] frameworkMajorVersions, bool noCommit)
{
  foreach(majorVersion in frameworkMajorVersions)
  {
    TFM = $"net{majorVersion}"
    `dotnet restore --force-evaluate NuPkg.proj /p:CoreTargetFramework={TFM};CpmId=Floating`
    `dotnet list NuPkg.csproj package --format json`
      | ParseAndTransformToMSBuildScript
      | SaveTo($"$Directory.Packages.{TFM}.props")
    `dotnet build NuPkg.csproj /p:CoreTargetFramework={TFM}`
  }
  if (!noCommit && success) CommitAll
}
```

## Mise à jour des versions mineures/majeures
Pour mettre à jour les versions mineures/majeures, il faut éditer la [base flottante](../Directory.Packages.Floating.props).

**IMPORTANT**: n'oubliez pas de mettre à jour les versions de toutes les instances de `PackageVersion` (dans toutes les sections).

## Ajout d'un paquet nuget
Pour ajouter un paquet nuget, il faut, comme pour la màj des versions mineures/majeures, éditer la [base flottante](../Directory.Packages.Floating.props).

- ajouter le paquet d'abord dans la première section `netstandard or CpmTFM >= net6` avec une version qui respecte cette condition en utilisant le mot clé `Include`:
```
    <PackageVersion Include="GdPicture.API" Version="14.2.*" /> <!-- net6 -->
```
- puis dans les sections suivantes si nécessaires avec le mot clé `Update`:
```
    <PackageVersion Update="GdPicture.API" Version="14.3.*" /> <!-- net8 -->
```

## Technique d'édition de la base des versions flottantes
Pour faciliter l'édition de la base des versions flottantes, il est conseillé de travailler dans le bundle [`zou-dev`](https://git.epsitec.ch/Build/zou-dev).
Ce bundle est configuré pour travailler avec la dernière version en production du framework. 

 Après avoir cloné le bundle:

- préparez l'espace de travail:
  - ouvrez la solution [`zou-dev/zou/NuPkg.sln`](../NuPkg/NuPkg.sln) dans Visual Studio
  - maximisez la fenêtre et fermez tous les documents
  - ouvrez la base des versions flottantes &rarr; `Solution Explorer/.buid/Directory.Packages.Floating.props`
  - dans le menu contextuel du projet `NuPkg`, cliquez `Manage Nuget Packages...`
  - dans le menu contextuel de l'onglet `Nuget:NuPkg`, cliquez `New Vertical Document Group`
  - vous avez maintenant deux onglets visibles: le script et le gestionnaire de paquets.

- dans le sous-onglet `Nuget:NuPkg/Updates`, observez les mises à jour des versions:
  - s'il y a des paquets dont le patch peut être mis à jour:
    - lancez la commande `zou nupkg` depuis un sous dossier quelconque de `zou-dev`;
    - attendez la fin de la commande ainsi que les màj dans l'onglet `Nuget:NuPkg/Updates`;
    - il ne devrait plus y avoir de paquets avec une màj de patch (sauf s'il apparaît dans une section de contrainte).
  - s'il y a des paquets dont la version mineure/majeure peut être mise à jour:
    - vérifiez dans le script que ce paquet n'apparaît pas dans une section de contrainte;
    - si ce n'est pas le cas, affichez les détails du paquet en question;
    - les dépendances de framework affichées dans les détails vous permettent:
      - de déterminer la section parent de ce paquet dans laquelle mettre à jour ou ajouter la version;
      - de vérifier ou d'ajouter le commentaire de fin de ligne contenant la liste abrégée des *framework*s;
    - répétez ces opérations pour chaque paquet à mettre à jour;
    - commitez avec un message du style `CPM: update minor versions - package1, package2`;
    - relancez la commande `zou nupkg`.

**IMPORTANT**: respectez le format de la base s.v.p.
---
# [<](vcxproj-zouification.md)
