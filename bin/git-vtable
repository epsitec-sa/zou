#!/bin/bash

[[ -z $ZOUL_LOCK ]]               && . zoul-lock
[[ -z $ZOUL_GIT_VTABLE ]]         && . zoul-git-vtable
[[ -z $ZOUL_GIT_MODULE ]]         && . zoul-git-module
[[ -z $ZOUL_GIT_CONFIG_SKU ]]     && . zoul-git-config-sku
[[ -z $ZOUL_GIT_CONFIG_SELECT ]]  && . zoul-git-config-select

vtable_parse()
{
  while [[ "$#" > 0 ]]; do case "$1" in
    -h|--help) zou-help $0; exit 0;;
    -q|--quiet)           quiet=true;;
    -a|--all)             all=true;;
    -e|--stop-on-error)   stopOnError=true;;
    -j*)                  jobsCount=${1#-j};;
    -*) io_error "unknown option '$1'"; return 1;;
  esac; shift; done
}
vtable_run()
{
  local jobsCount quiet stopOnError all
  vtable_parse "$@" || return $?
  
  module_run vtable_main
}
vtable_main()
{
  local lockDir lookupPath
  lockDir=$(mktemp -u)
  lookupPath="$(mktemp)"
  vtable_init "$startupRoot" "$lookupPath"
  vtable_tree
}
vtable_tree()
{
  vtable_submodules
  if [[ "$PWD" == "$startupRoot" ]]; then
    vtable_update "$startupRoot" "$moduleId" "$lookupPath"
  else
    lock "$lockDir" 0.1 vtable_update "$startupRoot" "$moduleId" "$lookupPath"
  fi
}
vtable_submodules() { module_visit_submodules_async vtable_submodules_enumerator vtable_tree; }
vtable_submodules_enumerator()
{
  # io_warning ">>>> publish_submodules" "$moduleTracePrefix"
  local include exclude
  [[ $all == true ]] && include="${moduleSubmodulePaths[@]}" || include=$(config_sku_list_included)
  exclude=( $(config_select_list_excluded) )
  array_remove_array 'include[@]' 'exclude[@]'
}

vtable_run "$@"