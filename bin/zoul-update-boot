#!/usr/bin/env bash

gitx() { git -c core.longpaths=true "$@"; }

zou_setup()
{
  local NC='\e[0m' Red='\e[0;31m' Brown='\e[0;33m' Cyan='\e[0;36m' message

  cd "$zouBinDir"
  message="${Cyan}[zou]${NC} : ${Brown}Starting asynchronous update...${NC}"
  printf '\n%b' "$message"
  sleep .2
  message="${Cyan}[zou]${NC} : ${Cyan}Downloading, please wait...${NC}"
  printf '\n%b' "$message"
  if [[ -z $zouFakeUpdate ]]; then
    gitx fetch --prune --all &>/dev/null
    gitx fetch --tags --force &>/dev/null
    gitx checkout master &>/dev/null
    gitx pull &>/dev/null
  else
    _zou_create_fake_version_props
  fi

  message="${Cyan}[zou]${NC} : ${Cyan}Making a copy, please wait...${NC}"
  printf '\n%b' "$message"
  find . -maxdepth 1 -type f -iname 'zoul-*' -exec cp -P '{}' "$setupDir/{}" ';'
  find . -maxdepth 1 -type f -iname 'git*'   -exec cp -P '{}' "$setupDir/{}" ';'
  cp ../Version.props "$setupDir"
  
  printf '\n'
  export PATH="$setupDir:$PATH"

  zoul-update "$@"

  chmod a+x "$zouBinDir"/git*
  chmod a+x "$zouBinDir"/zou*

  # clean fake version.props
  if [[ -n $zouFakeUpdate ]]; then
    gitx checkout "$zouBinDir/../Version.props" &>/dev/null
  fi
}
zou_wait_launcher_exit()
{
  # register for launcher exiting event
  local launcherExiting=1
  trap "launcherExiting=0" USR1

  # notify launcher that we are listening
  kill -USR1 $PPID

  # wait for launcher to exit
  while [ $launcherExiting -ne 0 ]; do sleep .1; done
}

_zou_create_fake_version_props()
{
  cat >../Version.props <<\EOF
<Project>
  <PropertyGroup>
    <Version>57.57.57.5757</Version>
  </PropertyGroup>
</Project>
EOF
}

[[ -n $zouFakeUpdate ]] && printf '\n%s\n' "[FAKE UPDATE BOOT] zouBinDir=$1 setupDir=$2 ${*:3}" >&2

zouBinDir=$1
setupDir=$2
trap "rm -rf \"$setupDir\"" EXIT
zou_wait_launcher_exit
zou_setup "${@:3}"
