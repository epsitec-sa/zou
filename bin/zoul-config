#!/bin/bash

# Use the following statement to include current lib only once
#   [[ -z $ZOUL_CONFIG ]] && . zoul-config
ZOUL_CONFIG=true

[[ -z $ZOUL_CORE ]] && . zoul-core

config_setup()
{
  # remove obsolete value
  git config --global --unset 'zou.initialized'

  # zou-flow semantic versioning
  git config --global --remove-section versionsort &>/dev/null
  git config --global --add versionsort.suffix -@
  git config --global --add versionsort.suffix -alpha
  git config --global --add versionsort.suffix -beta
  git config --global --add versionsort.suffix -rc

  # do not push tags pointing at un-pushed commits automatically
  git config --global --unset push.followTags

  # update zou aliases
  local alias
  for alias in csku csel cver cpub smaster spull sclean oprune publish select attach; do
    git config --global --unset-all alias.$alias
  done
  git config --global --add alias.csku 'config-sku'
  git config --global --add alias.csel 'config-select'
  git config --global --add alias.cver 'config-version'
  git config --global --add alias.smaster 'sku enter master --dev'
  git config --global --add alias.spull 'sync -r -p'
  git config --global --add alias.sclean 'cleanex -r'
  git config --global --add alias.oprune 'fetch origin --prune'
  git config --global --add alias.publish '!printf '"'"'%b\n'"'"' '"'"'\e[0;31mThis command is deprecated, use \e[0;37mgit prod release\e[0;31m instead\e[0m'"'"''
  git config --global --add alias.select '!printf '"'"'%b\n'"'"' '"'"'\e[0;31mThis command is deprecated, use \e[0;37mgit (wip|dev|prod) enter\e[0;31m instead\e[0m'"'"''
  git config --global --add alias.attach '!printf '"'"'%b\n'"'"' '"'"'\e[0;31mThis command is deprecated, use \e[0;37mgit dev attach\e[0;31m instead\e[0m'"'"''
  git config --global --add alias.vbranch '!printf '"'"'%b\n'"'"' '"'"'\e[0;31mThis command is deprecated, use \e[0;37mgit dev release\e[0;31m instead\e[0m'"'"''
}
config_migrate_registered_bundles()
{
  local kv kvs key value
  IFS=$'\n' kvs=( $(git config --global --get-regexp '^zou\..*\.path$' 2>/dev/null) ); IFS=$OIFS
  for kv in "${kvs[@]}"; do
    [[ $kv =~ ^([^\ ]+)[[:blank:]]+(.*)$ ]]
    key=${BASH_REMATCH[1]}
    value=${BASH_REMATCH[2]}
    # io_trace "config_upgrade_registered_bundles -- $(print_vars key value)"
    if git config --global --unset "$key" "$value" &>/dev/null; then
      if ! git config --file "$zouConfigFile" --get-regexp "$key" "$value" >/dev/null; then
        git config --file "$zouConfigFile" --add "$key" "$value"
        cd "$value"
        git config --local --unset zou.bundle.registered &>/dev/null
        cd - >/dev/null
      fi
    fi
  done
}