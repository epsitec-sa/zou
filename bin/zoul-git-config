#!/bin/bash

# Use the following statement to include current lib only once
#   [[ -z $ZOUL_GIT_CONFIG ]] && . zoul-git-config
ZOUL_GIT_CONFIG=true

[[ -z $ZOUL_GIT_MODULE ]]        && . zoul-git-module
[[ -z $ZOUL_GIT_CONFIG_SKU ]]    && . zoul-git-config-sku
[[ -z $ZOUL_GIT_CONFIG_SELECT ]] && . zoul-git-config-select
[[ -z $ZOUL_GIT_BRANCH_SYNC ]]   && . zoul-git-branch-sync

# global options
#   noSkuFilter      -- process all level 0 submodules
#   noSelectFilter   -- process all level>0 submodules

# io_trace "headChangedEvent+=( _config_reset_scope )"
# io_trace "branchSyncEvent+=( _config_on_sync )"
headChangedEvent+=( _config_reset_scope )
branchSyncEvent+=( _config_on_sync )

# usage:
#   module_run config_scope $*
config_scope()
{
  # setup config context
  local configSkuInclude configSkuExclude \
        configSelectInclude configSelectExclude \
        configSelectIncludeBundlePaths configSelectExcludeBundlePaths \
        configScopeInitialized=true
  
  _config_reset_scope

  # execute next russian doll
  $1 "${@:2}"
}
config_has_submodules() { [ ${#configSelectInclude[@]} -gt 0 ]; }

config_list_external()
{
  if [[ $noSelectFilter == true ]]; then
    local external=( $(config_select_list_excluded moduleSubmodulePaths[@]) )
    external=( $(array_remove_array external[@] configSkuExclude[@]) )
    printf '%s\n' "${external[@]}"
  else
    printf '%s\n' "${configSelectExclude[@]}"
  fi
}
_config_on_sync()
{
  [[ $3 =~ ^\< ]] || return 0
  _config_reset_scope
}
_config_reset_scope()
{
  # io_trace "_config_reset_scope"

  [[ $configScopeInitialized == true ]] || return 0

  if [ ${#moduleSubmodulePaths[@]} -eq 0 ]; then
    configSkuExclude=()
    configSkuInclude=()
    configSelectExclude=()
    configSelectInclude=()
    configSelectIncludeBundlePaths=()
    configSelectExcludeBundlePaths=()
  else
    if [[ $noSkuFilter == true ]]; then
      configSkuExclude=()
      configSkuInclude=( ${moduleSubmodulePaths[@]} )
    else
      configSkuExclude=( $(config_sku_list_excluded) )
      configSkuInclude=( $(config_sku_list_included moduleSubmodulePaths[@] configSkuExclude[@]) )
    fi
    if [[ $noSelectFilter == true ]]; then
      configSelectExclude=()
      configSelectInclude=( ${configSkuInclude[@]} )
    else
      local exclude=( $(config_select_list_excluded moduleSubmodulePaths[@]) )
      local include=( $(config_select_list_included moduleSubmodulePaths[@]) )
      # io_trace "_config_reset_scope -- $(print_vars exclude[@] include[@])" ${Green}
      configSelectExclude=( $(array_remove_array exclude[@] configSkuExclude[@]) )
      configSelectInclude=( $(array_remove_array include[@] configSkuExclude[@]) )
    fi
    configSelectIncludeBundlePaths=( "${configSelectInclude[@]/#/$moduleBundlePath\/}" )
    configSelectExcludeBundlePaths=( "${configSelectExclude[@]/#/$moduleBundlePath\/}" )
    configSelectIncludeBundlePaths=( "${configSelectIncludeBundlePaths[@]#/}" )
    configSelectExcludeBundlePaths=( "${configSelectExcludeBundlePaths[@]#/}" )
  fi

  _config_trace true
}
_config_trace()
{
  [[ $zouTraceScope == true ]] || return 0

  io_lock_enter
  [[ -n $1 ]] && io_trace_unsafe "_config_reset_scope -- $(print_vars noSkuFilter noSelectFilter)"
  [[ -n $1 ]] && io_trace_unsafe "_config_reset_scope -- $(print_vars configSkuInclude[@])"
  [[ -n $1 ]] && io_trace_unsafe "_config_reset_scope -- $(print_vars configSkuExclude[@])"
  io_trace_unsafe "_config_reset_scope -- $(print_vars configSelectInclude[@])"
  io_trace_unsafe "_config_reset_scope -- $(print_vars configSelectExclude[@])"
  [[ -n $1 ]] && io_trace_unsafe "_config_reset_scope -- $(print_vars configSelectIncludeBundlePaths[@])"
  [[ -n $1 ]] && io_trace_unsafe "_config_reset_scope -- $(print_vars configSelectExcludeBundlePaths[@])"
  io_lock_exit
}
