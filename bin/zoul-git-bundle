#!/bin/bash

# Use the following statement to include current lib only once
#   [[ -z $ZOUL_GIT_BUNDLE ]] && . zoul-git-bundle
ZOUL_GIT_BUNDLE=true

[[ -z $ZOUL_LOCK ]]       && . zoul-lock
[[ -z $ZOUL_CORE ]]       && . zoul-core
[[ -z $ZOUL_GIT_MODULE ]] && . zoul-git-module

gitConfigGate=$(lock_init "${zou_configFile}_lock")

bundle_register()
{
  local url=$1 path=$2
  # io_trace "bundle_register -- $(print_vars url path)"
  lock_enter "$gitConfigGate"
  if ! git config --file "$zou_configFile" --get-regexp "zou.$url.path" "$path" >/dev/null; then
    git config --file "$zou_configFile" --add "zou.$url.path" "$path"
  fi
  lock_exit "$gitConfigGate"
}
bundle_unregister()
{
  local url=$1 path=$2
  lock_enter "$gitConfigGate"
  git config --file "$zou_configFile" --unset "zou.$url.path" "$path" 2>/dev/null
  lock_exit "$gitConfigGate"
}
# out:
#   bundleRegisteredPaths
bundle_set_registered_paths()
{
  bundleRegisteredPaths=()
  
  lock_enter "$gitConfigGate"
  local IFS=$'\n' kv
  for kv in $(git config --file "$zou_configFile" --get-regexp '^zou\..*\.path$' 2>/dev/null); do
    # zou.https://git.epsitec.ch/Build/zou-dev.git.path C:/devel/zou-dev
    # zou.https://git.epsitec.ch/cresus-suite/cresus-dev.git.path C:/devel/cresus-dev
    [[ $kv =~ ^[^[:blank:]]+[[:blank:]]+(.*)$ ]]
    bundleRegisteredPaths+=( ${BASH_REMATCH[1]} )
  done
  lock_exit "$gitConfigGate"
}
bundle_visit_async()
{
  local _bundleVisitPaths
  [[ $1 =~ \[@\]$ ]] && _bundleVisitPaths=( "${!1}" ) || _bundleVisitPaths=( "$($1)" )
  [ ${#_bundleVisitPaths[@]} -eq 0 ] && return 0

  # io_trace "bundle_visit_async ${*@Q} -- $(print_vars _bundleVisitPaths[@])"
  visit_async '_bundleVisitPaths[@]' _bundle_visitor "${@:2}"
}
_bundle_visitor()
{
  # io_trace "bundle_visitor ${*@Q}"
  cd "$1" &>/dev/null || {
    io_error "No such bundle directory '$1'" "$moduleTracePrefix"
    return 1
  }
  _module_scope_startup "${@:2}"
}
