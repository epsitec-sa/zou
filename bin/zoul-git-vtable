#!/usr/bin/env bash

# Use the following statement to include current lib only once
#   [[ -z $ZOUL_GIT_VTABLE ]] && . zoul-git-vtable
ZOUL_GIT_VTABLE=true

[[ -z $ZOUL_GIT_VTAG ]]        && . zoul-git-vtag
[[ -z $ZOUL_GIT_BRANCH_CORE ]] && . zoul-git-branch-core
[[ -z $ZOUL_GIT_REPO ]]        && . zoul-git-repo

pad() { eval "printf '%.s-' {1..$1}"; }

print_row()
{
  # TODO: improve by computing the best width according to the longest string.
  # It needs to have two passes; the first one for computing, and the second
  # one for printing.
  printf "_ %-40s _ %-20s _ %-10s _ %-20s _ %-20s _ %-20s _ %-20s _ %-20s _\n" "$@"
}
print_head()
{
  print_row Module Version Hash Dev Prod vminor vmajor vnext
  print_row :$(pad 39) :$(pad 19) :$(pad 9) :$(pad 19) :$(pad 19) :$(pad 19) :$(pad 19) :$(pad 19)
}
vtable_row()
{
  local moduleId=$1 vminor vmajor hash dev prod \
        folder major minor refolder tags vnext \
        md_moduleId md_vtag IFS=' '
  dev=${moduleDevBranch}
  prod=${prodBranch}
  hash=$(git rev-parse --short "${prodVTag:-$moduleHead}^{}" 2>"$stderrRedir")
  tags=$(git tag -l --sort=-v:refname 2>"$stderrRedir")
  if [[ $prodVTag =~ ^(.*/)?v([0-9]+)\.([0-9]+) ]]; then
    folder=${BASH_REMATCH[1]}
    major=${BASH_REMATCH[2]}
    minor=${BASH_REMATCH[3]}
    refolder=$(wildcard_to_regex $folder)
    vminor=$(echo $tags | grep -m1 "^${refolder}v$major\.$minor")
    vmajor=$(echo $tags | grep -m1 "^${refolder}v$major\.")
  fi
  vnext=$(echo $tags | grep -m1 "^${refolder}v[0-9]")
  md_moduleId=$moduleId
  md_vtag=${releaseVTag:-$prodVTag}
  if [[ -n $md_vtag ]]; then
    [[ $vtagStatus != 'vtag' || $vtag2prod -ne 0 ]] && md_moduleId="##$moduleId##"
    [[ $vtagStatus != 'vtag' ]] && md_vtag="##$prodVTag##"
    [[ $prodVTag == $vminor ]] && vminor='' || vminor="#$vminor#"
    [[ $prodVTag == $vmajor ]] && vmajor='' || vmajor="#$vmajor#"
    [[ $prodVTag == $vnext  ]] && vnext=''  || vnext="#$vnext#"
  fi
  # io_trace "vtable_row -- $(print_vars moduleId prodVTag hash dev prod vminor vmajor vnext)"
  print_row "$md_moduleId" "$md_vtag" "$hash" "$dev" "$prod" "$vminor" "$vmajor" "$vnext"
}
vtable_init()
{
  local root=$1 lookupPath=$2

  # create lookup
  if [[ "$PWD" == "$root" ]]; then
    declare -A lookup
    declare -p lookup >"$lookupPath"
  fi
}
vtable_update()
{
  local root=$1 moduleId=$2 lookupPath=$3 lookupGate=$4 commitVTable=$5
  # io_trace "vtable_update -- $(print_vars root moduleId lookupPath lookupGate commitVTable)"

  if [[ "$PWD" == "$root" ]]; then
    local IFS=$'\n'
    # deserialize lookup
    . "$lookupPath"

    # serialize header and root
    local file="$root/versions.md"
    print_head >"$file"
    vtable_row $moduleId false >>"$file"
    
    # serialize lookup values
    for moduleId in $(string_sort ${!lookup[@]}); do
      echo ${lookup[$moduleId]} >>"$file"
    done
    
    # replace '_' and '#' to '|' and '*'
    sed -i -E 's,_,|,g; s,#,\*,g' "$file"
    rm "$lookupPath"

    if [[ $commitVTable == true ]]; then
      git update-index --add -- "$file" &>"$stdallRedir" \
      && git_commit "update version table" "$file"
    fi
  else
    # create vtable row
    local value=$(vtable_row "$moduleId" true)

    lock_enter "$lookupGate"
    . "$lookupPath"                   # deserialize
    lookup[$moduleId]="$value"        # modify
    declare -p lookup >"$lookupPath"  # serialize
    lock_exit "$lookupGate"
  fi
}
