#!/bin/bash

[[ -z $ZOUL_GIT_CMD ]]         && . zoul-git-cmd
[[ -z $ZOUL_GIT_COSM ]]        && . zoul-git-cosm
[[ -z $ZOUL_GIT_BRANCH_SYNC ]] && . zoul-git-branch-sync

sync_parse()
{
  local args=()
  while [[ "$#" -gt 0 ]]; do case "$1" in
    -h|--help) zou-help "$0"; exit 0;;
    -j*)            jobsCount=${1#-j};;
    -r|--recursive) recursive=true;;
    -a|--all)       noSkuFilter=true;;
    -c|--clean)     cleanLocalBranches=true;;
    -C)             cleanLocalBranches=true; deleteBrokenTrackingInfoBranches=true;;
    -p|--pull)      syncNoPush=true;;
    --cosm)         syncSubmodules=true;;
    --)             shift; break;;
    -*) io_error "unknown option '$1'"; return 1;;
    *)  args+=( "$1" );;
  esac; shift; done

  cmd_check_args "${args[@]}"
  
  syncModulePaths=( "$@" )
  # io_trace "sync_parse -- $(print_vars noSkuFilter cleanLocalBranches deleteBrokenTrackingInfoBranches syncNoPush syncModulePaths[@])"
}
sync_run()
{
  # parse command line
  local jobsCount recursive command='sync' subcommand='do' \
        cmdScopes=( config_scope cosm_scope ) syncModulePaths=() \
        deleteBrokenTrackingInfoBranches syncNoPush \
        syncSubmodules synchronizeSubmoduleUrl=true

  sync_parse "$@" || return $?
  
  startupMessage="Synchronizing, please wait..."

  bundle_scope sync_command
}
sync_command()
{
  # io_trace "sync_command -- $(print_vars syncModulePaths[@])"

  [ ${#syncModulePaths[@]} -eq 0 ] && syncModulePaths+=( './' )
  cmd_register_module_paths "$recursive" "${syncModulePaths[@]}"

  cmd_visit_modules
}

sync_do_finally()  { branch_show_status; }
sync_do_xfinally() { branch_show_status; }

sync_do_scope()
{
  # io_trace "sync_do_scope ${*@Q}"
  local branchSyncVisitInfo=()
  # execute next russian doll
  $1 "${@:2}"
}
sync_do_prolog()
{
  # io_trace ">>> sync_do_prolog ${*@Q} -1- PWD=$PWD"
  branch_sync_all "$deleteBrokenTrackingInfoBranches"
  # io_trace "### sync_do_prolog -2- $(print_vars branchSyncVisitInfo[@]) PWD=$PWD"
  cosm_update_active_submodules
  _sync_clean
  # io_trace "<<< sync_do_prolog -3- $(print_vars branchSyncVisitInfo[@]) PWD=$PWD"
}
sync_do_epilog()
{
  # io_trace ">>> sync_do_epilog ${*@Q} -- $(print_vars branchSyncVisitInfo[@]) PWD=$PWD"
  _sync_commit "${branchSyncVisitInfo[@]}"
  # io_trace "<<< sync_do_epilog ${*@Q} -- $(print_vars branchSyncVisitInfo[@]) PWD=$PWD"
}
sync_do_xprolog()
{
  # io_trace "sync_do_xprolog ${*@Q} -- PWD=$PWD"
  # local syncNoRaiseEvent='true' # syncNoPush=true
  sync_do_prolog
}
_sync_commit()
{
  local r=$1 l=$2 i=$3 commitAction
  # io_trace ">>> _sync_commit ${*@Q} -- $(print_vars r l i syncSubmodules) PWD=$PWD"
  if [[ $i == '' || $i =~ (\=|\>)$ ]]; then
    if [[ $syncSubmodules == true ]]; then
      commitAction='cosm_commit_unstaged_submodules true'
    else
      commitAction='cosm_commit_unstaged_external_submodules true'
    fi
    $commitAction || git push --follow-tags ${r%%/*} $l &>"$stdallRedir"
  fi
}
_sync_clean()
{
  [[ $cleanLocalBranches == true ]] || return 0
  local branch
  for branch in $(branch_list_local_can_delete); do
    local info
    info=$(git branch -D "$branch" 2>"$stderrRedir")
    [[ -n $info ]] && mio_warning "$info"
  done
}

sync_run "$@"
