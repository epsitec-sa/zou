#!/bin/bash

. zoul-git-branch-sync

forOpts=()
cmdOpts=()
while [[ "$#" > 0 ]]; do case "$1" in
  -h|--help) zou-help $0; exit 0;;
  -0|--level0) level0=true;;
  -q|--quiet| \
  -s|--sm-only| \
  -e|--stop-on-error) forOpts+=($1);;
  -c|--clean) cmdOpts+=($1); cleanLocalBranches=true;;
  -*) echo "unknown option: $1" >&2; exit 1;;
esac; shift; done

clean_local_branches()
{
  if [[ $cleanLocalBranches == true ]]; then
    for b in $(branch_list_local_redondant); do
      local info=$(git branch -d "$b")
      [[ -n $info ]] && io_warning "$info" "[$(repo_module_id)]"
    done
  fi
}

if [[ $level0 == true ]]; then
  branch_sync_all && clean_local_branches
else
  [[ "${forOpts[@]}" =~ "--quiet" ]] || echo Entering "'$(repo_module_relative_to_path "$PWD")'"
  branch_sync_all && clean_local_branches
  git for -s -r "${forOpts[@]}" git sync -0 "${cmdOpts[@]}"
fi