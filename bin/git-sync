#!/bin/bash

[[ -z $ZOUL_GIT_MODULE ]]      && . zoul-git-module
[[ -z $ZOUL_GIT_CONFIG_SKU ]]  && . zoul-git-config-sku
[[ -z $ZOUL_GIT_BRANCH_CORE ]] && . zoul-git-branch-core
[[ -z $ZOUL_GIT_BRANCH_SYNC ]] && . zoul-git-branch-sync

sync_parse()
{
  jobsCount=16
  while [[ "$#" > 0 ]]; do case "$1" in
    -h|--help) zou-help $0; exit 0;;
    -q|--quiet)         quiet=true;;
    -e|--stop-on-error) stopOnError=true;;
    -a|--all)           noSkuFilter=true;;
    -0|--root-only)     moduleRootOnly=true;;
    -s|--sm-only)       smOnly=true;;
    -c|--clean)         cleanLocalBranches=true;;
    -j*)                jobsCount=${1#-j};;
    --dev)              hint='dev';;
    --prod)             hint='prod';;
    -*) io_error "unknown option '$1'"; return 1;;
  esac; shift; done

  if [[ $moduleRootOnly == true && $smOnly == true ]]; then
    io_error "options '--root-only' and '--sm-only' are incompatible."
    return 1
  fi
}
sync_run()
{
  # parse command line
  local jobsCount quiet stopOnError noSkuFilter moduleRootOnly smOnly cleanLocalBranches hint
  sync_parse "$@" || return $?
  # local options='quiet stopOnError noSkuFilter moduleRootOnly smOnly cleanLocalBranches hint'
  # trace_method sync_run $options

  module_run sync_main
}
sync_main()
{
  local ec=0
  if [[ $moduleRootOnly == true ]]; then
    sync_node || ec=$?
    [[ $ec -ne 0 && $stopOnError == true ]] && return $ec
  elif [[ $smOnly == true ]]; then
    sync_submodules || ec=$?
    [[ $ec -ne 0 && $stopOnError == true ]] && return $ec
  else
    sync_tree || ec=$?
    [[ $ec -ne 0 && $stopOnError == true ]] && return $ec
  fi
  return $ec
}
sync_tree()
{
  sync_node || ec=$?
  [[ $ec -ne 0 && $stopOnError == true ]] && return $ec
  sync_submodules || ec=$?
  [[ $ec -ne 0 && $stopOnError == true ]] && return $ec
}
sync_node()
{
  # synchronize all branches
  [[ -z $quiet ]] && io_info "Synchronizing..." "[$moduleId]"
  branch_sync_all "$hint" && sync_clean_local_branches || return $?
}
sync_clean_local_branches()
{
  if [[ $cleanLocalBranches == true ]]; then
    local branch
    for branch in $(branch_list_local_can_delete); do
      local info=$(git branch -D "$branch" 2>/dev/null)
      [[ -n $info ]] && io_warning "$info" "[$moduleId]"
    done
  fi
}
sync_submodules() { module_visit_submodules_async sync_submodules_enumerator sync_tree; }

sync_submodules_enumerator()
{
  local configFile
  configFile=$(repo_zouflow_path "$moduleRoot") || return $?
  if [[ $noSkuFilter == true ]]; then
    repo_list_submodule_paths
  else
    config_sku_list_included "$moduleBranch" "$configFile"
  fi
}

sync_run "$@"
