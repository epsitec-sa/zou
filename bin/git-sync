#!/bin/bash


[[ -z $ZOUL_GIT_CONFIG_SKU ]]  && . zoul-git-config-sku
[[ -z $ZOUL_GIT_BRANCH_CORE ]] && . zoul-git-branch-core
[[ -z $ZOUL_GIT_BRANCH_SYNC ]] && . zoul-git-branch-sync

forOpts=()
cmdOpts=()
while [[ "$#" > 0 ]]; do case "$1" in
  -h|--help) zou-help $0; exit 0;;
  -0|--level0) level0=true;;
  -q|--quiet)         cmdOpts+=($1); quiet=true;;
  -s|--sm-only)       cmdOpts+=($1); smOnly=true;;
  -e|--stop-on-error) cmdOpts+=($1); stopOnError=true;;
  -c|--clean)         cmdOpts+=($1); cleanLocalBranches=true;;
  -a|--all)           cmdOpts+=($1); all=true;;
  --_root)            cmdOpts+=($1 $2); root=$(echo $2 | xargs echo); shift;;  # remove single quotes
  --_root-branch)     cmdOpts+=($1 $2); rootBranch=$2; shift;;
  -*) echo "unknown option: $1" >&2; exit 1;;
esac; shift; done

[[ -z $rootBranch ]] && rootBranch=$(branch_current_root_branch)

clean_local_branches()
{
  if [[ $cleanLocalBranches == true ]]; then
    for b in $(branch_list_local_redondant); do
      local info=$(git branch -d "$b" 2>/dev/null)
      [[ -n $info ]] && io_warning "$info" "[$(repo_module_id)]"
    done
  fi
}
sync_submodules()
{
  local rootBranch=$1 configFile include path opath ec=0
  configFile=$(repo_zouflow_path) || return 1
  [[ $all == true ]] && include=( $(repo_list_submodules) ) || include=( $(config_sku_list_included "$rootBranch" "$configFile") )
  for path in $(array_sort include[@]); do
    opath="$PWD"; cd "$path"
    [[ $quiet == true ]] || echo Entering "'$(path_make_relative '.' "$root")'"
    git sync -0 ${cmdOpts[@]} || ec=1
    cd "$opath"
    [[ $ec != 0 && $stopOnError == true ]] && break
  done
  return $ec
}
sync_tree()
{
  local rootBranch=$1 ec=0
  if [[ $smOnly != true || "$PWD" != "$root" ]]; then
    branch_sync_all && clean_local_branches || ec=$?
    [[ $ec != 0 && $stopOnError == true ]] && return $ec
  fi
  sync_submodules "$rootBranch" || ec=$?
  return $ec
}

if [[ $level0 == true ]]; then
  sync_tree "$rootBranch"
else
  [[ -z $quiet && $smOnly != true ]] && echo Entering "'$(repo_module_relative_to_path)'"
  git sync -0 --_root "'$(repo_module_dir)'" --_root-branch "$rootBranch" ${cmdOpts[@]}   # single quote root to avoid shell path expansion on Windows
fi
