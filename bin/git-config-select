#!/bin/bash

[[ -z $ZOUL_GIT_MODULE ]]        && . zoul-git-module
[[ -z $ZOUL_GIT_CONFIG_SELECT ]] && . zoul-git-config-select

csel_parse()
{
  while [[ "$#" > 0 ]]; do case "$1" in
    -h|--help) zou-help $0; exit 0;;
    -r|--recursive) recursive=true;;
    -i|--include)   [[ $mode == 'exclude' ]] && { io_error 'options conflict'; exit 1; } || mode='include';;
    -x|--exclude)   [[ $mode == 'include' ]] && { io_error 'options conflict'; exit 1; } || mode='exclude';;
    -*)             forOpts+=($1);;
    *)
      case "$mode" in
        include) include+=($1);;
        exclude) exclude+=($1);;
      esac
  esac; shift; done
}
csel_run()
{
  local recursive forOpts=() \
        mode='status' include=() exclude=()
  csel_parse "$@" || return $?

  if [[ $recursive = true ]]; then
    . git-for "${forOpts[@]}" -- 'config_select_status'
  else
    module_run csel_main
  fi
}
csel_main()
{
  if [ ${#include[@]} -ne 0 ]; then
    if [ ${#include[@]} -eq 1 ]; then
      config_select_include "${include[0]}"
    else
      config_select_include_many "${include[@]}"
    fi
  fi
  if [ ${#exclude[@]} -ne 0 ]; then
    if [ ${#exclude[@]} -eq 1 ]; then
      config_select_exclude "${exclude[0]}"
    else
      config_select_exclude_many "${exclude[@]}"
    fi
  fi

  case "$mode" in
    include) [ ${#include[@]} -eq 0 ] && config_select_include_all;;
    exclude) [ ${#exclude[@]} -eq 0 ] && config_select_exclude_all;;
  esac

  config_select_status
}

csel_run "$@"

