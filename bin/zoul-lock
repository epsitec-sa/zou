#!/bin/bash

# Use the following statement to include current lib only once
#   [[ -z $ZOUL_LOCK ]] && . zoul-lock
ZOUL_LOCK=true

# flock is not distributed with git-bash
# MSYS2 has a version of flock but it creates a conflict with cygwin.dll
# use atomic mkdir

lock_init()
{
  local gate=${1:-$(mktemp -u)}
  # Remove lockdir when the script finishes, or when it receives a signal
  trap "rm -rf \"$gate\"" 0
  echo $gate
}
lock_enter()
{
  while ! mkdir "$1" &>/dev/null; do
    sleep ${2:-0}
  done
}
lock_exit()
{
  rm -rf "$1"
}
lock()
(
  local gate=$1 delay=$2; shift 2
  lock_enter "$gate" $delay
  # execute next russian doll
  $1 "${@:2}"
  lock_exit "$gate"
)
