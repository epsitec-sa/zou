#!/bin/bash

# Use the following statement to include current lib only once
#   [[ -z $ZOUL_LOCK ]] && . zoul-lock
ZOUL_LOCK=true

# flock is not distributed with git-bash
# MSYS2 has a version of flock but it creates a conflict with cygwin.dll
# use atomic mkdir

lock_init()
{
  local lockDir=$(mktemp -u)
  # Remove lockdir when the script finishes, or when it receives a signal
  trap "rm -rf \"$lockDir\"" 0
  echo $lockDir
}
lock()
(
  local lockDir=$1 delay=$2; shift 2
  while ! mkdir "$lockDir" &>/dev/null; do
    sleep "$delay"
  done
  
  # execute next russian doll
  "$1" "${@:2}"

  rm -rf "$lockDir"
)
