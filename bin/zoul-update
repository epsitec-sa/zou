#!/usr/bin/env bash

# Use the following statement to include current lib only once
#   [[ -z $ZOUL_UPDATE ]] && . zoul-update
ZOUL_UPDATE=true

[[ -z $ZOUL_CONFIG ]]          && . zoul-config
[[ -z $ZOUL_GIT_VTAG ]]        && . zoul-git-vtag
[[ -z $ZOUL_GIT_PROD ]]        && . zoul-git-prod
[[ -z $ZOUL_GIT_MODULE ]]      && . zoul-git-module
[[ -z $ZOUL_GIT_BRANCH_CORE ]] && . zoul-git-branch-core
[[ -z $ZOUL_GIT_BRANCH_SYNC ]] && . zoul-git-branch-sync

zou_parse()
{
  local noConfig noPruneTags
  while [[ "$#" > 0 ]]; do case "$1" in
    -u|--no-prune-tags) noPruneTags=true;;
    -c|--no-config)     noConfig=true;;
    ---version)         actualVersion=$2; shift;;
    --vnext)            checkoutType='vnext';;
    --dev)              checkoutType='dev';;
    -*) io_error "unknown option '$1'"; return 1;;
  esac; shift; done

  [[ -z $noPruneTags ]] && bundlerOpts+=( '--prune-tags' )
  [[ -z $noConfig ]]    && bundlerOpts+=( '--force' )
  # io_trace "zou_parse -- $(print_vars noConfig noPruneTags bundlerOpts[@])"
  return 0
}

zou_update()
{
  [[ -n $zouFakeUpdate ]] && io_trace "[FAKE UPDATE] zou_update -- \$0='$0'"
  [[ -n $zouFakeUpdate ]] && io_trace "[FAKE UPDATE] zou_update -- ${*@Q}"
  module_run _zou_update_core "$@"
}

_zou_update_core()
{
  local actualVersion version checkoutType='vlast' bundlerOpts=( '--all' )
  
  zou_parse "$@" || return $?
  io_set_version

  [[ -n $zouFakeUpdate ]] && io_trace "[FAKE UPDATE] _zou_update_core -- $(print_vars actualVersion version)"
  [[ -n $zouFakeUpdate ]] && io_trace "[FAKE UPDATE] _zou_update_core -- $(print_vars checkoutType bundlerOpts[@] zouOnly)"

  config_setup  # global setup only

  if [[ -z $zouFakeUpdate ]]; then
    if [[ "$bundleRoot" == "$PWD" ]]; then
      git-sync -r --pull --clean
      git-sku enter "--$checkoutType"
    else
      # zou repo inside zou-dev bundle
      module_visit "$bundleRoot" _zou_update_bundle "$checkoutType"
    fi
    _zou_configure_bundles
    ( _zou_setup_chicken )
  else
    # FAKE UPDATE
    io_trace "[FAKE UPDATE] _zou_update_core -- $(print_vars zouBinDir)"
    if [[ "$bundleRoot" == "$PWD" ]]; then
      io_trace "[FAKE UPDATE] git-sync -r --pull --clean"
      io_trace "[FAKE UPDATE] git-sku enter $checkoutType"
    else
      # zou repo inside zou-dev bundle
      module_visit "$bundleRoot" _zou_update_bundle_fake "$checkoutType"
    fi
    _zou_configure_bundles
  fi
  _zou_update_epilog
}
_zou_update_bundle()
{
  local checkoutType=${1:-vlast}
  git-sync -r --pull --clean
  git-sku enter "--$checkoutType"
}
_zou_update_bundle_fake()
{
  local checkoutType=${1:-vlast}
  io_lock_enter
  io_trace "[FAKE UPDATE] git-sync -r --pull --clean"
  io_trace "[FAKE UPDATE] git-sku enter --$checkoutType"
  io_lock_exit
}
_zou_configure_bundles()
{
  printf '\n'
  git-bundler "${bundlerOpts[@]}"
}
_zou_setup_chicken()
{
  local develDir=$(abspath "$bundleRoot/..")
  local chickenDir=$develDir/zou.chicken
  # io_trace "_zou_setup_chicken -- $(print_vars chickenDir)"
  if [ -d "$chickenDir" ]; then
    cd "$chickenDir"
    git sync
  else
    local tracePrefix="${Cyan}[zou.chicken]${NC}"
    io_warning "Installing zou.chicken into ${VC}$chickenDir${Brown}" "$tracePrefix"
    io_warning "This can take a while, please be patient..." "$tracePrefix"
    git clonex -C "$develDir" 'https://git.epsitec.ch/Build/zou.chicken.git'
    nuget sources remove -name chicken &>>"$stdallRedir"
    [ $zouWin -eq 0 ] && chickenDir="$(cygpath -w "$chickenDir")"
    nuget sources add -name chicken -source "$chickenDir" &>>"$stdallRedir"
  fi
}
_zou_update_epilog()
{
  local vtag delta
  vtag_set_describe $moduleHead
  # io_trace "_zou_update_epilog -- $(print_vars vtag delta)"
  local tracePrefix="${Cyan}[zou]${NC}" traceVersion traceMessage
  if [[ $actualVersion == $version ]]; then
    if [ $delta -eq 0 ]; then
      traceVersion="no changes, still using version ${Green}$version${Brown}"
    else
      traceVersion="switched to development version ${Green}$version${Brown}, ${Magenta}$delta${Brown} commit[s] ahead"
    fi
  else
    traceVersion="switched to new version ${Green}$version${Brown}"
  fi
  traceMessage="Update finished ($traceVersion)."
  
  io_warning "$traceMessage" "$tracePrefix"
  io_warning "Press [Enter] to continue..." "$tracePrefix"
}

zou_update "$@"
