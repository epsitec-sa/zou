#!/bin/bash

# stow tags (apply zou-flow):
# 1. delete root tags that are already in other folder
# 2. move non semver root tags to other folder
# 3. move big patch root tags to other folder (v12.5.16460)
# 4. remove leading zeros to prerelease version (v1.2.3-rc01 -> v1.2.3-rc1 )
# 5. remove other folder's redondant tags

[[ -z $ZOUL_GIT_STOW ]]          && . zoul-git-stow
[[ -z $ZOUL_GIT_REPO ]]          && . zoul-git-repo
[[ -z $ZOUL_GIT_MODULE ]]        && . zoul-git-module
[[ -z $ZOUL_GIT_TAG ]]           && . zoul-git-tag

stow_parse()
{
  while [[ "$#" > 0 ]]; do case "$1" in
    -h|--help) zou-help $0; exit 0;;
    -r|--recursive) recursive=true;;
    -p|--push)      stowPushTags=true;;
    -*) forOpts+=($1);;
  esac; shift; done
}
stow_run()
{
  local stowPushTags recursive forOpts=()
  stow_parse "$@" || return $?

  startupMessage="Stowing, please wait..."

  module_run stow_main
}
stow_main()
{
  [ ${#moduleSubmodulePaths[@]} -eq 0 ] && unset recursive

  if [[ $recursive = true ]]; then
    . git-for "${forOpts[@]}" -- 'stow_node'
  else
    module_run stow_node
  fi
}
stow_node()
{
  local noTagPush=true stowArchiveDelay

  io_message "Computing archive delay..." "$moduleTracePrefix" LightGray
  stow_set_archive_delay $(branch_list_all_flatten)
  io_info "Archive delay = ${Brown}$stowArchiveDelay${Cyan} days" "$moduleTracePrefix"

  io_message "Removing redondant branches..." "$moduleTracePrefix" LightGray
  stow_remove_classified_branches $(branch_list_all_flatten)
  stow_remove_promoted_vbranches $(branch_list_all_flatten)
  
  io_message "Classifying branches..." "$moduleTracePrefix" LightGray
  stow_classify_branches $(branch_list_all_flatten)

  io_message "Removing redondant tags..." "$moduleTracePrefix" LightGray
  stow_remove_classified_tags $(git tag -l)
  stow_remove_promoted_vtags $(git tag -l --sort=-v:refname)
  
  io_message "Classifying tags..." "$moduleTracePrefix" LightGray
  stow_classify_tags $(git tag -l)
  
  local vbranches=( $(branch_list_all_flatten) )
  io_message "Promoting vtags..." "$moduleTracePrefix" LightGray
  stow_promote_vtags 'vbranches[@]' $(git tag -l --sort=-v:refname)

  io_message "Taking care of orphans..." "$moduleTracePrefix" LightGray
  stow_orphans 'vbranches[@]' $(git tag -l)

  # [[ $stowPushTags == true ]] && tag_mirror
}

stow_run "$@"
