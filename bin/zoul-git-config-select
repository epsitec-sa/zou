#!/bin/bash

# Use the following statement to include current lib only once
#   [[ -z $ZOUL_GIT_CONFIG_SELECT ]] && . zoul-git-config-select
ZOUL_GIT_CONFIG_SELECT=true

[[ -z $ZOUL_GIT_REPO ]]          && . zoul-git-repo
[[ -z $ZOUL_GIT_BRANCH_SELECT ]] && . zoul-git-branch-select

# WARNING: we work with submodule paths relative to bundle, not with submodule IDs

# configure select submodules
# modify .zou-flow configuration file
#
# submodule level 0: all included by default
#
# [select]
#   exclude = fact
#   exclude = compta
#
# submodule level > 0: all excluded by default
#
# [select]
#   include = sm1
#   include = sm2
#

_config_select_default_verb() { (( $(repo_module_level "$@") == 0 )) && echo 'include' || echo 'exclude'; }
_config_select_anti_verb()    { [[ $1 == 'exclude' ]] && echo 'include' || echo 'exclude'; }

config_select_include()
{
  local path=$1
  [[ -z $path ]] && path=$(repo_path_relative_to_module_root)
  local rePath=$(regex_whole "$path")
  local defaultVerb=$(_config_select_default_verb)
  if [[ $defaultVerb == 'include' ]]; then
    git config --file "$moduleConfigFile" --unset-all "select.exclude" "$rePath"
  else
    git config --file "$moduleConfigFile" --get-all "select.include" "$rePath" >/dev/null \
    || git config --file "$moduleConfigFile" --add "select.include" "$path"
  fi

  git update-index --add -- "$moduleConfigFile" &>/dev/null \
  && git commit -m "zou-flow: enable select for submodule '$path' on moduleBranch '$moduleBranch'" -- "$moduleConfigFile" &>/dev/null
}
config_select_include_all()
{
  local defaultVerb=$(_config_select_default_verb)
  if [[ $defaultVerb == 'include' ]]; then
    git config --file "$moduleConfigFile" --remove-section "select" &>/dev/null

    git update-index --add -- "$moduleConfigFile" &>/dev/null \
    && git commit -m "zou-flow: enable select for all submodules on moduleBranch '$moduleBranch'" -- "$moduleConfigFile" &>/dev/null
  else
    config_select_include_many $(repo_list_submodule_paths)
  fi
}
config_select_include_many()
{
  local path rePath defaultVerb=$(_config_select_default_verb)
  for path in $@; do
    rePath=$(regex_whole "$path")
    if [[ $defaultVerb == 'include' ]]; then
      git config --file "$moduleConfigFile" --unset-all "select.exclude" "$rePath"
    else
      git config --file "$moduleConfigFile" --get-all "select.include" "$rePath" >/dev/null \
      || git config --file "$moduleConfigFile" --add "select.include" "$path"
    fi
  done

  git update-index --add -- "$moduleConfigFile" &>/dev/null && \
  git commit -m "zou-flow: enable select for submodules '$(string_join ', ' $@)' on moduleBranch '$moduleBranch'" -- "$moduleConfigFile" &>/dev/null
}
config_select_exclude()
{
  local path=$1
  [[ -z $path ]] && path=$(repo_path_relative_to_module_root)
  local rePath=$(regex_whole "$path")
  local defaultVerb=$(_config_select_default_verb)
  if [[ $defaultVerb == 'exclude' ]]; then
    git config --file "$moduleConfigFile" --unset-all "select.include" "$rePath"
  else
    git config --file "$moduleConfigFile" --get-all "select.exclude" "$rePath" >/dev/null \
    || git config --file "$moduleConfigFile" --add "select.exclude" "$path"
  fi

  git update-index --add -- "$moduleConfigFile" &>/dev/null \
  && git commit -m "zou-flow: disable select for submodule '$path' on moduleBranch '$moduleBranch'" -- "$moduleConfigFile" &>/dev/null
}
config_select_exclude_all()
{
  local defaultVerb=$(_config_select_default_verb)
  if [[ $defaultVerb == 'exclude' ]]; then
    git config --file "$moduleConfigFile" --remove-section "select" &>/dev/null

    git update-index --add -- "$moduleConfigFile" &>/dev/null \
    && git commit -m "zou-flow: disable select for all submodules on moduleBranch '$moduleBranch'" -- "$moduleConfigFile" &>/dev/null
  else
    config_select_exclude_many $(repo_list_submodule_paths)
  fi
}
config_select_exclude_many()
{
  local path rePath defaultVerb=$(_config_select_default_verb)
  for path in $@; do
    rePath=$(regex_whole "$path")
    if [[ $defaultVerb == 'exclude' ]]; then
      git config --file "$moduleConfigFile" --unset-all "select.include" "$rePath"
    else
      git config --file "$moduleConfigFile" --get-all "select.exclude" "$rePath" >/dev/null \
      || git config --file "$moduleConfigFile" --add "select.exclude" "$path"
    fi
  done

  git update-index --add -- "$moduleConfigFile" &>/dev/null \
  && git commit -m "zou-flow: disable select for submodules '$(string_join ', ' $@)' on moduleBranch '$moduleBranch'" -- "$moduleConfigFile" &>/dev/null
}
config_select_is_excluded() { ! config_select_is_included "$@"; }
config_select_is_included()
{
  local path=$1 p
  [[ -z $path ]] && path=$(repo_path_relative_to_module_root)
  for p in $(config_select_list_included); do
     [[ $p == $path ]] && return 0
  done
  return 1
}
config_select_list_included()
{
  local defaultVerb=$(_config_select_default_verb) 
  if [[ $defaultVerb == 'include' ]]; then
    local submodules
    [[ -n $1 ]] && submodules=( "${!1}" ) || submodules=( $(repo_list_submodule_paths) )
    local excluded=( $(git config --file "$moduleConfigFile" --get-all "select.exclude") )
    array_remove_array submodules[@] excluded[@]
  else
    git config --file "$moduleConfigFile" --get-all "select.include" || true
  fi
}
config_select_list_excluded()
{
  local defaultVerb=$(_config_select_default_verb)
  if [[ $defaultVerb == 'exclude' ]]; then
    local submodules
    [[ -n $1 ]] && submodules=( "${!1}" ) || submodules=( $(repo_list_submodule_paths) )
    local included=( $(git config --file "$moduleConfigFile" --get-all "select.include") )
    array_remove_array submodules[@] included[@]
  else
    git config --file "$moduleConfigFile" --get-all "select.exclude" || true
  fi
}
config_select_status()
{
  for path in $(config_select_list_included | sort); do
    io_message "  $path" "$moduleTracePrefix" Green
  done
  for path in $(config_select_list_excluded | sort); do
    io_message "x $path" "$moduleTracePrefix" Purple
  done
}
