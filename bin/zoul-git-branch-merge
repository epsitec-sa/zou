#!/bin/bash
# https://longair.net/blog/2009/04/16/git-fetch-and-merge/
# https://stackoverflow.com/questions/501407/is-there-a-git-merge-dry-run-option
# https://stackoverflow.com/questions/3216360/merge-update-and-pull-git-branches-without-using-checkouts

# Use the following statement to include current lib only once
#   [[ -z $ZOUL_GIT_BRANCH_MERGE ]] && . zoul-git-branch-merge
ZOUL_GIT_BRANCH_MERGE=true

[[ -z $ZOUL_GIT_REPO ]]        && . zoul-git-repo
[[ -z $ZOUL_GIT_BRANCH_CORE ]] && . zoul-git-branch-core

branch_merge_ff()
{
  local toMerge=$1 intoBranch=$2 intoBranchName needCheckout
  _branch_merge_ff
}
branch_merge_sync()
{
  branch_merge "$@" && branch_merge_ff "$2" "$1"
}
branch_merge()
{
  local toMerge=$1 intoBranch=$2 intoBranchName needCheckout ec=0; shift 2
  _branch_merge_ff || ec=$?
  case $ec in
    0|128) return $ec;;
    *) ec=0;;
  esac

  local message="zou-flow: merge '$toMerge' into '$intoBranch'"

  if [[ $needCheckout == true ]] && git checkout $intoBranchName &>/dev/null; then
    _branch_merge "$message" "$toMerge" "$@" || ec=$?
    git checkout - &>/dev/null
    [ $ec -eq 0 ] && return 0
  else
    _branch_merge "$message" "$toMerge" "$@" && return 0
  fi
  repo_require_clean_work_tree "Cannot merge '$toMerge' into '$intoBranch'"
  return 1
}
# usage
#  local toMerge=$1 intoBranch=$2 needCheckout
#  _branch_merge_ff
# in/out:
#  toMerge    -- commish to merge
#  intoBranch -- branch to merge into (local name)
# out:
#  intoBranchName -- branch name without remote prefix
#  needCheckout
# return:
#  0   -- ff merge succeeded
#  1   -- ff merge failed 
#  128 -- bad arguments

_branch_merge_ff()
{
  # merge 'toMerge' (invariant) into 'intoBranch' < 'toMerge'
  # 'intoBranch' should be a local branch with a symbolic name
  local hashToMerge hashMergeInto intoRef ec=0

  local obranch=$intoBranch
  intoBranch=$(branch_realize "$intoBranch") || ec=$?
  case $ec in
  0) intoRef="refs/heads/$intoBranch"; intoBranchName=$intoBranch;;
  1) intoRef="refs/remotes/$intoBranch"; intoBranchName=${intoBranch#*/}; needCheckout=true;;
  *) io_error "Invalid branch name '$obranch' (error code = $ec)" "$moduleTracePrefix"; return 128;;
  esac

  hashToMerge="$(git rev-parse --verify "$toMerge" 2>/dev/null)"
  if [ $? -ne 0 ]; then
    toMerge=$(branch_realize "$toMerge")
    if [ $? -gt 1 ]; then
      io_error "Invalid commish '$toMerge'" "$moduleTracePrefix"
      return 128
    fi
    hashToMerge="$(git rev-parse --verify "$toMerge" 2>/dev/null)"
    if [ $? -ne 0 ]; then
      io_error "Invalid commish '$toMerge'" "$moduleTracePrefix"
      return 128
    fi
  fi
  hashMergeInto=$(git show-ref -s --verify "$intoRef" 2>/dev/null)
  if [ $? -ne 0 ]; then
    io_error "Invalid reference '$intoRef'" "$moduleTracePrefix"
    return 128
  fi

  if [[ "$(git symbolic-ref HEAD &>/dev/null)" == "$intoRef" ]]; then
    if ! git merge --ff-only "$toMerge" &>/dev/null; then
      return 1
    fi
  else
    needCheckout=true
    if [[ "$(git merge-base $hashMergeInto $hashToMerge)" != "$hashMergeInto" ]]; then
      return 1
    fi
    if ! git update-ref -m "merge $toMerge into $intoBranch (fast forward)" "$intoRef" "$hashToMerge" "$hashMergeInto"; then
      return 1
    fi
  fi
  # io_trace "_branch_merge_ff -- $(print_vars toMerge intoBranch ref)" Green
}
_branch_merge()
{
  local message=$1 toMerge=$2; shift 2
  if git merge -m "$message" "$@" "$toMerge" &>/dev/null; then
    # io_trace "_branch_merge -- $(print_vars toMerge intoBranch ref)" Green
    return 0
  fi

  ! repo_is_merging && return 1

  if _branch_merge_resolve_submodule_conflicts; then
    git commit -m "$message" >/dev/null
  elif ! _branch_merge_interactive; then
    local conflicts=$(git diff)
    io_lock_enter
    io_message_unsafe "while auto-merging $toMerge into $intoBranch."             "$moduleTracePrefix" Red
    local IFS=$'\n'
    for line in $(git diff); do
      io_message_unsafe "  $line" "$moduleTracePrefix" DarkGray
    done
    io_message_unsafe "  configure your mergetool and run 'git sync' again"   "$moduleTracePrefix" LightCyan
    io_message_unsafe "  or finalize the merge using the following commands:" "$moduleTracePrefix" LightCyan
    io_message_unsafe "    <merge-tool>"          "$moduleTracePrefix" Brown
    io_message_unsafe "    git commit --no-edit"  "$moduleTracePrefix" DarkGray
    io_lock_exit
    return 1
  fi
}
_branch_merge_interactive()
{
  local ec=0
  git mergetool && git commit --no-edit >/dev/null || ec=$?
  # clean temp merge files
  repo_list_untracked | grep -E '(\.orig$|_(BACKUP|BASE|LOCAL|REMOTE)_[0-9]+)' | xargs --no-run-if-empty rm --
  return $ec
}
_branch_merge_resolve_submodule_conflicts()
{
  local IFS=$'\n' line status path ec=0
  for line in $(git status -s --porcelain); do
    if [[ $line =~ ^([A-Z]+)[[:blank:]]+(.+)$ ]]; then
      status=${BASH_REMATCH[1]}
      path=${BASH_REMATCH[2]}
      if [[ $status =~ U ]]; then
        if [[ -f "$path/.git" ]]; then
          # keep local submodule
          git reset -q "$path"
        else
          # still unmerged files
          ec=1
        fi
      fi
    fi
  done
  return $ec
}