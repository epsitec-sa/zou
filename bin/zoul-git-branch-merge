#!/bin/bash
# https://longair.net/blog/2009/04/16/git-fetch-and-merge/
# https://stackoverflow.com/questions/501407/is-there-a-git-merge-dry-run-option
# https://stackoverflow.com/questions/3216360/merge-update-and-pull-git-branches-without-using-checkouts

# Use the following statement to include current lib only once
#   [[ -z $ZOUL_GIT_BRANCH_MERGE ]] && . zoul-git-branch-merge
ZOUL_GIT_BRANCH_MERGE=true

[[ -z $ZOUL_GIT_REPO ]]        && . zoul-git-repo
[[ -z $ZOUL_GIT_BRANCH_CORE ]] && . zoul-git-branch-core

branch_merge_ff() {
  # merge 'branchToMerge' (invariant) into 'branchMergeInto' < 'branchToMerge'
  # 'branchMergeInto' should be a local branch with a symbolic name
  local branchToMerge=$1
  local branchMergeInto=$2
  local hashToMerge hashMergeInto

  hashMergeInto=$(git show-ref -s --verify "refs/heads/$branchMergeInto" 2>/dev/null)
  if [ $? -ne 0 ]; then
    io_error "not a local branch $branchMergeInto"
    return 1
  fi

  hashToMerge="$(git rev-parse --verify $branchToMerge 2> /dev/null)"
  if [ $? -ne 0 ]; then
    io_error "unknown branch to merge $branchToMerge"
    return 2
  fi

  if [ "$(git symbolic-ref HEAD)" = "refs/heads/$branchMergeInto" ]; then
      if ! git merge --ff-only "$branchToMerge"; then
        io_error "merging $branchToMerge into $branchMergeInto would not be a fast-forward"
        return 3
      fi
  else
    if [ "$(git merge-base $hashMergeInto $hashToMerge)" != "$hashMergeInto" ]; then
      io_error "merging $branchToMerge into $branchMergeInto would not be a fast-forward"
      return 4
    fi
    io_info "Updating ${hashMergeInto:0:7}..${hashToMerge:0:7}"
    if ! git update-ref -m "merge $branchToMerge into $branchMergeInto (fast forward)" "refs/heads/$branchMergeInto" "$hashToMerge" "$hashMergeInto"; then
      io_error "fast forward using update-ref failed"
      return 5
    fi
  fi
}
branch_merge_in_memory()
{
  local branchToMerge=$1 branchMergeInto=$2 mbase
  mbase=$(git merge-base $branchToMerge $branchMergeInto)
  git merge-tree $mbase $branchMergeInto $branchToMerge
}
branch_merge_dry_run()
{
  local conflicts
  conflicts=$(branch_merge_in_memory "$@")
  echo "$conflicts" | grep -q -E '^[+-\ ]>{7}' && return 1 || return 0
}
branch_merge_interactive()
{
  local ec=0
  git mergetool >/dev/null || ec=1
  if (( $ec == 0 )); then
    git commit --no-edit >/dev/null
    git push &>/dev/null
  fi
  # clean temp merge files
  repo_list_untracked | grep -E '(\.orig$|_(BACKUP|BASE|LOCAL|REMOTE)_[0-9]+)' | xargs --no-run-if-empty rm --
  return $ec
}
branch_merge()
{
  # merge branchToMerge into branchMergeInto
  # before: branchMergeInto < branchToMerge
  # after : branchMergeInto = branchToMerge -- branchMergeInto moved towards branchToMerge
  local branchToMerge=$1 branchMergeInto=$2 ec=0
  local targetBranchIsNotLocal
  # try fast-forward merge
  branch_merge_ff $branchToMerge $branchMergeInto &>/dev/null || ec=$?
  if (( $ec != 0 )); then
    # fast forward failed
    if (( $ec == 1 )); then
      targetBranchIsNotLocal=true
      # ensure target branch name is realized
      branchMergeInto=$(branch_realize $branchMergeInto 2>/dev/null)
      ec=0
    fi
    # on active branch...
    if [[ -z $targetBranchIsNotLocal ]] && branch_is_head $branchMergeInto; then
      # ... merge even if conflicts
      if ! git merge $branchToMerge &>/dev/null; then
        if repo_is_merging; then
          branch_merge_interactive || {
            local conflicts=$(git diff)
            io_error "while auto-merging $branchToMerge into $branchMergeInto."
            io_message >&2 "$(echo "$conflicts" | sed 's/^/  /')" '' Red
            io_message >&2 "  configure your mergetool and run 'git sync' again" '' LightCyan
            io_message >&2 "  ... or finalize the merge using the following commands:" '' LightCyan
            io_message >&2 "    <merge-tool>" '' Brown
            io_message >&2 "    git commit --no-edit" '' DarkGray
            io_message >&2 "    git push" '' DarkGray
            return 1
          }
        else
          return 1
        fi
      fi
    # on inactive branch check if there will be merge conflicts before switching
    else
      if branch_merge_dry_run $branchToMerge $branchMergeInto; then
        # no conflicts: merge
        [[ $targetBranchIsNotLocal == true ]] && branchMergeInto=$(branch_without_remote_prefix $branchMergeInto)
        if git checkout $branchMergeInto &>/dev/null; then
          git merge $branchToMerge &>/dev/null || {
            io_error "unable to merge $branchToMerge into $branchMergeInto branch"
            ec=1
          }
          git checkout - &>/dev/null
          return $ec
        else
          io_error "unable to checkout $branchMergeInto branch"
          return 1
        fi
      else
        if git checkout $branchMergeInto &>/dev/null; then
          git merge $branchToMerge &>/dev/null || branch_merge_interactive ||
          {
            local conflicts=$(git diff)
            io_error "while auto-merging $branchToMerge into $branchMergeInto."
            io_message >&2 "$(echo "$conflicts" | sed 's/^/  /')" '' Red
            io_message >&2 "  configure your mergetool and run 'git sync' again" '' LightCyan
            io_message >&2 "  ... or merge $branchToMerge into $branchMergeInto using the following commands:" '' LightCyan
            io_message >&2 "    git checkout $branchMergeInto" '' DarkGray
            io_message >&2 "    git pull" '' DarkGray
            io_message >&2 "    <merge-tool>" '' Brown
            io_message >&2 "    git commit --no-edit" '' DarkGray
            io_message >&2 "    git push" '' DarkGray
            io_message >&2 "    git checkout -" '' DarkGray
            git merge --abort
            ec=1
          }
          git checkout - &>/dev/null
          return $ec
        else
          io_error "unable to checkout $branchMergeInto branch"
          return 1
        fi
      fi
    fi
  fi
}