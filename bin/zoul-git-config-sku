#!/bin/bash

# Use the following statement to include current lib only once
#   [[ -z $ZOUL_GIT_SCONFIG ]] && . zoul-git-sconfig
ZOUL_GIT_SCONFIG=true

[[ -z $ZOUL_GIT_BRANCH_SELECT ]] && . zoul-git-branch-select

# configure SKU submodules
# modify .zou-flow configuration file
#
# [sku "sku/sal/dev"]
#   exclude = sm1
#   exclude = sm2

config_sku_exclude()
{
  local path branch configFile
  path=${1:-$(repo_path_relative_to_module)} || return 1
  branch=${2:-$(branch_ensure_current)} || return 1
  configFile=${3:-$(repo_zouflow_path)} || return 1
  local rePath=$(regex_escape "$path")
  git config --file "$configFile" --get-all "sku.$branch.exclude" "$rePath" >/dev/null \
  || git config --file "$configFile" --add "sku.$branch.exclude" "$path"

  git update-index --add -- "$configFile" &>/dev/null \
  && git commit -m "zou-flow: exclude submodule '$path' from SKU '$branch'" -- "$configFile" &>/dev/null
}
config_sku_exclude_all() { config_sku_exclude_many "$@" $(repo_list_submodules); }
config_sku_exclude_many()
{
  local branch configFile path rePath
  branch=${1:-$(branch_ensure_current)} || return 1; shift
  configFile=${1:-$(repo_zouflow_path)} || return 1; shift
  for path in $@; do
    rePath=$(regex_escape "$path")
    git config --file "$configFile" --get-all "sku.$branch.exclude" "$rePath" >/dev/null \
    || git config --file "$configFile" --add "sku.$branch.exclude" "$path"
  done

  git update-index --add -- "$configFile" &>/dev/null && \
  git commit -m "zou-flow: exclude submodules '$(string_join ', ' $@)' from SKU '$branch'" -- "$configFile" &>/dev/null
}
config_sku_include()
{
  local path branch configFile
  path=${1:-$(repo_path_relative_to_module)} || return 1
  branch=${2:-$(branch_ensure_current)} || return 1
  configFile=${3:-$(repo_zouflow_path)} || return 1
  local rePath=$(regex_escape "$path")
  git config --file "$configFile" --unset-all "sku.$branch.exclude" "$rePath"

  git update-index --add -- "$configFile" &>/dev/null \
  && git commit -m "zou-flow: include submodule '$path' in SKU '$branch'" -- "$configFile" &>/dev/null
}
config_sku_include_all()
{
  local branch configFile
  branch=${1:-$(branch_ensure_current)} || return 1
  configFile=${2:-$(repo_zouflow_path)} || return 1
  git config --file "$configFile" --remove-section "sku.$branch" &>/dev/null

  git update-index --add -- "$configFile" &>/dev/null \
  && git commit -m "zou-flow: include all submodules in SKU '$branch'" -- "$configFile" &>/dev/null
}
config_sku_include_many()
{
  local branch configFile path rePath
  branch=${1:-$(branch_ensure_current)} || return 1; shift
  configFile=${1:-$(repo_zouflow_path)} || return 1; shift
  for path in $@; do
    rePath=$(regex_escape "$path")
    git config --file "$configFile" --unset-all "sku.$branch.exclude" "$rePath"
  done

  git update-index --add -- "$configFile" &>/dev/null && \
  git commit -m "zou-flow: include submodules '$(string_join ', ' $@)' in SKU '$branch'" -- "$configFile" &>/dev/null
}
config_sku_is_included() { ! config_sku_is_excluded "$@"; }
config_sku_is_excluded()
{
  local path branch configFile
  path=${1:-$(repo_path_relative_to_module)} || return 1
  branch=${2:-$(branch_ensure_current)} || return 1
  configFile=${3:-$(repo_zouflow_path)} || return 1
  local rePath=$(regex_escape "$path")
  git config --file "$configFile" --get-all "sku.$branch.exclude" "$rePath" >/dev/null
}
config_sku_list_excluded()
{
  local branch configFile
  branch=${1:-$(branch_ensure_current)} || return 1
  configFile=${2:-$(repo_zouflow_path)} || return 1
  git config --file "$configFile" --get-all "sku.$branch.exclude"
}
config_sku_list_included()
{
  local branch configFile
  branch=${1:-$(branch_ensure_current)} || return 1
  configFile=${2:-$(repo_zouflow_path)} || return 1
  local sku=( $(repo_list_submodules) )
  local excluded=( $(config_sku_list_excluded "$@") )
  array_remove_array sku[@] excluded[@]
}
config_sku_status()
{
  local branch configFile
  branch=${1:-$(branch_ensure_current)} || return 1
  configFile=${2:-$(repo_zouflow_path)} || return 1
  io_message "'$branch'" "SKU"
  for path in $(config_sku_list_included "$@" | sort); do
    io_message "   $path" ''
  done
  for path in $(config_sku_list_excluded "$@" | sort); do
    io_message " x $path" ''
  done
}
