<?xml version="1.0" encoding="utf-8"?>
<!-- The ImportProject.targets can be used to build and import the output of one or many projects or solutions. -->
<Project ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- Define imported projects default metadata -->
  <ItemDefinitionGroup>
    <ImportProject>
      <BuildInParallel>true</BuildInParallel>
      <Configuration>$(Configuration)</Configuration>
      <Targets>Build</Targets>
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <!-- Propagate the options specified on the command line -->
      <WorkDir         Condition="'$(ForwardWorkDir)'         != ''">$(ForwardWorkDir)</WorkDir>
      <PkgDir          Condition="'$(ForwardPkgDir)'          != ''">$(ForwardPkgDir)</PkgDir>
      <DbgDir          Condition="'$(ForwardDbgDir)'          != ''">$(ForwardDbgDir)</DbgDir>
      <OutDir          Condition="'$(ForwardOutDir)'          != ''">$(ForwardOutDir)</OutDir>
      <Platform        Condition="'$(ForwardPlatform)'        != ''">$(ForwardPlatform)</Platform>
      <PlatformToolset Condition="'$(ForwardPlatformToolset)' != ''">$(ForwardPlatformToolset)</PlatformToolset>
    </ImportProject>
  </ItemDefinitionGroup>

  <!-- Preprocess build options and add a 'Properties' metadata -->
  <Target Name="AddBuildOptions">
    <AddBuildOptions Projects="@(ImportProject)">
      <Output ItemName="ProjectsToBuild" TaskParameter="ProjectsOutput" />
    </AddBuildOptions>
  </Target>

  <!-- ================ ImportProjectClean ================ -->

  <!-- Target batching -->
  <Target Name="ImportProjectClean"
          DependsOnTargets="AddBuildOptions"
          Returns="%(ProjectsToBuild.Identity)">
    <!-- The clean target does not care about project dependencies. This means that we can safely use the MSBuild task for solutions too. -->
    <MSBuild Projects="@(ProjectsToBuild)" Targets="Clean" Properties="%(Properties)" BuildInParallel="%(BuildInParallel)" />
  </Target>

  <!-- ================ ImportProject ================ -->

  <!-- Target batching -->
  <Target Name="ImportProject"
          Condition="'@(ImportProject)' != ''"
          DependsOnTargets="AddBuildOptions"
          Returns="%(ProjectsToBuild.Identity)">

    <!--<LogItems Items="@(ProjectsToBuild)" Title="ProjectsToBuild" />
    <Message Text=" " />-->
    
    <!-- Restore nuget packages for solution... -->
    <Exec Condition="'%(ProjectsToBuild.Extension)' == '.sln'"
          Command='"$(ZouBinDir)nuget" restore "%(ProjectsToBuild.Identity)"'/>
    
    <!-- ...or project with solution. -->
    <Exec Condition="'%(ProjectsToBuild.Extension)' != '.sln' And ('$(SolutionDir)' != '*Undefined*' And '$(SolutionDir)' != '') And Exists('%(RootDir)%(Directory)packages.config')"
          Command='"$(ZouBinDir)nuget" restore "%(ProjectsToBuild.RootDir)%(Directory)packages.config" -PackagesDirectory "$(NugetPackagesDir)."'/>

    <!--
	  The MSBuild task does not determine the build order but MSBuild.exe and Visual Studio do:
    https://maximelabelle.wordpress.com/2011/11/29/building-multiple-projects-in-order-with-msbuild/
    We cannot use the following MSBuild task:
        <MSBuild Projects="%(ProjectsToBuild.Identity)" Targets="Build" Properties="OutDir=%(OutDir);Configuration=%(Configuration);Platform=%(Platform) " />
    Instead with use the Exec task which starts the MSBuild process.
	  -->

    <!-- Build solution... -->
    <Exec Condition="'%(ProjectsToBuild.Extension)' == '.sln'"
          Command='"$(MSBuildToolsPath)\msbuild" /nologo /v:m /m "/t:%(Targets)" "/p:%(ProjectsToBuild.Properties)" "%(ProjectsToBuild.Identity)"' />

    <!-- ...or project. -->
    <MSBuild Condition="'%(ProjectsToBuild.Extension)' != '.sln'"
             Projects="%(ProjectsToBuild.Identity)" Targets="%(Targets)" Properties="%(ProjectsToBuild.Properties)" BuildInParallel="%(BuildInParallel)" />

    <CallTarget Targets="_DeleteLastBuildState" />
  </Target>

  </Project>